--- Makefile.orig	Thu Nov 10 09:57:12 2005
+++ Makefile	Mon May 29 16:46:29 2006
@@ -9,9 +9,9 @@
 #
 
 BASEVERSION=1.09
-VERSION=$(BASEVERSION)$(GLIBC)
+VERSION=$(BASEVERSION)
 
-BUILD_SDL=YES   # Tremor sdl glx executable (uses SDL for cdrom and sound)
+#BUILD_SDL=YES   # Tremor sdl glx executable (uses SDL for cdrom and sound)
 
 ifneq (,$(findstring libc6,$(shell if [ -e /lib/libc.so.6 ];then echo libc6;fi)))
 GLIBC=-glibc
@@ -19,45 +19,49 @@
 GLIBC=
 endif
 
-ifneq (,$(findstring alpha,$(shell uname -m)))
-ARCH=axp
-else
-ARCH=i386
-endif
+ARCH=$(shell uname -m)
 NOARCH=noarch
 
 MOUNT_DIR=./src
 
-BUILD_DEBUG_DIR=debug$(ARCH)$(GLIBC)
-BUILD_RELEASE_DIR=release$(ARCH)$(GLIBC)
+BUILD_DEBUG_DIR=debug
+BUILD_RELEASE_DIR=release
 
-CC=gcc
+CC?=gcc
 
-BASE_CFLAGS=-Dstricmp=strcasecmp -Did386 -funsigned-char #-Wall
+BASE_CFLAGS=$(CFLAGS) -I$(LOCALBASE)/include -DDATADIR='"$(Q1DIR)"' -Dstricmp=strcasecmp -funsigned-char
+
+RELEASE_CFLAGS=$(BASE_CFLAGS)
+
+ifeq ($(strip $(USE_OPTIMIZED_CFLAGS)),YES)
+RELEASE_CFLAGS+=-O2 -ffast-math -funroll-loops \
+	-fomit-frame-pointer -fexpensive-optimizations -fno-strict-aliasing
+endif
 
-RELEASE_CFLAGS=$(BASE_CFLAGS) -march=i686 -O2 -ffast-math -funroll-loops \
-	-fomit-frame-pointer -fexpensive-optimizations -fno-strict-aliasing -pipe
-	
 DEBUG_CFLAGS=$(BASE_CFLAGS) -g
 
+LDFLAGS+=-L$(LOCALBASE)/lib -lm
 
-LDFLAGS=-lm -ldl
+ifeq ($(ARCH),i386)
+USE_X86_ASM 	?= YES
+else
+USE_X86_ASM 	= NO
+endif
 
-ifeq ($(strip $(BUILD_SDL)),YES)
- LDFLAGS += \
-    -lSDL
- BASE_CFLAGS += \
-    -D_SDL_FIX -D_SDL_BIN
+ifeq ($(strip $(USE_X86_ASM)),YES)
+BASE_CFLAGS+=-Did386
 endif
 
 
 ifeq ($(strip $(BUILD_SDL)),YES)
-SDLCFLAGS=$(shell sdl-config --cflags)
-SDLLDFLAGS=$(shell sdl-config --libs)
+ BASE_CFLAGS += \
+    -D_SDL_FIX -D_SDL_BIN
+ SDLCFLAGS=$(shell $(SDL_CONFIG) --cflags)
+ SDLLDFLAGS=$(shell $(SDL_CONFIG) --libs)
 endif
 
-GLLDFLAGS=-L/usr/X11R6/lib -L/usr/lib -L/usr/local/lib -lGL -lGLU -lX11 -lXext -ldl -lXxf86dga -lXxf86vm -lm -lpng -lz -ljpeg
-GLCFLAGS= -I/usr/include -I/usr/X11R6/include
+GLLDFLAGS=-L$(X11BASE)/lib -lGL -lGLU -lX11 -lXext -lXxf86dga -lXxf86vm -lpng -lz -ljpeg
+GLCFLAGS=-I$(X11BASE)/include
 
 DO_CC=$(CC) $(CFLAGS) -o $@ -c $<
 DO_DEBUG_CC=$(CC) $(DEBUG_CFLAGS) -o $@ -c $<
@@ -73,10 +77,10 @@
 # SETUP AND BUILD
 #############################################################################
 
-TARGETS=$(BUILDDIR)/tremor.glx
+TARGETS=$(BUILDDIR)/tremor
 
 ifeq ($(strip $(BUILD_SDL)),YES)
- TARGETS +=$(BUILDDIR)/tremor-sdl.glx
+ TARGETS += $(BUILDDIR)/tremor-sdl
 endif
 
 all:
@@ -166,11 +170,14 @@
    $(BUILDDIR)/glquake/sys_linux.o \
    $(BUILDDIR)/glquake/snd_dma.o \
    $(BUILDDIR)/glquake/snd_mem.o \
-   $(BUILDDIR)/glquake/snd_mix.o \
-   \
+   $(BUILDDIR)/glquake/snd_mix.o
+
+ifeq ($(strip $(USE_X86_ASM)),YES)
+GLQUAKE_OBJS+= \
    $(BUILDDIR)/glquake/math.o \
    $(BUILDDIR)/glquake/snd_mixa.o \
    $(BUILDDIR)/glquake/sys_x86.o
+endif
 
 GLQUAKE_LNX_OBJS = \
    $(BUILDDIR)/glquake/cd_linux.o \
@@ -183,10 +190,10 @@
 GLX_OBJS=$(BUILDDIR)/glquake/vid_glx.o \
 	$(BUILDDIR)/glquake/vid_common_gl.o
 
-$(BUILDDIR)/tremor.glx : $(GLQUAKE_OBJS) $(GLQUAKE_LNX_OBJS) $(GLX_OBJS)
+$(BUILDDIR)/tremor : $(GLQUAKE_OBJS) $(GLQUAKE_LNX_OBJS) $(GLX_OBJS)
 	$(CC) $(CFLAGS) -o $@ $(GLQUAKE_OBJS) $(GLQUAKE_LNX_OBJS) $(GLX_OBJS) $(GLLDFLAGS) $(LDFLAGS)
 	
-$(BUILDDIR)/tremor-sdl.glx : $(GLQUAKE_OBJS) $(GLQUAKE_SDL_OBJS) $(GLX_OBJS)
+$(BUILDDIR)/tremor-sdl : $(GLQUAKE_OBJS) $(GLQUAKE_SDL_OBJS) $(GLX_OBJS)
 	$(CC) $(CFLAGS) -o $@ $(GLQUAKE_OBJS) $(GLQUAKE_SDL_OBJS) $(GLX_OBJS) $(GLLDFLAGS) $(LDFLAGS) $(SDLLDFLAGS)
 
 $(BUILDDIR)/glquake/cl_demo.o :      $(MOUNT_DIR)/cl_demo.c
@@ -395,4 +402,4 @@
 		$(GLX_OBJS) \
 		$(GLQUAKE_LNX_OBJS) \
 		$(GLQUAKE_SDL_OBJS)
-		
\ No newline at end of file
+		
