# Created by: Veniamin Gvozdikov <vg@FreeBSD.org>
# $FreeBSD$

PORTNAME=	tarantool
PORTVERSION=	1.5.3
PORTREVISION=	1
CATEGORIES=	databases
MASTER_SITES=	http://tarantool.org/dist/
DISTNAME=	${PORTNAME}-${PORTVERSION}-${TR_REV}-src

MAINTAINER=	vg@FreeBSD.org
COMMENT=	High performance key/value storage server

LICENSE=	BSD2CLAUSE

TR_REV=		102-g2857a4e
MAKE_JOBS_UNSAFE=yes
USES=		cmake compiler:c++11-lang gettext gmake iconv perl5 readline
USE_LDCONFIG=	yes
USE_RC_SUBR=	${PORTNAME}
SUB_FILES=	pkg-message
CMAKE_ARGS=	-DCMAKE_INSTALL_MANDIR=man \
		-DCMAKE_INSTALL_SYSCONFDIR=${ETCDIR} \
		-DCMAKE_LOCALSTATE_DIR=${DATADIR}

OPTIONS_DEFINE=	CLIENT DEBUG
OPTIONS_GROUP=	PLUGINS
OPTIONS_GROUP_PLUGINS=	MYSQL PGSQL
PLUGINS_DESC=	Plugins list
CLIENT_DESC=	Enable client
DEBUG_DESC=	Enable debug
MYSQL_DESC=	Install MySQL plugin
PGSQL_DESC=	Install PostgreSQL plugin

OPTIONS_DEFAULT=CLIENT MYSQL

.include <bsd.port.options.mk>

.if ${PORT_OPTIONS:MCLIENT}
CMAKE_ARGS+=	-DENABLE_CLIENT=true
PLIST_SUB+=	CLIENT=""
.else
PLIST_SUB+=	CLIENT="@comment "
.endif

.if ${PORT_OPTIONS:MDEBUG}
CMAKE_BUILD_TYPE=	RelWithDebugInfo
CMAKE_ARGS+=	-DENABLE_BACKTRACE=ON
.else
CMAKE_BUILD_TYPE=	Rel
CMAKE_ARGS+=	-DENABLE_BACKTRACE=OFF
.endif

.if ${PORT_OPTIONS:MMYSQL}
CMAKE_ARGS+=	-DWITH_MYSQL=ON
PLIST_SUB+=	MYSQL=""
USE_MYSQL=	yes
.else
CMAKE_ARGS+=	-DWITH_MYSQL=OFF
PLIST_SUB+=	MYSQL="@comment "
.endif

.if ${PORT_OPTIONS:MPGSQL}
CMAKE_ARGS+=	-DWITH_POSTGRESQL=ON
PLIST_SUB+=	PGSQL=""
USES+=		pgsql
.else
CMAKE_ARGS+=	-DWITH_POSTGRESQL=OFF
PLIST_SUB+=	PGSQL="@comment "
.endif

.if ${PORT_OPTIONS:MMYSQL} || ${PORT_OPTIONS:MPGSQL}
PLIST_SUB+=	PLUGINS=""
.else
PLIST_SUB+=	PLUGINS="@comment "
.endif

.if ${OSVERSION} < 900000
BROKEN=		Does not build on FreeBSD < 9.0
.endif

.include <bsd.port.mk>
