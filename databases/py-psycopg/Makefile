# Created by: Alex Rodioukov <simuran@shaw.ca>
# $FreeBSD$

PORTNAME=	psycopg
PORTVERSION=	1.1.21
PORTREVISION=	1
CATEGORIES=	databases python
MASTER_SITES=	http://initd.org/psycopg/tarballs/PSYCOPG-1-1/
PKGNAMEPREFIX=	${PYTHON_PKGNAMEPREFIX}
DISTNAME=	psycopg-${PORTVERSION}

MAINTAINER=	ports@FreeBSD.org
COMMENT=	High performance Python adapter for PostgreSQL

RUN_DEPENDS=	${DATETIME_DEP}:${PORTSDIR}/lang/py-mx-base
BUILD_DEPENDS=	${DATETIME_DEP}:${PORTSDIR}/lang/py-mx-base

USE_PGSQL=	yes
USES=		gmake
USE_PYTHON=	yes
GNU_CONFIGURE=	yes

ALL_TARGET=	sharedmods

CONFIGURE_ARGS=	--with-python=${PYTHON_CMD} \
		--with-python-version=${PYTHON_VERSION:S/python//} \
		--with-postgres-libraries=${LOCALBASE}/lib \
		--with-postgres-includes=${LOCALBASE}/include \
		--with-mxdatetime-includes=${DATETIME_INC}

.if defined(WITH_ZOPE)
USES+=		zope
PLIST_SUB+=	ZOPE=""
.else
PLIST_SUB+=	ZOPE="@comment "
.endif

DATETIME_DEP=	${PYTHON_SITELIBDIR}/mx/DateTime/__init__.py
DATETIME_INC=	${PYTHON_SITELIBDIR}/mx/DateTime/mxDateTime/

DOCSDIR=	${PREFIX}/share/doc/py-psycopg
EXAMPLESDIR=	${PREFIX}/share/examples/py-psycopg

EXAMPLES=	binary.py bool.py bounded.py commit.py copy_from.py \
		copy_from2.py copy_to.py dictfetch.py dt.py first.py \
		integrity.py interval.py notify.py oid.py somehackers.jpg \
		threads.py usercast.py whereareyou.jpg work.py

DOCS=		AUTHORS COPYING CREDITS ChangeLog FAQ INSTALL NEWS \
		README RELEASE-1.0 SUCCESS TODO

pre-everything::
.if !defined(WITH_ZOPE)
	@${ECHO} ""
	@${ECHO} "* To build with Zope support please specify WITH_ZOPE=YES"
	@${ECHO} ""
.endif

.if defined(WITH_ZOPE)
post-build:
	${PYTHON_CMD} ${PYTHON_LIBDIR}/compileall.py ${WRKSRC}/ZPsycopgDA
.endif

do-install:
	@${MKDIR} ${STAGEDIR}${PYTHON_SITELIBDIR}
	${INSTALL_PROGRAM} ${WRKSRC}/psycopgmodule.so \
		${STAGEDIR}${PYTHON_SITELIBDIR}
.if defined(WITH_ZOPE)
	${MKDIR} ${STAGEDIR}${ZOPEBASEDIR}/${ZOPEPRODUCTDIR}/ZPsycopgDA
	${CP} -R ${WRKSRC}/ZPsycopgDA ${STAGEDIR}${ZOPEBASEDIR}/${ZOPEPRODUCTDIR}/
.endif

post-install:
.if !defined(NOPORTDOCS)
	@${MKDIR} ${STAGEDIR}${EXAMPLESDIR}
.for f in ${EXAMPLES}
	@${INSTALL_DATA} ${WRKSRC}/doc/examples/${f} ${STAGEDIR}${EXAMPLESDIR}
.endfor
	@${MKDIR} ${STAGEDIR}${DOCSDIR}
.for f in ${DOCS}
	@${INSTALL_MAN} ${WRKSRC}/${f} ${STAGEDIR}${DOCSDIR}
.endfor
.endif
.if !defined(BATCH) && defined(WITH_ZOPE)
	@${ECHO} ""
	@${ECHO} "To complete the installation of ZPsycopgDA:"
	@${ECHO} ""
	@${ECHO} "    - Restart Zope. This may be done from the Zope Control Panel."
	@${ECHO} ""
	@${ECHO} "    - Verify that the ZPsycopgDA product is loaded properly by"
	@${ECHO} "      examining them in Control_Panel/Products."
	@${ECHO} ""
.endif

.include <bsd.port.mk>
