--- portmaster.orig	2017-12-14 17:26:55.000000000 +0100
+++ portmaster	2017-12-16 15:01:06.221836000 +0100
@@ -1039,7 +1039,7 @@
 				return 0
 			else
 				reason=${moved##*|}
-				[ "$3" != 'nonfatal' ] &&
+				[ "$flag" != 'nonfatal' ] &&
 					fail "The $sf port has been deleted: $reason"
 			fi ;;
 		${sf}\|*) moved_npd=${moved#*\|}	# New port directory
@@ -1449,6 +1449,24 @@
 	fi
 }
 
+find_new_port () {
+	# Global: new_port
+	local portdir flavor flavor_option
+
+	[ -n "$new_port" ] && return
+
+	portdir=$(dir_part "$1")
+	flavor=$(flavor_part "$1")
+	flavor_option=${flavor:+FLAVOR=$flavor}
+#	export_flavor $flavor
+	if pm_cd_pd $portdir; then
+		new_port=`pm_make -V PKGNAME ${flavor_option}`
+	else
+		new_port=`parse_index $portdir name` ||
+			fail "No entry for $portdir in $PM_INDEX"
+	fi
+}
+
 check_for_updates () {
 	# Global: num_updates
 	local nf iport originflavor flavor origin port_ver do_update skip
@@ -2148,24 +2166,6 @@
 	PM_NEEDS_UPDATE="${PM_NEEDS_UPDATE}${1} "
 }
 
-find_new_port () {
-	# Global: new_port
-	local portdir flavor flavor_option
-
-	[ -n "$new_port" ] && return
-
-	portdir=$(dir_part "$1")
-	flavor=$(flavor_part "$1")
-	flavor_option=${flavor:+FLAVOR=$flavor}
-#	export_flavor $flavor
-	if pm_cd_pd $portdir; then
-		new_port=`pm_make -V PKGNAME ${flavor_option}`
-	else
-		new_port=`parse_index $portdir name` ||
-			fail "No entry for $portdir in $PM_INDEX"
-	fi
-}
-
 update_build_l () {
 	local originflavor origin flavor iport
 
@@ -2281,7 +2281,7 @@
 	for dep_type in $*; do
 		case $dep_type in
 		build-depends-list)
-			var_opt="$var_opt -V BUILD_DEPENDS" ;;
+			var_opt="$var_opt -V BUILD_DEPENDS -V LIB_DEPENDS" ;;
 		run-depends-list)
 			var_opt="$var_opt -V RUN_DEPENDS" ;;
 		*)
@@ -2797,7 +2797,8 @@
 				numports=$(( $numports - 1 ))
 				continue
 			fi
-			origin=`origin_from_pdb $port` ;;
+			origin=$(origin_from_pdb $port)
+			find_moved_port $origin $port nonfatal && origin=${moved_npd:-$origin} ;;
 		esac
 
 		case "$PM_NEEDS_UPDATE" in
@@ -3033,7 +3034,7 @@
 			*)	echo '' ; no_valid_port ;;
 			esac
 		done ;;
-	*)	upg_port=$(pkg query %n-%v $argv) ;;
+	*)	upg_port=$(pkg query %n-%v "$argv") ;;
 	esac
 
 	if [ -z "$portdir" -a -z "$upg_port" ]; then
@@ -3129,7 +3130,7 @@
 	dir=$(dir_part $1)
 	flavor=$(flavor_part $1)
 	pkgname=$(make -C "$pd/$dir" -V PKGNAME FLAVOR=$flavor) || return 1
-	pkg info -x ${pkgname%-*}'-[^-]*'
+	pkg info -x "^${pkgname%-*}"'-[^-]*' 2>/dev/null
 }
 
 if [ -z "$upg_port" -a -z "$REPLACE_ORIGIN" ]; then
@@ -3594,6 +3595,7 @@
 	fi
 
 	pm_cd_pd $portdir
+	export_flavor $(flavor_part $portdir)
 	[ -z "$DONT_PRE_CLEAN" ] && { pm_make clean NOCLEANDEPENDS=ncd ||
 		fail 'make clean failed'; }
 
