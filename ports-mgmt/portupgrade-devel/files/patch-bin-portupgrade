--- bin/portupgrade.orig	2008-01-31 19:14:25.000000000 +0300
+++ bin/portupgrade	2008-01-31 19:14:32.000000000 +0300
@@ -620,11 +620,20 @@
 	      origin = $pkgdb.origin(task)
 	      if !origin.nil?
 		begin
+		  if config_held?(task)
+		    STDERR.puts "#{task} is in HOLD_PKG. Ignored."
+		    $results << PkgResult.new(origin, :ignored, "is in HOLD_PKG")
+		    not_need_upgrade << task
+		    next
+		  end
+
 		  name = get_pkgname(origin)
 		rescue IgnoreMarkError => e
 		  $results << PkgResult.new(origin, :ignored, e.message)
 		  not_need_upgrade << task
 		  next
+		rescue PortDirError => e
+		  #STDERR.puts "No port dir for #{task}"
 		end
 		name =~ /^(.+)-([^-]+)$/
 		newversion = PkgVersion.new($2)
@@ -640,6 +649,9 @@
 		  upgrade_tasks |= depends
 		end
 		install_tasks |= get_notinstalled_depends(origin)
+	      else
+		# There is no origin for some reason
+		not_need_upgrade << task
 	      end
 	    end
 	    upgrade_tasks -= not_need_upgrade
