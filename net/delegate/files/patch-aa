--- src/lock.c.orig	Mon Mar 15 19:24:15 1999
+++ src/lock.c	Sun Apr 18 15:26:15 1999
@@ -136,6 +136,22 @@
 			break;
 		}
 
+#ifdef EWOULDBLOCK
+		/*
+		 * Only retry the lock if it was busy.  Other
+		 * possible sources for the lock to fail are:
+		 * invalid argument, bad filedescriptor, and
+		 * operation not supported by device.  The latter
+		 * happens if you start DeleGateD with -v, so it
+		 * logs to stderr (which usually doesn't support
+		 * locking at all).
+		 */
+		if (rcode == -1 && errno != EWOULDBLOCK) {
+			/* pretend lock succeeded */
+			rcode = 0;
+			break;
+		}
+#endif
 		remain = timeout - elapsed;
 		if( remain <= 0 )
 			break;
@@ -146,6 +162,13 @@
 
 			start = Time();
 			rcode = callFuncTimeout(remain/1000,-1,func,fd);
+#ifdef EWOULDBLOCK
+			if (rcode == -1 && errno != EWOULDBLOCK) {
+				/* pretend lock succeeded */
+				rcode = 0;
+				break;
+			}
+#endif
 			elapse1 = (Time() - start) * 1000; 
 /*{
 static int n;
