--- relayd/hce.c.orig	Mon Jun  6 18:02:45 2011
+++ relayd/hce.c	Mon Jun  6 18:09:07 2011
@@ -207,10 +207,27 @@
 	struct timeval		 tv_now, tv_dur;
 	u_long			 duration;
 	u_int			 logopt;
-	struct host		*h;
+	struct host		*h, *hostupd;
 	int			 hostup;
 	const char		*msg;
 
+	if ((hostupd = host_find(env, host->conf.id)) == NULL)
+		fatalx("hce_notify_done: desynchronized");
+
+	if ((table = table_find(env, host->conf.tableid)) == NULL)
+		fatalx("hce_notify_done: invalid table id");
+
+	if (hostupd->flags & F_DISABLE) {
+		if (env->sc_opts & RELAYD_OPT_LOGUPDATE) {
+			log_info("host %s, check %s%s (ignoring result, "
+			    "host disabled)",
+			    host->conf.name, table_check(table->conf.check),
+			    (table->conf.flags & F_SSL) ? " use ssl" : "");
+		}
+		host->flags |= (F_CHECK_SENT|F_CHECK_DONE);
+		return;
+	}
+
 	hostup = host->up;
 	host->he = he;
 
@@ -250,9 +267,6 @@
 		duration = (tv_dur.tv_sec * 1000) + (tv_dur.tv_usec / 1000.0);
 	else
 		duration = 0;
-
-	if ((table = table_find(env, host->conf.tableid)) == NULL)
-		fatalx("hce_notify_done: invalid table id");
 
 	if (env->sc_opts & logopt) {
 		log_info("host %s, check %s%s (%lums), state %s -> %s, "
