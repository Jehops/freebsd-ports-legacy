--- configure.in.orig	2009-09-30 07:21:56.000000000 -0500
+++ configure.in	2010-09-24 16:38:20.000000000 -0500
@@ -875,3 +875,8 @@
 AC_CHECK_HEADERS(sys/un.h)
-AC_CHECK_HEADERS(sys/mount.h sys/vfs.h sys/fs/s5param.h sys/filsys.h termios.h termio.h)
+AC_CHECK_HEADERS(sys/mount.h, [], [],
+[[#ifdef HAVE_SYS_PARAM_H
+#include <sys/param.h>
+#endif
+]])
+AC_CHECK_HEADERS(sys/vfs.h sys/fs/s5param.h sys/filsys.h termios.h termio.h)
 AC_CHECK_HEADERS(sys/termio.h sys/statfs.h sys/dustat.h sys/statvfs.h stdarg.h sys/sockio.h)
@@ -1057,2 +1062,17 @@
 
+AC_CACHE_CHECK([for struct sigevent type],samba_cv_struct_sigevent, [
+    AC_TRY_COMPILE([
+#include <sys/types.h>
+#if STDC_HEADERS
+#include <stdlib.h>
+#include <stddef.h>
+#endif
+#include <signal.h>],[struct sigevent s;],
+	samba_cv_struct_sigevent=yes,samba_cv_struct_sigevent=no)])
+if test x"$samba_cv_struct_sigevent" = x"yes"; then
+   AC_DEFINE(HAVE_STRUCT_SIGEVENT,1,[Whether we have the struct sigevent])
+   AC_CHECK_MEMBERS([struct sigevent.sigev_value.sival_ptr,struct sigevent.sigev_value.sigval_ptr], , ,
+	[#include <signal.h>])
+fi
+
 AC_CACHE_CHECK([for struct timespec type],samba_cv_struct_timespec, [
@@ -1260,2 +1280,3 @@
 AC_CHECK_HEADERS(execinfo.h libexc.h libunwind.h)
+AC_SEARCH_LIBS(backtrace_symbols, [execinfo])
 AC_CHECK_FUNCS(backtrace_symbols)
@@ -4100,6 +4121,6 @@
   # first test for Active Directory support being enabled
-  #if test x"$with_ads_support" = x"no"; then
-  #		AC_MSG_ERROR(Active Directory support is required to enable DNS Update support)
-  #		with_dnsupdate_support=no
-  #fi	  	
+  if test x"$with_ads_support" = x"no"; then
+  		AC_MSG_ERROR(Active Directory support is required to enable DNS Update support)
+  		with_dnsupdate_support=no
+  fi	  	
   ##################################################################
@@ -5228,3 +5249,3 @@
 
-AC_MSG_CHECKING(whether to support ACLs)
+AC_MSG_NOTICE(checking whether to support ACLs...)
 AC_ARG_WITH(acl-support,
@@ -5236,3 +5257,3 @@
 	*sysv5*)
-		AC_MSG_RESULT(Using UnixWare ACLs)
+		AC_MSG_NOTICE(Using UnixWare ACLs)
 		AC_DEFINE(HAVE_UNIXWARE_ACLS,1,[Whether UnixWare ACLs are available])
@@ -5241,4 +5262,4 @@
 	*solaris*)
-		AC_MSG_RESULT(Using solaris ACLs)
-		AC_DEFINE(HAVE_SOLARIS_ACLS,1,[Whether solaris ACLs are available])
+		AC_MSG_NOTICE(Using Solaris ACLs)
+		AC_DEFINE(HAVE_SOLARIS_ACLS,1,[Whether Solaris ACLs are available])
 		ACL_LIBS="$ACL_LIBS -lsec"
@@ -5247,3 +5268,3 @@
 	*hpux*)
-		AC_MSG_RESULT(Using HPUX ACLs)
+		AC_MSG_NOTICE(Using HPUX ACLs)
 		AC_DEFINE(HAVE_HPUX_ACLS,1,[Whether HPUX ACLs are available])
@@ -5252,3 +5273,3 @@
 	*irix*)
-		AC_MSG_RESULT(Using IRIX ACLs)
+		AC_MSG_NOTICE(Using IRIX ACLs)
 		AC_DEFINE(HAVE_IRIX_ACLS,1,[Whether IRIX ACLs are available])
@@ -5257,3 +5278,3 @@
 	*aix*)
-		AC_MSG_RESULT(Using AIX ACLs)
+		AC_MSG_NOTICE(Using AIX ACLs)
 		AC_DEFINE(HAVE_AIX_ACLS,1,[Whether AIX ACLs are available])
@@ -5262,3 +5283,3 @@
 	*osf*)
-		AC_MSG_RESULT(Using Tru64 ACLs)
+		AC_MSG_NOTICE(Using Tru64 ACLs)
 		AC_DEFINE(HAVE_TRU64_ACLS,1,[Whether Tru64 ACLs are available])
@@ -5267,8 +5288,2 @@
 		;;
-	*freebsd[[5-9]]*)
-		AC_MSG_RESULT(Using FreeBSD posix ACLs)
-		AC_DEFINE(HAVE_POSIX_ACLS,1,[Whether FreeBSD POSIX ACLs are available])
-		AC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])
-		default_static_modules="$default_static_modules vfs_posixacl"
-		;;
 	*linux*)
@@ -5293,3 +5308,3 @@
 		if test x"$samba_cv_HAVE_POSIX_ACLS" = x"yes"; then
-			AC_MSG_RESULT(Using posix ACLs)
+			AC_MSG_NOTICE(Using posix ACLs)
 			AC_DEFINE(HAVE_POSIX_ACLS,1,[Whether POSIX ACLs are available])
@@ -5314,8 +5329,14 @@
 		fi
-            ;;
+		;;
          *)
-		AC_CHECK_LIB(acl,acl_get_file,[ACL_LIBS="$ACL_LIBS -lacl"])
-		AC_CACHE_CHECK([for ACL support],samba_cv_HAVE_POSIX_ACLS,[
+		AC_CHECK_LIB(acl,acl_get_file,[
+		    ACL_LIBS="$ACL_LIBS -lacl"
+		    samba_cv_acl_get_file=yes
+		],[
+		    AC_CHECK_FUNC(acl_get_file,[samba_cv_acl_get_file=yes])
+		])
+		if test x"$samba_cv_acl_get_file" = x"yes"; then
+		    AC_CACHE_CHECK([for POSIX ACL support],samba_cv_HAVE_POSIX_ACLS,[
 			acl_LIBS=$LIBS
-			LIBS="$LIBS -lacl"
+			LIBS="$LIBS $ACL_LIBS"
 			AC_TRY_LINK([
@@ -5332,5 +5353,5 @@
 			LIBS=$acl_LIBS
-		])
-		if test x"$samba_cv_HAVE_POSIX_ACLS" = x"yes"; then
-			AC_MSG_RESULT(Using posix ACLs)
+		    ])
+		    if test x"$samba_cv_HAVE_POSIX_ACLS" = x"yes"; then
+			AC_MSG_NOTICE(Using POSIX ACLs)
 			AC_DEFINE(HAVE_POSIX_ACLS,1,[Whether POSIX ACLs are available])
@@ -5338,3 +5359,3 @@
 				acl_LIBS=$LIBS
-				LIBS="$LIBS -lacl"
+				LIBS="$LIBS $ACL_LIBS"
 				AC_TRY_LINK([
@@ -5345,3 +5366,3 @@
 					acl_perm_t perm;
-					return acl_get_perm_np( permset_d, perm);
+					return acl_get_perm_np(permset_d, perm);
 				],
@@ -5354,2 +5375,7 @@
 			fi
+		    fi
+		fi
+		if test x"$samba_cv_HAVE_POSIX_ACLS" != x"yes"; then
+		    AC_MSG_NOTICE(No POSIX ACLs support is availble)
+		    AC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support is available])
 		fi
@@ -5359,3 +5385,3 @@
   *)
-    AC_MSG_RESULT(no)
+    AC_MSG_NOTICE(No ACLs support is availble)
     AC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support is available])
@@ -5363,4 +5389,4 @@
   esac ],
+  AC_MSG_NOTICE(No ACLs support is built in)
   AC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support should be built in])
-  AC_MSG_RESULT(no)
 )
@@ -5838,2 +5864,3 @@
 		    nsswitch/winbind_nss_linux.o"
+		WINBIND_WINS_NSS_EXTRA_OBJS="nsswitch/wins_freebsd.o nsswitch/wins.o"
 		WINBIND_NSS="nsswitch/nss_winbind.$SHLIBEXT"
@@ -5895,2 +5922,4 @@
 AC_SUBST(WINBIND_NSS_EXTRA_LIBS)
+AC_SUBST(WINBIND_WINS_NSS_EXTRA_OBJS)
+AC_SUBST(WINBIND_WINS_NSS_EXTRA_LIBS)
 AC_SUBST(NSSSONAMEVERSIONSUFFIX)
@@ -6197,2 +6226,3 @@
 SMB_MODULE(vfs_tru64acl, \$(VFS_TRU64ACL_OBJ), "bin/tru64acl.$SHLIBEXT", VFS)
+SMB_MODULE(vfs_zfsacl, \$(VFS_ZFSACL_OBJ), "bin/zfsacl.$SHLIBEXT", VFS)
 SMB_MODULE(vfs_catia, \$(VFS_CATIA_OBJ), "bin/catia.$SHLIBEXT", VFS)
