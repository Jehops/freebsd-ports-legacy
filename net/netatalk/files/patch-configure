--- configure.orig	2011-07-27 07:59:28.000000000 -0400
+++ configure	2011-08-01 03:26:25.000000000 -0400
@@ -27039,6 +27039,7 @@ fi
 
         savedcflags="$CFLAGS"
         savedldflags="$LDFLAGS"
+        saved_CPPFLAGS="$CPPFLAGS"
 	ICONV_CFLAGS=""
 	ICONV_LIBS=""
 
@@ -28265,6 +28266,8 @@ echo "$as_me: error: internal error, ata
 	if test "x$zeroconf" != "xno"; then
 		savedcppflags="$CPPFLAGS"
 		savedldflags="$LDFLAGS"
+		CPPFLAGS="-I%%LOCALBASE%%/include $CPPFLAGS"
+		LDFLAGS="-L%%LOCALBASE%%/lib $LDFLAGS"
 
 		if test "x$zeroconf" = "xyes" -o "x$zeroconf" = "xtry"; then
 			zeroconf_dir="/usr"
@@ -31357,7 +31360,7 @@ if test "x$bdb_required" = "xyes"; then
     trybdbdir=""
     dobdbsearch=yes
     bdb_search_dirs="/usr/local /usr"
-    search_subdirs="/ /db5 /db5.1 /db51 /db5.0 /db50 /db4.8 /db48 /db4.7 /db47 /db4.6 /db46 /db4"
+    search_subdirs="/%%DB_NAME%% / /db5 /db5.1 /db51 /db5.0 /db50 /db4.8 /db48 /db4.7 /db47 /db4.6 /db46 /db4"
 
     bdbfound=no
     savedcflags="$CFLAGS"
@@ -33387,7 +33390,7 @@ rm -f core conftest.err conftest.$ac_obj
 fi
 { echo "$as_me:$LINENO: result: $netatalk_cv_HAVE_ACL_GET_PERM_NP" >&5
 echo "${ECHO_T}$netatalk_cv_HAVE_ACL_GET_PERM_NP" >&6; }
-			if test x"netatalk_cv_HAVE_ACL_GET_PERM_NP" = x"yes"; then
+			if test x"$netatalk_cv_HAVE_ACL_GET_PERM_NP" = x"yes"; then
 
 cat >>confdefs.h <<\_ACEOF
 #define HAVE_ACL_GET_PERM_NP 1
