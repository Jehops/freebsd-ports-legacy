#!/bin/sh

if [ -f ${WRKDIRPREFIX}${CURDIR}/Makefile.inc ]; then
	exit
fi

tempfile=`/usr/bin/mktemp -t checklist`

if [ "${BATCH}" ]; then
	set \"MySQL\"
else
	/usr/bin/dialog --title "GNU-Radius configuration options" --clear \
		--checklist "\n\
Please select desired options:" -1 -1 16 \
Client		"Enable build client" OFF \
DBM		    "Enable DBM support" OFF \
MySQL		"Enable MySQL support" ON \
PostgreSQL	"Enable PostgreSQL support" OFF \
SNMP	    "Enable SNMP support" ON \
Notify		"Enable TTL notification" OFF \
2> $tempfile

	retval=$?

	if [ -s $tempfile ]; then
		set `cat $tempfile`
	fi
	rm -f $tempfile

	case $retval in
		0)	if [ -z "$*" ]; then
				echo "Nothing selected"
			fi
			;;
		1)	echo "Cancel pressed."
			exit 1
			;;
	esac
fi

${MKDIR} ${WRKDIRPREFIX}${CURDIR}
exec > ${WRKDIRPREFIX}${CURDIR}/Makefile.inc

INCLUDE_PATH=${LOCALBASE}/include/
LIB_PATH=${LOCALBASE}/lib/

while [ "$1" ]; do
	case $1 in
		\"Client\")
			echo "CONFIGURE_ARGS+= --enable-client"
			export CLIENT=Yes
			export GUILE=Yes
			;;
		\"DBM\")
			echo "CONFIGURE_ARGS+= --enable-dbm=ndbm"
			;;
		\"MySQL\")
			echo "USE_MYSQL=	YES"
			echo "CONFIGURE_ARGS+= --with-mysql"
			LIB_PATH="$LIB_PATH:${LOCALBASE}/lib/mysql/"
			export MYSQL=Yes
			;;
		\"PostgreSQL\")
			echo "POSTGRESQL_PORT?=	databases/postgresql7"
			echo "LIB_DEPENDS+=	pq.3:\${PORTSDIR}/\${POSTGRESQL_PORT}"
			echo "CONFIGURE_ARGS+= --with-postgres"
			INCLUDE_PATH="$INCLUDE_PATH:${LOCALBASE}/include/pgsql/"
			export PGSQL=Yes
			;;
		\"SNMP\")
			echo "CONFIGURE_ARGS+= --enable-snmp"
			;;
		\"Notify\")
			echo "CONFIGURE_ARGS+= --enable-notify"
			;;
		*)
			echo "Invalid option(s): $*" > /dev/stderr
			rm -f ${WRKDIRPREFIX}${REALCURDIR}/Makefile.inc
			exit 1
			;;
	esac
	shift
done

echo "CONFIGURE_ARGS+= --with-include-path=\"$INCLUDE_PATH\""
echo "CONFIGURE_ARGS+= --with-lib-path=\"$LIB_PATH\""

if [ -z $GUILE ]; then
	echo "CONFIGURE_ARGS+= --without-guile"
	echo "GUILE=	\"@comment \""
else
	echo "BUILD_DEPENDS+= guile:${PORTSDIR}/lang/guile"
	echo "GUILE=	\"\""
	unset GUILE
fi

if [ -z $CLIENT ]; then
	echo "CLIENT=   \"@comment \""
else
	echo "CLIENT=   \"\""
	unset CLIENT
fi

if [ -z $MYSQL ]; then
	echo "MYSQL=    \"@comment \""
else
	echo "MYSQL=    \"\""
	unset MYSQL
fi

if [ -z $PGSQL ]; then
	echo "PGSQL=    \"@comment \""
else
	echo "PGSQL=    \"\""
	unset PGSQL
fi

echo "PLIST_SUB+=	GUILE=\${GUILE}"
echo "PLIST_SUB+=	CLIENT=\${CLIENT}"
echo "PLIST_SUB+=	PGSQL=\${PGSQL}"
echo "PLIST_SUB+=	MYSQL=\${MYSQL}"
