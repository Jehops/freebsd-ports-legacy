#!/bin/sh
rel=3.3-19990908-RC
ftpserver=current.freebsd.org
ftpdists="bin dict des games compat22"
ftp=1
useworld=0
chrootdir=/a/asami/chroot
here=$(pwd)
tmpdir=${here}/tmp
rm -rf ${tmpdir}
mkdir -p ${tmpdir}
if [ "${ftp}" != 0 ]; then
  rm -rf bindist/ftp
  mkdir -p bindist/ftp
  cd bindist/ftp
  for i in ${ftpdists}; do
    /usr/bin/ftp -a "ftp://${ftpserver}/pub/FreeBSD/snapshots/i386/${rel}/$i/$i.??"
  done
  cd ${here}
fi
cd ${tmpdir}
if [ "${useworld}" = 1 ]; then
  (cd ${chrootdir}; find -dx . | \
    grep -v -E '^./usr/(X11R6|local|obj|opt|ports|src)' | \
    grep -v '^./home' | \
    grep -v '^./var/db/pkg' | \
    cpio -dump ${tmpdir})
else
  for i in ${ftpdists}; do
    cat ${here}/bindist/ftp/$i.?? | tar --unlink -xzpf -
  done
fi
rm -rf $(cat ${here}/bindist/delete)
mkdir -p $(cat ${here}/bindist/dirlist)
(cd ${here}/bindist/files; find -dx . | cpio -dump ${tmpdir})
echo "HAVE_MOTIF=t" >> etc/make.conf
echo "MOTIF_STATIC=t" >> etc/make.conf
date '+%Y%m%d' > var/db/port.mkversion
if [ -f kernel.GENERIC -a ! -f kernel ]; then
  mv kernel.GENERIC kernel
fi
rm -f /usr/lib/aout/lib*_p.a
mkdir ${tmpdir}/var/run
chroot $(pwd) /sbin/ldconfig /usr/lib
chroot $(pwd) /sbin/ldconfig -aout /usr/lib/aout
mkdir -p ${here}/tarballs
tar cf ${here}/tarballs/bindist.tar.new .
mv -f ${here}/tarballs/bindist.tar.new ${here}/tarballs/bindist.tar
cd ${here}
rm -rf ${tmpdir}
