#!/bin/sh
if [ $# != 4 ]; then
  echo "usage: $0 master portbuilddir branch md5"
  exit 1
fi
if [ $(echo $(/sbin/mount | grep "$2/.*read-only" | awk '{print $3}' | wc -c)) != 0 ]; then
  /sbin/umount -f $(/sbin/mount | grep "$2/.*read-only" | awk '{print $3}')
fi

if ! rm -rf $2/*/chroot/* >/dev/null 2>&1; then
  chflags -R noschg $2/*/chroot/*
  rm -rf $2/*/chroot/*
fi

mkdir -p $2/scripts $2/$3/tarballs $2/$3/chroot

scp -p $1:$2/scripts/portbuild $2/scripts
md5=$(/sbin/md5 $2/$3/tarballs/bindist.tar | awk '{print $4}')
if [ "$md5" = "$4" ]; then
  echo "not copying bindist to $(hostname -s) since it is already up to date"
else
  echo "copying bindist to $(hostname -s)"
  scp -p $1:$2/$3/tarballs/bindist.tar $2/$3/tarballs
fi
