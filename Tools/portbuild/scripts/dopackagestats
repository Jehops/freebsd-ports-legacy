#!/bin/sh
# $FreeBSD#
#
# create HTML showing numbers of packages vs errors.  Run this in a directory
# accessible to the web server.
#

# alpha is obsolete
SUPPORTED_ARCHS="amd64 i386 ia64 sparc64"
ROOT_DIRECTORY=/var/portbuild

OUTFILE=packagestats.html
TMPFILE=.${OUTFILE}

echo "<html>" > ${TMPFILE}
echo "<head>" >> ${TMPFILE}
echo "<title>FreeBSD package building statistics</title>" >> ${TMPFILE}
echo "</head>" >> ${TMPFILE}

echo "<body>" >> ${TMPFILE}
echo "<h1>FreeBSD package building statistics</h1>" >> ${TMPFILE}
echo "<p>as of `date`</p>" >> ${TMPFILE}

for arch in ${SUPPORTED_ARCHS}; do

  # begin table
  echo "<table border='1' cellpadding='4' bgcolor='#F2F2F2'>" >> ${TMPFILE}
  echo "<tr>" >> ${TMPFILE}
  echo "<td align='left' width='80'>&nbsp;</td>" >> ${TMPFILE}
  echo "<th width='60'>as of</th>" >> ${TMPFILE}
  echo "<th>INDEX</th>" >> ${TMPFILE}
  echo "<th>packages</th>" >> ${TMPFILE}
  echo "<th>errors</th>" >> ${TMPFILE}
  echo "<th>skipped</th>" >> ${TMPFILE}
  echo "<th>missing</th>" >> ${TMPFILE}
  echo "<th>done?</th>" >> ${TMPFILE}
  echo "</tr>" >> ${TMPFILE}

  # begin row
  branches=`ls ${ROOT_DIRECTORY}/${arch} | grep '^[1-9]$' | sort`
  for branch in ${branches}; do

    directory=${ROOT_DIRECTORY}/${arch}/${branch}
    if [ "$branch" = "4" ]; then
      indexfile=$directory/ports/INDEX
    else
      indexfile=$directory/ports/INDEX-$branch
    fi

    echo "<tr>" >> ${TMPFILE}

    # column: ARCH
    echo "<th align='left'>$arch-$branch</th>" >> ${TMPFILE}

    # column: datestamp of latest log
    latest="&nbsp;"
    if [ -d $directory/logs ]; then
      #latest="$(cd $directory/logs; ls -rtTl | grep '\.log' | tail -1 | awk '{printf("%s %s %s %s\n",$6,$7,$8,$9)}')"
      latest="$(cd $directory/logs; ls -rtTl | grep '\.log' | tail -1 | awk '{printf("%s %s\n",$6,$7)}')"
      if [ "$latest" ]; then
        #latest="$latest `date '+%Z'`"
      else
        latest="&nbsp;"
      fi
    fi
    echo "<td align='left'>$latest</td>" >> ${TMPFILE}

    # column: INDEX count
    n_index=0
    if [ -f $indexfile ]; then
      n_index=`cat $indexfile | wc -l`
    fi
    echo "<td align='right'>$n_index</td>" >> ${TMPFILE}

    # column: package count
    n_packages=0
    if [ -d $directory/packages/All ]; then
      n_packages=`find $directory/packages/All -name \*.tbz -o -name \*.tgz |wc -l`
    fi
    echo "<td align='right'>" >> ${TMPFILE}
    echo "<a href='http://pointyhat.freebsd.org/errorlogs/$arch-$branch-latest-logs'>" >> ${TMPFILE}
    echo "$n_packages</a></td>" >> ${TMPFILE}

    # column: error count
    n_errors=0
    if [ -d $directory/errors ]; then
      # XXX MCL why doesn't this work???
      #n_errors=`find $directory/errors -name \*.log -o -name \*.log.bz2 |wc -l`
      n_errors=`ls $directory/errors | grep '.log' | wc -l`
    fi
    echo "<td align='right'>" >> ${TMPFILE}
    echo "<a href='http://pointyhat.freebsd.org/errorlogs/$arch-$branch-latest'>" >> ${TMPFILE}
    echo "$n_errors</a></td>" >> ${TMPFILE}

    # column: duds count
    n_duds=0
    if [ -f $directory/duds ]; then
      n_duds=`cat $directory/duds | wc -l`
    fi
    echo "<td align='right'>$n_duds</td>" >> ${TMPFILE}

    # column: missing count
    if [ $n_index -ne 0 ]; then
      n_missing=`expr $n_index - $n_packages - $n_errors - $n_duds`
    else  # index currently being rebuilt
      n_missing=0
    fi
    echo "<td align='right'>$n_missing</td>" >> ${TMPFILE}

    # column: done flag
    done_flag="N"
    if [ -f $directory/build.log ]; then
      if [ ! -z "`grep 'all done at ' $directory/build.log`" ]; then
        done_flag="Y"
      fi
    fi
    echo "<td align='center'>$done_flag</td>" >> ${TMPFILE}

    echo "</tr>" >> ${TMPFILE}

  done

  echo "</table>" >> ${TMPFILE}
  echo "<br>" >> ${TMPFILE}

done

echo "<p>explanation of columns:</p>" >> ${TMPFILE}
echo "<ul>" >> ${TMPFILE}
echo "<li><b>as of</b> is the date of the latest logfile.</li>" >> ${TMPFILE}
echo "<li><b>INDEX</b> is number of ports in the INDEX file built from the latest cvs checkout.</li>" >> ${TMPFILE}
echo "<li><b>packages</b> is number of packages successfully built.</li>" >> ${TMPFILE}
echo "<li><b>errors</b> is number of packages that failed.</li>" >> ${TMPFILE}
echo "<li><b>skipped</b> is number of packages that were skipped due to NO_PACKAGE, IGNORE, BROKEN, FORBIDDEN, and so forth (\"duds\" file).</li>" >> ${TMPFILE}
echo "<li><b>missing</b> is the INDEX column minus the others.  These are packages that have not been built for one reason or another.</li>" >> ${TMPFILE}
echo "<li><b>done</b> is whether that run terminated normally or not.</li>" >> ${TMPFILE}
echo "</ul>" >> ${TMPFILE}

echo "</body>" >> ${TMPFILE}
echo "</html>" >> ${TMPFILE}

mv -f ${TMPFILE} ${OUTFILE}
