#!/bin/sh

if [ $# -lt 2 ]; then
  echo "usage: $0 arch branch"
  exit 1
fi

# configurable variables
pb=/var/portbuild

arch=$1
branch=$2

yesreally=0
dryrun=-n
if [ "$3" = "-yesreally" ]; then
  yesreally=1
  dryrun=
fi

distdir=${pb}/${arch}/${branch}/distfiles/
log=${pb}/${arch}/${branch}/logs/.distfiles

if [ -e ${distdir}/.pbtmp ]; then
  echo "${distdir} has not been processed!"
  exit 1
fi

rsync ${dryrun} -r -v -l -t --exclude RESTRICTED/ ${pb}/${arch}/${branch}/distfiles/ portmgr@ftp-master:w/ports/distfiles/ | tee ${log}

num=$(wc -l ${log} | awk '{print $1}')
if [ "$yesreally" = "0" ]; then
  echo "--> Will transfer ${num} files - make sure this is what you want and rerun '$0 $* -yesreally'"
else
  echo "--> Transferred ${num} files - results in ${log}"
fi
