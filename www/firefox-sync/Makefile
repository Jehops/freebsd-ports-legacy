# New ports collection makefile for:	weave
# Date created:				31 Aug 2009
# Whom:					Grzegorz Blach <magik@roorback.net>
#
# $FreeBSD$
#

PORTNAME=	weave
DISTVERSION=	1.0rc2
PORTEPOCH=	1
CATEGORIES=	www
MASTER_SITES=	http://files.roorback.net/ \
		LOCAL/glarkin

MAINTAINER=	magik@roorback.net
COMMENT=	Mozilla Weave extension

BUILD_DEPENDS=	${LOCALBASE}/lib/firefox3/firefox:${PORTSDIR}/www/firefox35 \
		${LOCALBASE}/lib/libxul/xpidl:${PORTSDIR}/www/libxul
RUN_DEPENDS=	${BUILD_DEPENDS}

ONLY_FOR_ARCHS=	i386 amd64
USE_BZIP2=	yes
USE_GMAKE=	yes

.include <bsd.port.options.mk>

.if ${ARCH} == i386
PLATFORM=	FreeBSD_x86-gcc3
.elif ${ARCH} == amd64
PLATFORM=	FreeBSD_x86_64-gcc3
.endif

GMAKE_FLAGS=	sdkdir=${PREFIX}/lib/firefox3/sdk rebuild_crypto=1 release_build=1 platform_target=${PLATFORM}
ALL_TARGET=	${GMAKE_FLAGS} build
INSTALL_TARGET=	${GMAKE_FLAGS} xpi

XPI_ID=		{340c2bbc-ce74-4362-90b5-7c26312808ef}
XPI_DIR=	${PREFIX}/lib/xpi/${XPI_ID}

PLIST_SUB+=	XPI_XPIDIR="${XPI_DIR:S,^${PREFIX}/,,}" \
		XPI_XPIID=${XPI_ID} \
		PLATFORM=${PLATFORM}

post-install:
	${MKDIR} ${XPI_DIR}
	(cd ${XPI_DIR}; tar -xf ${WRKSRC}/dist/xpi/weave-${DISTVERSION}-rel.xpi)
	${CHOWN} -R ${SHAREOWN}:${SHAREGRP} ${XPI_DIR}/
	${CHMOD} -R a+rX,go-w ${XPI_DIR}/
	${MKDIR} ${PREFIX}/lib/firefox3/extensions
	${LN} -sf ${XPI_DIR} ${PREFIX}/lib/firefox3/extensions

.include <bsd.port.mk>
