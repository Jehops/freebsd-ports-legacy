#!/bin/sh

# Set some variables
VERSION=%%PORTVERSION%%
APP_HOME=%%APP_HOME%%
USER_NAME=%%USER_NAME%%
LOG=%%LOG_DIR%%/%%APP_SHORTNAME%%.log
PID_FILE=/var/run/%%PORTNAME%%.pid
JAR_FILE=${APP_HOME}/%%APP_SHORTNAME%%.jar
MYSELF=`basename $0`

# Check if we're being run as a shell script or as an rc script
if [ ${MYSELF} = "%%RC_SCRIPT_NAME%%" ]; then
	AS_RC_SCRIPT=yes
else
	AS_RC_SCRIPT=no
fi

# Check if the JAVA_HOME directory is defined, otherwise set it to the
# fallback default
if [ "${JAVA_HOME}a" = "a" ]; then
	JAVA_HOME=%%JAVA_HOME%%
fi
JAVA_CMD=${JAVA_HOME}/bin/java

# Function that starts the application
start() {
	# Make sure the application is not started previously
	if [ -e ${PID_FILE} ]; then
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			echo ""
		fi
		echo "%%APP_SHORTNAME%%: ERROR: Found %%APP_TITLE%% PID file at ${PID_FILE}. It is probably already running."
		exit 1
	fi

	# Make sure the application directory does exist
	if [ ! -d ${APP_HOME} ]; then
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			echo ""
		fi
		echo "%%APP_SHORTNAME%%: ERROR: Unable to find %%APP_TITLE%% home directory at ${APP_HOME}."
		exit 2
	fi

	# Make sure the application JAR file exists
	if [ ! -r ${JAR_FILE} ]; then
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			echo ""
		fi
		echo "%%APP_SHORTNAME%%: ERROR: Unable to find %%APP_TITLE%% JAR file at ${JAR_FILE}."
		exit 3
	fi

	# Make sure the Java VM can be found
	if [ ! -x ${JAVA_CMD} ]; then
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			echo ""
		fi
		echo "%%APP_SHORTNAME%%: ERROR: Unable to find Java VM at ${JAVA_HOME}."
		exit 4
	fi

	# Create the process ID file
	rm -f ${PID_FILE}
	touch ${PID_FILE}
	chown ${USER_NAME} ${PID_FILE}
	chmod 600 ${PID_FILE}

	if [ "${AS_RC_SCRIPT}" = "yes" ]; then
		echo -n " %%APP_SHORTNAME%%"
	fi
	touch ${PID_FILE}
	chown ${USER_NAME} ${PID_FILE}
	chmod 600 ${PID_FILE}
	su - ${USER_NAME} -c "(cd ${APP_HOME} && ${JAVA_CMD} -jar ${JAR_FILE} & echo \$! > ${PID_FILE}) > ${LOG} 2>&1"
}

# Function that stops the application
stop() {
	if [ ! -e ${PID_FILE} ]; then

		# If run as an rc script, die silently...
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			exit 0

		# ...otherwise complain
		else
			echo "%%APP_SHORTNAME%%: ERROR: Unable to find %%APP_TITLE%% PID file at ${PID_FILE}. It is probably not running."
			exit 16
		fi
	else
		if [ "${AS_RC_SCRIPT}" = "yes" ]; then
			echo -n " %%APP_SHORTNAME%%"
		fi
		/bin/kill `cat ${PID_FILE}`
		rm -f ${PID_FILE}
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		start
		;;
	*)
		echo ""
		echo "Usage: ${MYSELF} { start | stop | restart }"
		echo ""
		exit 64
		;;
esac
