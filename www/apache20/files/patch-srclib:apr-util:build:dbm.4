--- srclib/apr-util/build/dbm.m4.orig	Sun Aug 31 15:27:23 2003
+++ srclib/apr-util/build/dbm.m4	Thu Jan  8 17:11:11 2004
@@ -48,6 +48,7 @@
 
   # Save the original values of the flags we tweak.
   apu_check_lib_save_libs="$LIBS"
+  apu_check_lib_save_ldflags="$LDFLAGS"
   apu_check_lib_save_cppflags="$CPPFLAGS"
 
   # The variable `found' is the prefix under which we've found
@@ -69,15 +70,21 @@
         description="$header and $lib"
       ;;
       * )
-        LDFLAGS="$LDFLAGS -L$bdb_place/lib"
-        CPPFLAGS="$CPPFLAGS -I$bdb_place/include"
+        if test -d $bdb_place; then
+          LDFLAGS="$LDFLAGS -L$bdb_place/lib"
+          CPPFLAGS="$CPPFLAGS -I$bdb_place/include"
+        else
+          AC_MSG_CHECKING([for Berkeley DB $bdb_version in $bdb_place])
+          AC_MSG_RESULT([directory not found])
+          continue
+        fi
         description="$bdb_place"
       ;;
     esac
 
     # Since there is no AC_MSG_NOTICE in autoconf 2.13, we use this
     # trick to display a message instead.
-    AC_MSG_CHECKING([checking for Berkeley DB $bdb_version in $description])
+    AC_MSG_CHECKING([for Berkeley DB $bdb_version in $description])
     AC_MSG_RESULT()
 
     for bdb_libname in $bdb_default_search_lib_names; do
@@ -99,7 +106,7 @@
                      | sed -e 's/[^a-zA-Z0-9_]/_/g'`"
             changequote([,])
 
-            AC_MSG_CHECKING([for $bdb_libname])
+            AC_MSG_CHECKING([for -l$bdb_libname])
             dnl We can't use AC_CACHE_CHECK here, because that won't print out
             dnl the value of the computed cache variable properly.
             AC_CACHE_VAL($cache_id,
@@ -291,8 +298,8 @@
   fi
   APU_CHECK_BERKELEY_DB(1, -1, -1,
     "$places",
-    "db_185.h",
-    "db"
+    "db.h",
+    "c"
   )
   if test "$apu_have_db" = "1"; then
     apu_db_version=185
@@ -350,12 +357,12 @@
 AC_DEFUN(APU_CHECK_DB4, [
   places=$1
   if test -z "$places"; then
-    places="std /usr/local /usr/local/BerkeleyDB.4.0"
+    places="std /usr/local /usr/local/BerkeleyDB.4.0 /boot/home/config"
   fi
   APU_CHECK_BERKELEY_DB("4", "0", "-1",
     "$places",
-    "db4/db.h db.h",
-    "db-4.0 db4 db"
+    "db4/db.h",
+    "db4"
   )
   if test "$apu_have_db" = "1"; then
     apu_db_version=4
@@ -371,12 +378,33 @@
 AC_DEFUN(APU_CHECK_DB41, [
   places=$1
   if test -z "$places"; then
-    places="std /usr/local/BerkeleyDB.4.1"
+    places="std /usr/local/BerkeleyDB.4.1 /boot/home/config"
   fi
   APU_CHECK_BERKELEY_DB("4", "1", "-1",
     "$places",
-    "db4/db.h db.h",
-    "db-4.1 db4 db"
+    "db41/db.h",
+    "db41"
+  )
+  if test "$apu_have_db" = "1"; then
+    apu_db_version=4
+  fi
+])
+
+
+dnl
+dnl APU_CHECK_DB42: is DB4.2 present?
+dnl
+dnl if present: sets apu_db_header, apu_db_lib, and apu_db_version
+dnl
+AC_DEFUN(APU_CHECK_DB42, [
+  places=$1
+  if test -z "$places"; then
+    places="${LOCALBASE}/include:${LOCALBASE}/lib/db42 /usr/local/BerkeleyDB.4.2 /boot/home/config"
+  fi
+  APU_CHECK_BERKELEY_DB("4", "2", "-1",
+    "$places",
+    "db42/db.h",
+    "db-4.2 db-4.2.2"
   )
   if test "$apu_have_db" = "1"; then
     apu_db_version=4
@@ -431,6 +459,12 @@
       AC_MSG_ERROR(Berkeley db4 not found)
     fi
     ;;
+  db42)
+    APU_CHECK_DB42("$check_places")
+    if test "$apu_db_version" != "4"; then
+      AC_MSG_ERROR(Berkeley db4 not found)
+    fi
+    ;;
   default)
     APU_CHECK_DB_ALL("$check_places")
     ;;
@@ -438,22 +472,25 @@
 ])
 
 dnl
-dnl APU_CHECK_DB_ALL: Try all Berkeley DB versions, from 4.1 to 1.
+dnl APU_CHECK_DB_ALL: Try all Berkeley DB versions, from 4.2 to 1.
 dnl
 AC_DEFUN(APU_CHECK_DB_ALL, [
   all_places=$1
-  
-  APU_CHECK_DB41("$all_places")
+ 
+  APU_CHECK_DB42("$all_places")
   if test "$apu_db_version" != "4"; then
-    APU_CHECK_DB4("$all_places")
+    APU_CHECK_DB41("$all_places")
     if test "$apu_db_version" != "4"; then
-      APU_CHECK_DB3("$all_places")
-      if test "$apu_db_version" != "3"; then
-        APU_CHECK_DB2("$all_places")
-        if test "$apu_db_version" != "2"; then
-          APU_CHECK_DB1("$all_places")
-          if test "$apu_db_version" != "1"; then
-            APU_CHECK_DB185("$all_places")
+      APU_CHECK_DB4("$all_places")
+      if test "$apu_db_version" != "4"; then
+        APU_CHECK_DB3("$all_places")
+        if test "$apu_db_version" != "3"; then
+          APU_CHECK_DB2("$all_places")
+          if test "$apu_db_version" != "2"; then
+            APU_CHECK_DB1("$all_places")
+            if test "$apu_db_version" != "1"; then
+              APU_CHECK_DB185("$all_places")
+            fi
           fi
         fi
       fi
@@ -487,11 +524,11 @@
 
   AC_ARG_WITH(dbm, [
     --with-dbm=DBM          choose the DBM type to use.
-      DBM={sdbm,gdbm,ndbm,db,db1,db185,db2,db3,db4}
+      DBM={sdbm,gdbm,ndbm,db,db1,db185,db2,db3,db4,db41,db42}
   ], [
     if test "$withval" = "yes"; then
       AC_MSG_ERROR([--with-dbm needs to specify a DBM type to use.
-        One of: sdbm, gdbm, ndbm, db, db1, db185, db2, db3, db4])
+        One of: sdbm, gdbm, ndbm, db, db1, db185, db2, db3, db4, db41, db42])
     fi
     requested="$withval"
   ], [
@@ -665,6 +702,10 @@
       apu_use_db=1
       apu_default_dbm=db4
       ;;
+    db42)
+      apu_use_db=1
+      apu_default_dbm=db4
+      ;;
     default)
       dnl ### use more sophisticated DBMs for the default?
       apu_default_dbm="sdbm (default)"
@@ -672,7 +713,7 @@
       ;;
     *)
       AC_MSG_ERROR([--with-dbm=$look_for is an unknown DBM type.
-        Use one of: sdbm, gdbm, ndbm, db, db1, db185, db2, db3, db4])
+        Use one of: sdbm, gdbm, ndbm, db, db1, db185, db2, db3, db4, db41, db42])
       ;;
   esac
 
