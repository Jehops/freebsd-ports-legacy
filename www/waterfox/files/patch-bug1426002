commit 7ee28da3b920
Author: Boris Zbarsky <bzbarsky@mit.edu>
Date:   Thu Dec 21 15:08:49 2017 -0500

    Bug 1426002.  Bail out of document.open if beforeunload tears things down.  r=mystor
    
    MozReview-Commit-ID: GDozCq4Qbni
---
 dom/html/nsHTMLDocument.cpp | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git dom/html/nsHTMLDocument.cpp dom/html/nsHTMLDocument.cpp
index 5ad609c0802b..ce974748034f 100644
--- dom/html/nsHTMLDocument.cpp
+++ dom/html/nsHTMLDocument.cpp
@@ -1598,6 +1598,18 @@ nsHTMLDocument::Open(JSContext* cx,
         nsCOMPtr<nsIDocument> ret = this;
         return ret.forget();
       }
+
+      // Now double-check that our invariants still hold.
+      if (!mScriptGlobalObject) {
+        nsCOMPtr<nsIDocument> ret = this;
+        return ret.forget();
+      }
+
+      nsPIDOMWindowOuter* outer = GetWindow();
+      if (!outer || (GetInnerWindow() != outer->GetCurrentInnerWindow())) {
+        nsCOMPtr<nsIDocument> ret = this;
+        return ret.forget();
+      }
     }
 
     nsCOMPtr<nsIWebNavigation> webnav(do_QueryInterface(shell));
