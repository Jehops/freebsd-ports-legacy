#!/bin/sh
#
#	$FreeBSD$
#
# Created by: hetzels@westbend.net

PKG_BATCH=${BATCH:=NO}

PKG_PREFIX=${PKG_PREFIX}
HOST_NAME=`/bin/hostname`

AP_CGI=${PKG_PREFIX}/www/cgi-bin
AP_CONF=${PKG_PREFIX}/etc/apache
AP_DATA=${PKG_PREFIX}/www/data
AP_SHARE=${PKG_PREFIX}/share/doc/apache

FPINSTALL=${PKG_PREFIX}/frontpage/version4.0/fp_install.sh
CHANGESERVER=${PKG_PREFIX}/frontpage/version4.0/change_server.sh
FPDOCDIR=${AP_SHARE}/manual/mod/mod_frontpage
IMAGES_DIR=${AP_SHARE}/manual/images
IMAGES_VTI=${PKG_PREFIX}/www/data/images/_vti_cnf

create_apache_lang_doc ()
{
    for lang in ca cz de dk ee en es fr it ja.jis lu nl po.iso-pl pt pt-br se
    {
	/bin/cat ${AP_SHARE}/index.html.${lang}-dist | \
	   /usr/bin/sed -e 's;@@HOSTNAME@@;'${HOST_NAME}';' \
	   > ${AP_SHARE}/index.html.${lang}
    }
}

create_apache_doc_root ()
{
    if [ ! -d ${AP_CGI} ]; then
                /bin/cp -rp ${AP_CGI}.default ${AP_CGI}
    fi

    if [ ! -d ${AP_DATA} ]; then
	/bin/mkdir -p ${AP_DATA}/images
	for file in apache_pb.gif fplogo.gif powerlogo.gif
	{
	    /bin/cp -rp ${IMAGES_DIR}/${file} ${AP_DATA}/images
	}

	for lang in ca cz de dk ee en es fr it ja.jis lu nl po.iso-pl pt pt-br se
	{
	    /bin/cp -rp ${AP_SHARE}/index.html.${lang} \
		${AP_DATA}/index.html.${lang}
	}
    fi
}

fix_frontpage_scripts ()
{
    /bin/cat ${FPINSTALL}-dist | \
	/usr/bin/sed	-e 's;PREFIX;'${PKG_PREFIX}';' \
			-e 's;MOD_FPDOCDIR;'${FPDOCDIR}';' \
	> ${FPINSTALL}
    /bin/cat ${CHANGESERVER}-dist | \
	/usr/bin/sed	-e 's;PREFIX;'${PKG_PREFIX}';' \
	> ${CHANGESERVER}
    /bin/chmod 555 ${CHANGESERVER} ${FPINSTALL}
    /usr/sbin/chown bin ${CHANGESERVER} ${FPINSTALL}
}

fix_httpd_conf ()
{
    if [ ! -f ${AP_CONF}/httpd.conf} ] ; then
	/bin/cat ${AP_CONF}/httpd.conf.default | \
	    /usr/bin/sed -e 's;@@HOSTNAME@@;'${HOST_NAME}';' \
	    > ${AP_CONF}/httpd.conf
    fi

    for file in mime.types magic srm.conf access.conf
    {
	if [ ! -f ${AP_CONF}/${file} ]; then
	    cp -rp ${AP_CONF}/${file}.default ${AP_CONF}/${file}
	fi
    }
}

#Add the appropriate comment to the images/_vti_cnf file.
comment_files ()
{
    if [ -d ${IMAGES_VTI} ]; then 
	if [ -f ${IMAGES_VTI}/apache_pb.gif ] && \
	   [ ! "`grep description ${IMAGES_VTI}/apache_pb.gif`" ] ; then
	    /bin/echo "vti_description:SW|Apache Webserver" >> ${IMAGES_VTI}/apache_pb.gif 
	fi
	if [ -f ${IMAGES_VTI}/fplogo.gif ] && \
	   [ ! "`grep description ${IMAGES_VTI}/fplogo.gif`" ] ; then
	    /bin/echo "vti_description:SW|Created with Microsoft FrontPage 2000" >> ${IMAGES_VTI}/fplogo.gif 
	fi
	if [ -f ${IMAGES_VTI}/powerlogo.gif ] && \
	   [ ! "`grep description ${IMAGES_VTI}/powerlogo.gif`" ] ; then
	    /bin/echo "vti_description:SW|Powered by FreeBSD" >> ${IMAGES_VTI}/powerlogo.gif
	fi
    fi
}

case $2 in
    PRE-INSTALL)
	;;
    POST-INSTALL)
	# If we are not in batch mode then run the FP install script.
        if [ "${PKG_BATCH}" = "NO" ]; then
	    create_apache_lang_doc
	    create_apache_doc_root
	    fix_frontpage_scripts
	    fix_httpd_conf
	    ${FPINSTALL}
	    comment_files
	fi
	;;

esac
