--- webmagick.orig	Wed Oct 23 03:50:49 2002
+++ webmagick.in	Wed Oct 23 04:25:13 2002
@@ -1595,9 +1595,6 @@
 	 'address'		=> $opt_address,	 
 	 'anonymous'		=> $opt_anonymous,
 	 'backgroundimg'	=> $opt_icons{'background'},
-	 'lowres'			=> $opt_lowres,
-	 'lowresdir'             => !$opt_lowres ? "" : $opt_lowresdir,
-	 'lowresformat'			=> !$opt_lowres ? "" : $opt_lowresformat,
 	 'cachedir'             => !$opt_tables ? "" : $opt_cachedir,
 	 'cacheformat'          => !$opt_tables ? "" : $opt_cacheformat,
 	 'coloralink'		=> $opt_coloralink,
@@ -1636,6 +1633,9 @@
 	 'jsfunctions'          => !$opt_javascript ? "" : $fileNames{'jsFunctions'},
 	 'jspageindex'          => !$opt_javascript ? "" : $fileNames{'jsPageIndex'},
 	 'jsvariables'          => !$opt_javascript ? "" : $fileNames{'jsVariables'},
+	 'lowres'               => $opt_lowres,
+	 'lowresdir'            => !$opt_lowres ? "" : $opt_lowresdir,
+	 'lowresformat'         => !$opt_lowres ? "" : $opt_lowresformat,
 	 'metaauthor'		=> $opt_metaauthor,
 	 'metacharset'          => $opt_metacharset,
 	 'metaclassification'	=> $opt_metaclassification,
@@ -2938,6 +2938,8 @@
 					       $opt_lowresformat, $opt_lowresmin,
 					       0, 0);
 		if ($rc == -1) {
+		    # @$image already deleted
+		    print("Trying next image...\n");
 		    next READ;
 		}
 
@@ -2951,7 +2953,9 @@
 					   $opt_cacheformat, $opt_cachemin,
 					   $opt_thumbprehook, $opt_thumbposthook);
 	    if ($rc == -1) {
-			next READ;
+		# @$image already deleted
+		print("Trying next image...\n");
+		next READ;
 	    }
 
 	    #
@@ -3731,14 +3735,18 @@
 		# scaled sizes) but not smaller.
 		# This uses a feature available in PerlMagick 1.12 and beyond
 		$status = $image->Set(size=>$a_geometry);
-		handleMagickError( __FILE__, __LINE__, "$a_geometry", $status) if "$status";
+		if ("$status") {
+			undef @$image;
+			handleMagickError( __FILE__, __LINE__, "$a_geometry", $status);
+			return -1;								# Try to read next image		    }
+		}
 		
 		# Read image
 		print( STDERR "Reading ${imagename}\[0\] with geometry ${a_geometry}...\n" ) if $opt_debug;
 		$status = $image->Read("${imagename}\[0\]");
-		if ("$status" && handleMagickError( __FILE__, __LINE__, $imagename, $status)) {
-			undef @$image;						# Only delete image data, not object
-			print("Trying next image ...\n" );
+		if ("$status") {
+			undef @$image;
+			handleMagickError( __FILE__, __LINE__, $imagename, $status);
 			return -1;								# Try to read next image		    }
 		}
 
@@ -3826,7 +3834,11 @@
 
 			# Apply comment to thumbnail image
 			$status = $image->Comment( $comment );
-			handleMagickError( __FILE__, __LINE__, $cachename, $status) if "$status";
+			if ("$status") {
+				undef @$image;
+				handleMagickError( __FILE__, __LINE__, $cachename, $status);
+				return -1;
+			}
 		    
 			print( STDERR "Writing ${cachename} ...\n" )
 			    if $opt_debug;
@@ -3844,7 +3856,11 @@
 							filename=>"${a_cacheformat}:${cachename}"
 						       );
 			}
-			handleMagickError( __FILE__, __LINE__, $cachename, $status) if "$status";
+			if ("$status") {
+				undef @$image;
+				handleMagickError( __FILE__, __LINE__, $cachename, $status);
+				return -1;
+			}
 			if (! $a_lowres) {
 			# TODO: for some reason, the output looks like these are getting put in twice, once with .cache/
 				$thumbImageSizes{$imagename} = html_imgsize($cachename);
@@ -3916,12 +3932,13 @@
 	    print( STDERR "Applying image label: \"${label}\"\n" )
 		if $opt_debug;
 	    $status = $image->Label( $label );
-	    handleMagickError( __FILE__, __LINE__, $imagename, $status) if "$status";
+	    if ("$status") {
+		    undef @$image;
+		    handleMagickError( __FILE__, __LINE__, $imagename, $status);
+		    return -1;
+	    }
 	}
 	
-	undef @$image;
-	undef $image;
-
 	return 0;
 }
 ######################################################################
