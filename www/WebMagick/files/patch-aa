Index: webmagick.in
===================================================================
RCS file: /cvsroot/webmagick/WebMagick/webmagick.in,v
retrieving revision 1.114
retrieving revision 1.116
diff -u -r1.114 -r1.116
--- webmagick.in	25 Sep 2002 01:00:20 -0000	1.114
+++ webmagick.in	23 Oct 2002 00:57:06 -0000	1.116
@@ -1,6 +1,6 @@
 #! @PERL@ 
 #
-# $Id: webmagick.in,v 1.114 2002/09/25 01:00:20 clindell Exp $
+# $Id: webmagick.in,v 1.116 2002/10/23 00:57:06 ache Exp $
 #
 # You are looking at the main PERL script for WebMagick, a package to
 # intelligently create HTML and JavaScript index files and imagemaps
@@ -1595,9 +1595,6 @@
 	 'address'		=> $opt_address,	 
 	 'anonymous'		=> $opt_anonymous,
 	 'backgroundimg'	=> $opt_icons{'background'},
-	 'lowres'			=> $opt_lowres,
-	 'lowresdir'             => !$opt_lowres ? "" : $opt_lowresdir,
-	 'lowresformat'			=> !$opt_lowres ? "" : $opt_lowresformat,
 	 'cachedir'             => !$opt_tables ? "" : $opt_cachedir,
 	 'cacheformat'          => !$opt_tables ? "" : $opt_cacheformat,
 	 'coloralink'		=> $opt_coloralink,
@@ -1636,6 +1633,9 @@
 	 'jsfunctions'          => !$opt_javascript ? "" : $fileNames{'jsFunctions'},
 	 'jspageindex'          => !$opt_javascript ? "" : $fileNames{'jsPageIndex'},
 	 'jsvariables'          => !$opt_javascript ? "" : $fileNames{'jsVariables'},
+	 'lowres'               => $opt_lowres,
+	 'lowresdir'            => !$opt_lowres ? "" : $opt_lowresdir,
+	 'lowresformat'         => !$opt_lowres ? "" : $opt_lowresformat,
 	 'metaauthor'		=> $opt_metaauthor,
 	 'metacharset'          => $opt_metacharset,
 	 'metaclassification'	=> $opt_metaclassification,
@@ -2937,11 +2937,13 @@
 					       $opt_forcelowres, $opt_lowresgeom,
 					       $opt_lowresformat, $opt_lowresmin,
 					       0, 0);
+		undef @$image; # Only delete image data, not object
+
 		if ($rc == -1) {
+		    print("Trying next image...\n");
 		    next READ;
 		}
 
-		undef @$image; # Only delete image data, not object
 	    }
 
 	    #then do the thumbnail
@@ -2951,7 +2953,9 @@
 					   $opt_cacheformat, $opt_cachemin,
 					   $opt_thumbprehook, $opt_thumbposthook);
 	    if ($rc == -1) {
-			next READ;
+		undef @$image; # Only delete image data, not object
+		print("Trying next image...\n");
+		next READ;
 	    }
 
 	    #
@@ -2959,8 +2963,6 @@
 	    #
 	    push(@$thumbs, @$image);
 	     
-	    #print( STDERR "Freeing $imagename ...\n") if $opt_debug;
-             
 	    # Only delete image data, not object
 	    undef @$image;
 	}
@@ -3698,7 +3700,6 @@
 		print( STDERR "Reading $cachename ...\n" ) if $opt_debug;
 		$status = $image->Read("$cachename");
 		if ("$status") {
-			undef @$image;						# Only delete image data, not object
 			handleMagickError( __FILE__, __LINE__, $cachename, $status);
 			return -1;								# Try to read next image
 		}
@@ -3731,14 +3732,16 @@
 		# scaled sizes) but not smaller.
 		# This uses a feature available in PerlMagick 1.12 and beyond
 		$status = $image->Set(size=>$a_geometry);
-		handleMagickError( __FILE__, __LINE__, "$a_geometry", $status) if "$status";
+		if ("$status") {
+			handleMagickError( __FILE__, __LINE__, "$a_geometry", $status);
+			return -1;								# Try to read next image		    }
+		}
 		
 		# Read image
 		print( STDERR "Reading ${imagename}\[0\] with geometry ${a_geometry}...\n" ) if $opt_debug;
 		$status = $image->Read("${imagename}\[0\]");
-		if ("$status" && handleMagickError( __FILE__, __LINE__, $imagename, $status)) {
-			undef @$image;						# Only delete image data, not object
-			print("Trying next image ...\n" );
+		if ("$status") {
+			handleMagickError( __FILE__, __LINE__, $imagename, $status);
 			return -1;								# Try to read next image		    }
 		}
 
@@ -3802,7 +3805,6 @@
 			}
 		    
 			if ("$status") {
-				undef @$image;					# Only delete image data, not object
 				handleMagickError( __FILE__, __LINE__, $imagename, $status);
 				return -1;							# Try to read next image
 			}
@@ -3826,7 +3828,10 @@
 
 			# Apply comment to thumbnail image
 			$status = $image->Comment( $comment );
-			handleMagickError( __FILE__, __LINE__, $cachename, $status) if "$status";
+			if ("$status") {
+				handleMagickError( __FILE__, __LINE__, $cachename, $status);
+				return -1;
+			}
 		    
 			print( STDERR "Writing ${cachename} ...\n" )
 			    if $opt_debug;
@@ -3844,7 +3849,10 @@
 							filename=>"${a_cacheformat}:${cachename}"
 						       );
 			}
-			handleMagickError( __FILE__, __LINE__, $cachename, $status) if "$status";
+			if ("$status") {
+				handleMagickError( __FILE__, __LINE__, $cachename, $status);
+				return -1;
+			}
 			if (! $a_lowres) {
 			# TODO: for some reason, the output looks like these are getting put in twice, once with .cache/
 				$thumbImageSizes{$imagename} = html_imgsize($cachename);
@@ -3916,12 +3924,12 @@
 	    print( STDERR "Applying image label: \"${label}\"\n" )
 		if $opt_debug;
 	    $status = $image->Label( $label );
-	    handleMagickError( __FILE__, __LINE__, $imagename, $status) if "$status";
+	    if ("$status") {
+		    handleMagickError( __FILE__, __LINE__, $imagename, $status);
+		    return -1;
+	    }
 	}
 	
-	undef @$image;
-	undef $image;
-
 	return 0;
 }
 ######################################################################
