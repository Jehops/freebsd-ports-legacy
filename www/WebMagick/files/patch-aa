--- webmagick.in.orig	Sun Dec 20 01:03:12 1998
+++ webmagick.in	Sat Jun 12 20:01:35 1999
@@ -128,6 +128,7 @@
     $opt_dircolorlink,
     $opt_dircolorvlink,
     $opt_dirfmt,
+    $opt_dirhtmlext,
     $opt_dirindexname,
     $opt_forcecache,
     $opt_forcegif,
@@ -157,6 +158,7 @@
     $opt_imgindexname,
     $opt_indexname,
     $opt_javascript,
+    $opt_jpegquality,
     $opt_mapnetscape,
     $opt_maptype,
     $opt_maxgif,
@@ -268,6 +270,7 @@
 $opt_pageindexname	= '.index';	# Base name of secondary index files
 $opt_dirindexname	= '.dirindex';	# Subdirectory Title cross-reference
 					#  dirname   Directory Title
+$opt_dirhtmlext         = '.html';      # Use .shtml for SSI
 $opt_imgindexname	= '.imgindex';	# Image name to label cross-reference file
 
 #
@@ -310,6 +313,7 @@
 $opt_forcemontage	= 0;	# Force montage (default off)
 $opt_forcegif		= 0;	# Force GIF imagemaps (default off)
 $opt_forcejpeg          = 0;    # Force JPEG imagemaps (default off)
+$opt_jpegquality        = 70;   # Quality for JPEG imagemaps
 $opt_help		= 0;	# Display usage message
 $opt_version		= 0;	# Display version info
 $opt_htmlext            = '.html'; # Use .shtml for SSI
@@ -660,6 +664,7 @@
 		'dircolorfore=s'	=> \$opt_dircolorfore,
 		'dircolorlink=s'	=> \$opt_dircolorlink,
 		'dircolorvlink=s'	=> \$opt_dircolorvlink,
+		'dirhtmlext=s'          => \$opt_dirhtmlext,
 		'dirindexname=s'	=> \$opt_dirindexname,
 		'footer=s'              => \$opt_footer,
 		'forcecache!'		=> \$opt_forcecache,
@@ -680,6 +685,7 @@
 		'imgindexname=s'	=> \$opt_imgindexname,
 		'indexname=s'		=> \$opt_indexname,
 		'javascript!'		=> \$opt_javascript,
+		'jpegquality=i'         => \$opt_jpegquality,
 		'mapnetscape!'		=> \$opt_mapnetscape,
 		'maptype=s'		=> \$opt_maptype,
 		'maxgif=i'		=> \$opt_maxgif,
@@ -872,7 +878,7 @@
     # for each directory ignoring hidden directories
     use File::Find;
     print( "Processing directory tree $opt_srcdir ...\n" ) if $opt_debug;
-    finddepth( \&wanted, $opt_srcdir );
+    find( \&wanted, $opt_srcdir );
 } else {
     print( "Processing directory $opt_srcdir ...\n" ) if $opt_debug;
     $sourceDirectory = $opt_srcdir;
@@ -936,7 +942,7 @@
 sub wanted {
     my($dev,$ino,$mode,$nlink,$uid,$gid);
     ($dev,$ino,$mode,$nlink,$uid,$gid) = lstat($_);
-    if ( -d $_ && !/^\..+/ ) {
+    if ( -d _ && -w _ && !/^\..+/ ) {
         if( $_ ne '.' && get_rc_var('.', 'opt_prune', 0) ) {
             $File::Find::prune=1;
 	    # following funny logic is to avoid warnings about $prune
@@ -1426,6 +1432,7 @@
 	 'dircolorfore'		=> $opt_dircolorfore,
 	 'dircolorlink'		=> $opt_dircolorlink,
 	 'dircolorvlink'	=> $opt_dircolorvlink,
+	 'dirhtmlext'           => $opt_dirhtmlext,
 	 'dirindexname'		=> $opt_dirindexname,
 	 'footer'               => $opt_footer,
 	 'framemarginwidth'	=> $opt_framemarginwidth,
@@ -1695,7 +1702,7 @@
 sub writeTopIndexes {
 
     print( STDERR "Writing Index Files ${opt_indexname} & ",
-                "${opt_pageindexname}dir.html ...\n" )
+		"${opt_pageindexname}dir${opt_dirhtmlext} ...\n" )
                 if $opt_debug;
 
     #---- Generate the Variables for Format Options ----
@@ -1806,7 +1813,7 @@
     # Pull README into thumbnail frame if it exists, and is
     # either marked always visible or there are no images.
     #
-    $dirframelink = "${opt_pageindexname}dir.html";
+    $dirframelink = "${opt_pageindexname}dir${opt_dirhtmlext}";
 
     if( $opt_framefmt_frames{$opt_framestyle} <= 2 ) {
 	if( $haveReadme && ( $opt_readmevisible || ! $haveImages ) ) {
@@ -1924,8 +1931,8 @@
 
     # ----- Output Frame Directory File (usally ".indexdir.html") ------
     #
-    open( INDEX, ">${opt_pageindexname}dir.html")
-	|| die("$0: Failed to open file \"${opt_pageindexname}dir.html\"",
+    open( INDEX, ">${opt_pageindexname}dir${opt_dirhtmlext}")
+	|| die("$0: Failed to open file \"${opt_pageindexname}dir${opt_dirhtmlext}\"",
                 " for output\n$@\n");
     print( INDEX "<HTML>\n<HEAD>\n" );
     print( INDEX "  <TITLE>${pageTitle}</TITLE>\n" );
@@ -2762,7 +2769,7 @@
 		$status = $montage->Write(
 					  filename=>"JPEG:$fileNames{'montageJPEG'}",
 					  interlace=>'Plane',
-					  quality=>70
+					  quality=>$opt_jpegquality
 					  );
 		handleMagickError( __FILE__, __LINE__, $fileNames{'montageJPEG'}, $status) if "$status";
 		last MONTAGE if "$status";
@@ -3373,6 +3380,8 @@
 
 Montage:
   --forcegif         Force imagemap to be in GIF format
+  --forcejpeg        Force imagemap to be in JPEG format
+  --jpegquality      Quality of JPEG imagemaps
   --maxgif           Maximum size of GIF imagemap before trying JPEG
   --columns	     Montage columns
   --rows	     Montage rows (max)
@@ -3412,6 +3421,7 @@
   --dircolorfore     Foreground color (directory frame)
   --dircolorlink     Link (unvisited) color (directory frame)
   --dircolorvlink    Link (visited) color (directory frame)
+  --dirhtmlext       Extension for directories frame
 
   --javascript	     Enable JavaScript output
   --header           Page header (imagemap frame)
