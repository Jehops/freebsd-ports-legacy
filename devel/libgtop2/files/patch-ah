--- sysdeps/freebsd/procmap.c.orig	Sat Sep 25 07:49:06 2004
+++ sysdeps/freebsd/procmap.c	Fri Nov 19 11:26:15 2004
@@ -47,7 +47,13 @@
 #endif
 #endif
 
+#ifdef __FreeBSD__
+#define _KVM_VNODE
+#endif
 #include <sys/vnode.h>
+#ifdef __FreeBSD__
+#undef _KVM_VNODE
+#endif
 #include <sys/mount.h>
 #include <ufs/ufs/quota.h>
 #include <ufs/ufs/inode.h>
@@ -104,7 +110,7 @@
 	glibtop_map_entry *maps;
 #if defined __FreeBSD__
 	struct vnode vnode;
-#if __FreeBSD_version >= 500039
+#if __FreeBSD_version < 500039
 	struct inode inode;
 #endif
 #endif
@@ -122,8 +128,10 @@
 
 	/* Get the process data */
 	pinfo = kvm_getprocs (server->machine.kd, KERN_PROC_PID, pid, &count);
-	if ((pinfo == NULL) || (count < 1))
+	if ((pinfo == NULL) || (count < 1)) {
 		glibtop_error_io_r (server, "kvm_getprocs (%d)", pid);
+		return NULL;
+	}
 
 	/* Now we get the memory maps. */
 
@@ -264,8 +272,10 @@
 #if defined(__FreeBSD__) && (__FreeBSD_version >= 500039)
                switch (vnode.v_type) {
                    case VREG:
+#if __FreeBSD_version < 600006
                        maps [i-1].inode = vnode.v_cachedid;
                        maps [i-1].device = vnode.v_cachedfs;
+#endif
                    default:
                    continue;
                }
@@ -278,13 +288,9 @@
 			      &inode, sizeof (inode)) != sizeof (inode))
 			glibtop_error_io_r (server, "kvm_read (inode)");
 
-		if (kvm_read (server->machine.kd,
-			      (unsigned long) vnode.v_mount,
-			      &mount, sizeof (mount)) != sizeof (mount))
-			glibtop_error_io_r (server, "kvm_read (mount)");
-#endif
 		maps [i-1].inode  = inode.i_number;
 		maps [i-1].device = inode.i_dev;
+#endif
 #endif
 	} while (entry.next != first);
 
