--- configure.orig	2010-11-23 17:33:28.000000000 +0300
+++ configure	2010-11-25 01:47:25.000000000 +0300
@@ -21458,8 +21458,8 @@
       fi
 
       if test "$withval" = "yes"; then
-        if test "$apu_db_version" != "4"; then
-          as_fn_error "APR-UTIL wasn't linked against Berkeley DB 4,
+        if test "$apu_db_version" != "4" -a "$apu_db_version" != "5"; then
+          as_fn_error "APR-UTIL wasn't linked against Berkeley DB 4 or 5,
                         while the fs component is required.  Reinstall
                         APR-UTIL with the appropiate options." "$LINENO" 5
         fi
@@ -21467,7 +21467,7 @@
         status=required
 
       elif test "$apu_found" != "reconfig"; then
-        if test "$apu_db_version" != 4; then
+        if test "$apu_db_version" != 4 -a "$apu_db_version" != "5"; then
           as_fn_error "APR-UTIL was installed independently, it won't be
                         possible to use the specified Berkeley DB: $withval" "$LINENO" 5
         fi
@@ -21513,7 +21513,7 @@
                    whether apr-util is linked against Berkeley DB
                    $db_version" >&2;}
       status=try-link
-    elif test "$apu_db_version" != "4"; then
+    elif test "$apu_db_version" != "4" -a "$apu_db_version" != "5"; then
       status=skip
     else
       status=try-link
@@ -23801,7 +23801,10 @@
 
 
 if test "$RUBY" != "none"; then
-  if "$RUBY" -r mkmf -e 'exit(have_func("rb_hash_foreach") ? 0 : 1)'; then
+  if [ -z "$PTHREAD_LIBS" ]; then
+    PTHREAD_LIBS=-pthread
+  fi
+  if "$RUBY" -r mkmf -e 'with_ldflags("'"$PTHREAD_LIBS"'") { exit(have_func("rb_hash_foreach") ? 0 : 1) }'; then
     # Extract the first word of "rdoc", so it can be a program name with args.
 set dummy rdoc; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
