#!/bin/sh
# $FreeBSD:
#
# PROVIDE: cvsd
# REQUIRE: NETWORKING
# KEYWORD: nojail

. %%RC_SUBR%%

name="cvsd"
rcvar=`set_rcvar`
command="%%PREFIX%%/sbin/$name"

load_rc_config $name

: ${cvsd_enable="NO"}
: ${cvsd_config="%%PREFIX%%/etc/$name/$name.conf"}

command_args="-f $cvsd_config"

start_precmd="cvsd_prestart"
stop_postcmd="cvsd_poststop"

cvsd_prestart()
{
	if [ $osreldate -gt 500000 ]; then
		mount -t devfs devfs $jail/dev
		devfs -m $jail/dev rule apply hide
		devfs -m $jail/dev rule apply path null unhide
		devfs -m $jail/dev rule apply path zero unhide
	fi
}

cvsd_poststop()
{
	if [ $osreldate -gt 500000 ]; then
		umount -t devfs $jail/dev
	fi
}

jail=`sed -n 's/^ *RootJail *\([^ ]*\) *$/\1/p' < $cvsd_config`
pidfile=`sed -n 's/^ *PidFile *\([^ ]*\) *$/\1/p' < $cvsd_config`
osreldate=`sysctl -n kern.osreldate`
if [ "$jail" = "X$jail" ]; then
	err 1 "RootJail is not specified in $cvsd_config"
fi
if [ "$pidfile" = "X$pidfile" ]; then
	err 1 "PidFile is not specified in $cvsd_config"
fi

run_rc_command "$1"

