# $FreeBSD$

PORTNAME=	android-tools-adb
DISTVERSIONPREFIX=	android-
DISTVERSION?=	6.0.0_r1
PORTREVISION?=	0
CATEGORIES=	devel
MASTER_SITES=	https://anonscm.debian.org/cgit/android-tools/android-tools.git/plain/debian/:bashcomp
DISTFILES=	${DISTNAME}${EXTRACT_SUFX} \
		bash_completion.d/adb?id=2b8cfec:bashcomp
EXTRACT_ONLY=	${DISTFILES:N*\:bashcomp:C/:.*//}

MAINTAINER=	jbeich@FreeBSD.org
COMMENT=	Android debug bridge command line tool

LICENSE=	APACHE20

USE_GITHUB=	yes
GH_ACCOUNT=	android
GH_PROJECT=	platform_system_core

# Emulate GH_COMMIT without causing desync
.ifdef DISTVERSIONSUFFIX
GH_REVISION=	${DISTVERSIONSUFFIX:S/-g//} # snapshot
.else
GH_REVISION=	bb0c180e6270 # generated by: make update-revision
.endif

CONFLICTS_INSTALL?=	${PORTNAME}-devel-*

.ifndef EXTRA_PATCHES
EXTRA_PATCHES+=	${PATCHDIR}/extra-patch-base_file__test.cpp
.endif

USES=		compiler:c++11-lib uidfix
USE_OPENSSL=	yes
BUILD_WRKSRC=	${WRKSRC}/adb
INSTALL_WRKSRC=	${BUILD_WRKSRC}
MAKEFILE=	${FILESDIR}/Makefile
MAKE_ENV=	BINDIR="${PREFIX}/bin" FILESDIR="${FILESDIR}"
ALL_TARGET=	all
CPPFLAGS+=	-DADB_REVISION='\"${GH_REVISION}-android\"'

PLIST_FILES=	bin/adb \
		%%BASH%%etc/bash_completion.d/adb
PORTDOCS=	*.txt *.TXT

OPTIONS_DEFINE+=BASH DOCS TEST
OPTIONS_SUB=	yes

BASH_VARS=	LICENSE+=MIT LICENSE_COMB=multi # debian/copyright

TEST_BUILD_DEPENDS=	googletest>=1.6.0:${PORTSDIR}/devel/googletest
TEST_ALL_TARGET=	adb_test

pre-install-TEST-on:
	${BUILD_WRKSRC}/adb_test

post-patch:
# XXX C++ exception with description "regex_error" thrown in the test body.
	@if [ ${OPSYS} = FreeBSD -a ${OSREL:R} -lt 10 ]; then \
		${REINPLACE_CMD} -Ee '/^TEST/\
			s/ (LOG|PLOG|UNIMPLEMENTED)/ DISABLED_\1/' \
		${WRKSRC}/base/logging_test.cpp; \
	fi
.if defined(PACKAGE_BUILDING)
# XXX /dev/full isn't mounted by poudriere/tinderbox
	@${REINPLACE_CMD} -e '/^TEST/s/[^ ]*ENOSPC/DISABLED_&/' \
		${WRKSRC}/adb/adb_io_test.cpp
.endif

post-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/${PLIST_FILES:M%%BASH%%*:C/%%.*%%//:H}
	${INSTALL_DATA} ${_DISTDIR}/${DISTFILES:M*\:bashcomp:C/:.*//} \
		${STAGEDIR}${PREFIX}/${PLIST_FILES:M%%BASH%%*:C/%%.*%%//}
	(cd ${INSTALL_WRKSRC} && ${COPYTREE_SHARE} \
		"${PORTDOCS}" ${STAGEDIR}${DOCSDIR})

update-revision:
# https://developer.github.com/v3/repos/commits/#get-a-single-commit
# Pretend to be curl(1) for pretty-printed JSON to help parse with sed(1)
	@${REINPLACE_CMD} -i '' -e "/^GH_REVISION.*$@/s/=.*/=	$$(\
		${SETENV} HTTP_USER_AGENT=curl ${FETCH_CMD} -qo- \
			https://api.github.com/repos/${GH_ACCOUNT}/${GH_PROJECT}/commits/${GH_TAGNAME} | \
			${SED} -n '/sha/ { s/.*\"\([0-9a-f]\{12\}\).*/\1/p; q; }' \
		) # generated by: make $@/" \
		${.CURDIR}/Makefile

.include <bsd.port.mk>

# XXX Work around !target(makesum)
.ifndef DISTVERSIONSUFFIX
makesum:	update-revision
.endif
