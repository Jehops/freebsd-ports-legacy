*** Makefile.orig	Sun Jan  8 23:34:51 1995
--- Makefile	Thu Jan 12 00:44:38 1995
***************
*** 11,18 ****
  # puts malloc.h in $INCDIR.
  #
  
! LIBDIR=$(HOME)/lib/$(ARCH)
! INCDIR=$(HOME)/include
  
  # neutralize SystemV genius
  SHELL=/bin/sh
--- 11,18 ----
  # puts malloc.h in $INCDIR.
  #
  
! LIBDIR=${PREFIX}/lib
! INCDIR=${PREFIX}/include
  
  # neutralize SystemV genius
  SHELL=/bin/sh
***************
*** 62,72 ****
--- 62,75 ----
  RANLIB = ranlib
  
  LDFLAGS=#-Bstatic
+ VERSION=1.13
  
  # only developers should have to change stuff below this line
  
  EXT=_d
  LIBMALLOC=libmalloc$(EXT).a
+ LIBSMALLOC=libmalloc${EXT}.so.${VERSION}
+ 
  PROGS=testmalloc$(EXT) simumalloc$(EXT) teststomp$(EXT) maltrace$(EXT)
  
  DEFINES= $(NORMALDEFS) $(DEBUGDEFS)
***************
*** 108,116 ****
  
  CFLAGS = $(CDEBUGFLAGS) $(INCLUDES) $(DEFINES)
  
! all: pass clean libmalloc
  
! pass: $(LIBMALLOC) $(PROGS) out$(EXT)
  
  libmalloc:
  	$(MAKE) -f Makefile $(MFLAGS) CC="$(CC)" DEBUGDEFS="$(FASTDEFS)" \
--- 111,126 ----
  
  CFLAGS = $(CDEBUGFLAGS) $(INCLUDES) $(DEFINES)
  
! .c.o:
! 	${CC} -c ${CFLAGS} $< -o $@
! 	${CC} -c -fpic ${CFLAGS} $< -o shared/$@
! 
! all: mkdir pass clean libmalloc
! 
! mkdir:
! 	@mkdir -p shared
  
! pass: $(LIBMALLOC) $(LIBSMALLOC) $(PROGS) out$(EXT)
  
  libmalloc:
  	$(MAKE) -f Makefile $(MFLAGS) CC="$(CC)" DEBUGDEFS="$(FASTDEFS)" \
***************
*** 134,139 ****
--- 144,155 ----
  	-$(RANLIB) $(LIBMALLOC)
  	touch .lib$(EXT)
  
+ $(LIBSMALLOC): $(OBJS)
+ 	rm -f $(LIBSMALLOC) ${SPLAYOBJ}
+ 	cd splay; $(MAKE) $(MFLAGS) DEFINES="$(DEFINES)" \
+ 		LIBMALLOC=../$(LIBMALLOC) CC="$(CC) -fpic"
+ 	(cd shared; ld -Bshareable -o ../$(LIBSMALLOC) $(OBJS) ../${SPLAYOBJ})
+ 
  $(SPLAYOBJ): .foo
  	cd splay; $(MAKE) $(MFLAGS) DEFINES="$(DEFINES)" \
  		LIBMALLOC=../$(LIBMALLOC) CC="$(CC)"
***************
*** 163,169 ****
  
  clean:
  	-rm -f *.o \#* *~ core a.out gmon.out mon.out onefile.c *.sL prof.out
! 	cd splay; $(MAKE) clean
  
  veryclean: clean cleanprogs
  	make EXT= cleanprogs
--- 179,186 ----
  
  clean:
  	-rm -f *.o \#* *~ core a.out gmon.out mon.out onefile.c *.sL prof.out
! 	-(cd shared; rm -f *.o \#* *~)
! 	(cd splay; $(MAKE) clean)
  
  veryclean: clean cleanprogs
  	make EXT= cleanprogs
***************
*** 174,179 ****
--- 191,197 ----
  	-$(RANLIB) $(LIBDIR)/libmalloc.a
  	install -c -m 644 libmalloc_d.a $(LIBDIR)
  	-$(RANLIB) $(LIBDIR)/libmalloc_d.a
+ 	install -c -m 644 ${LIBSMALLOC} $(LIBDIR)
  	install -c -m 644 malloc.h $(INCDIR)
  	
  .id: $(SRCS)
