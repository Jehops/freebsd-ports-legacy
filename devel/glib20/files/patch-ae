
$FreeBSD$

--- configure.orig	Mon Apr 16 19:12:05 2001
+++ configure	Sun Apr 29 14:01:19 2001
@@ -6287,6 +6287,12 @@
 	  linux*)
 	    G_MODULE_LDFLAGS='-rdynamic'
 	    ;;
+	  freebsd*)
+	    objformat=`test -x /usr/bin/objformat && /usr/bin/objformat || echo aout`
+	    if test $objformat = "elf"; then
+	      G_MODULE_LDFLAGS='-Wl,-E'
+	    fi
+	    ;;
 	esac
 	LIBS_orig="$LIBS"
 	LDFLAGS_orig="$LDFLAGS"
@@ -6753,7 +6759,7 @@
             	        G_THREAD_CFLAGS="$G_THREAD_CFLAGS -mthreads"
 		fi
 		;;
-	*-freebsd2.2*)
+	*-freebsd*)
 		G_THREAD_CFLAGS="$G_THREAD_CFLAGS -D_THREAD_SAFE"
 
 		# FreeBSD 2.2.x shiped with gcc 2.7.2.x, which doesn't support
@@ -6840,8 +6846,8 @@
 				add_thread_lib=""
 				IN=""
 			else
-				add_thread_lib="-l$thread_lib"
-				IN=" in -l$thread_lib"
+				add_thread_lib="-$thread_lib"
+				IN=" in -$thread_lib"
 			fi
 			if test x"$have_threads" = xposix; then
 				defattr=0
@@ -7142,7 +7148,7 @@
                                         		sizeof (buffer));
 ; return 0; }
 EOF
-if { (eval echo configure:7146: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:7146: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null; then
   rm -rf conftest*
   ac_cv_func_nonposix_getpwuid_r=yes
 else
@@ -7440,6 +7446,7 @@
   if test "$cross_compiling" = yes; then
     { echo "configure: error: can not run test program while cross compiling" 1>&2; exit 1; }
 else
+#  LIBS="-liconv  $LIBS"
   cat > conftest.$ac_ext <<EOF
 #line 7445 "configure"
 #include "confdefs.h"
@@ -7747,14 +7754,14 @@
    #
    # Check for libiconv
    #
-   echo $ac_n "checking for libiconv_open in -liconv""... $ac_c" 1>&6
-echo "configure:7752: checking for libiconv_open in -liconv" >&5
+   echo $ac_n "checking for libiconv_open in -lgiconv""... $ac_c" 1>&6
+echo "configure:7752: checking for libiconv_open in -lgiconv" >&5
 ac_lib_var=`echo iconv'_'libiconv_open | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   ac_save_LIBS="$LIBS"
-LIBS="-liconv  $LIBS"
+LIBS="-lgiconv  $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 7760 "configure"
 #include "confdefs.h"
@@ -7794,7 +7801,7 @@
 fi
 
 if test "x$with_libiconv" = "xyes" ; then
-  ICONV_LIBS="-liconv"
+  ICONV_LIBS="-lgiconv"
   cat >> confdefs.h <<\EOF
 #define USE_LIBICONV 1
 EOF
