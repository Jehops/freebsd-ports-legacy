#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: milterdkim
# REQUIRE: DAEMON
# BEFORE: sendmail
# KEYWORD: shutdown

# Define these milterdkim_* variables in one of these files:
#	/etc/rc.conf
#	/etc/rc.conf.local
#	/etc/rc.conf.d/milterdkim
#
# DO NOT CHANGE THESE DEFAULT VALUES HERE
#
milterdkim_enable=${milterdkim_enable:-"NO"}
milterdkim_socket=${milterdkim_socket:-"local:/var/run/dkim-filter"}
milterdkim_pid=${milterdkim_pid:-"/var/run/dkim-filter.pid"}
milterdkim_domain=${milterdkim_domain:-"example.com"}
milterdkim_key=${milterdkim_key:-"/var/db/domainkeys/default.key.pem"}
milterdkim_flags=${milterdkim_flags:-"-d ${milterdkim_domain} -c nowsp -m MSA \
-s ${milterdkim_key} -S default"}

. %%RC_SUBR%%

name="milterdkim"
pidfile=${milterdkim_pid}
rcvar=`set_rcvar`
command="%%PREFIX%%/libexec/dkim-filter"
command_args="-l -p ${milterdkim_socket} -P ${milterdkim_pid}"
stop_postcmd="dkim_postcmd"

load_rc_config $name

dkim_postcmd ()
{
    if [ -S ${milterdkim_socket##local:} ] ; then
        rm -f ${milterdkim_socket##local:}
    elif [ -S ${milterdkim_socket##unix:} ] ; then
        rm -f ${milterdkim_socket##unix:}
    fi
}

run_rc_command "$1"
