--- ../orig/qmail-smtpd.c.patch	Mon May 23 18:02:27 2005
+++ qmail-smtpd.c.patch	Wed May 25 09:50:32 2005
@@ -1,8 +1,6 @@
---- qmail-smtpd.c.orig  1998-06-15
-+++ qmail-smtpd.c       2005-05-23
---- .././qmail-1.03/qmail-smtpd.c	Mon Jun 15 12:53:16 1998
-+++ ../qmail-1.03.2314/qmail-smtpd.c	Mon May 23 23:02:20 2005
-@@ -20,14 +20,51 @@
+--- qmail-smtpd.c.orig	Wed May 25 09:46:36 2005
++++ qmail-smtpd.c	Wed May 25 09:50:11 2005
+@@ -20,14 +20,52 @@
  #include "now.h"
  #include "exit.h"
  #include "rcpthosts.h"
@@ -20,6 +18,7 @@
 +#define CRAM_MD5
 +#define AUTHSLEEP 5
 +#define RECIPIENTS550
++#define LOCALMFREQAUTH
 +
 +#define MIMETYPE_LEN 9
 +#define LOADER_LEN 5
@@ -55,7 +54,7 @@
  int safewrite(fd,buf,len) int fd; char *buf; int len;
  {
    int r;
-@@ -48,9 +85,6 @@
+@@ -48,9 +86,6 @@
  void die_control() { out("421 unable to read controls (#4.3.0)\r\n"); flush(); _exit(1); }
  void die_ipme() { out("421 unable to figure out my IP addresses (#4.3.0)\r\n"); flush(); _exit(1); }
  void straynewline() { out("451 See http://pobox.com/~djb/docs/smtplf.html.\r\n"); flush(); _exit(1); }
@@ -65,7 +64,7 @@
  void err_unimpl() { out("502 unimplemented (#5.5.1)\r\n"); }
  void err_syntax() { out("555 syntax error (#5.5.4)\r\n"); }
  void err_wantmail() { out("503 MAIL first (#5.5.1)\r\n"); }
-@@ -58,6 +92,114 @@
+@@ -58,6 +93,114 @@
  void err_noop() { out("250 ok\r\n"); }
  void err_vrfy() { out("252 send some mail, i'll try my best\r\n"); }
  void err_qqt() { out("451 qqt failure (#4.3.0)\r\n"); }
@@ -180,7 +179,7 @@
  
  
  stralloc greeting = {0};
-@@ -76,6 +218,7 @@
+@@ -76,6 +219,7 @@
    smtp_greet("221 "); out("\r\n"); flush(); _exit(0);
  }
  
@@ -188,7 +187,7 @@
  char *remoteip;
  char *remotehost;
  char *remoteinfo;
-@@ -85,10 +228,30 @@
+@@ -85,10 +229,30 @@
  stralloc helohost = {0};
  char *fakehelo; /* pointer into helohost, or 0 */
  
@@ -220,7 +219,7 @@
  }
  
  int liphostok = 0;
-@@ -97,6 +260,39 @@
+@@ -97,6 +261,40 @@
  stralloc bmf = {0};
  struct constmap mapbmf;
  
@@ -248,6 +247,7 @@
 +char *localmfcheck;
 +char *mfdnscheck;
 +char *reqauth;
++char *localmf_reqauth;
 +
 +int maxrcptcount = 0;
 +int flaglocal = -1;
@@ -260,7 +260,7 @@
  void setup()
  {
    char *x;
-@@ -111,17 +307,24 @@
+@@ -111,17 +309,24 @@
    if (timeout <= 0) timeout = 1;
  
    if (rcpthosts_init() == -1) die_control();
@@ -286,7 +286,7 @@
    remoteip = env_get("TCPREMOTEIP");
    if (!remoteip) remoteip = "unknown";
    local = env_get("TCPLOCALHOST");
-@@ -131,11 +334,70 @@
+@@ -131,11 +336,76 @@
    if (!remotehost) remotehost = "unknown";
    remoteinfo = env_get("TCPREMOTEINFO");
    relayclient = env_get("RELAYCLIENT");
@@ -338,6 +338,12 @@
 +  qhpsi = env_get("QHPSI");
 +  if (!qhpsi) qhpsi = "unknown";
 +
++#ifdef LOCALMFREQAUTH
++  localmf_reqauth = env_get("LOCALMFREQAUTH");
++#else
++  localmf_reqauth = 0;
++#endif
++
 +#ifdef RELAYMAILFROM
 +  if (!relayclient) {
 +    relaymailfromok = control_readfile(&relaymailfrom,"control/relaymailfrom",0);
@@ -358,7 +364,7 @@
  
  int addrparse(arg)
  char *arg;
-@@ -151,12 +413,17 @@
+@@ -151,12 +421,17 @@
    i = str_chr(arg,'<');
    if (arg[i])
      arg += i + 1;
@@ -376,17 +382,12 @@
  
    /* strip source route */
    if (*arg == '@') while (*arg) if (*arg++ == ':') break;
-@@ -199,12 +466,105 @@
+@@ -199,12 +474,105 @@
  
  int bmfcheck()
  {
 +  int i;
-   int j;
--  if (!bmfok) return 0;
--  if (constmap(&mapbmf,addr.s,addr.len - 1)) return 1;
--  j = byte_rchr(addr.s,addr.len,'@');
--  if (j < addr.len)
--    if (constmap(&mapbmf,addr.s + j,addr.len - j - 1)) return 1;
++  int j;
 +  int k = 0;
 +  char subvalue;
 +
@@ -436,7 +437,12 @@
 +int bhelocheck()
 +{
 +  int i;
-+  int j;
+   int j;
+-  if (!bmfok) return 0;
+-  if (constmap(&mapbmf,addr.s,addr.len - 1)) return 1;
+-  j = byte_rchr(addr.s,addr.len,'@');
+-  if (j < addr.len)
+-    if (constmap(&mapbmf,addr.s + j,addr.len - j - 1)) return 1;
 +  int k = 0;
 +  char subvalue;
 + 
@@ -487,7 +493,7 @@
    return 0;
  }
  
-@@ -216,54 +576,204 @@
+@@ -216,54 +584,215 @@
    return r;
  }
  
@@ -582,6 +588,16 @@
 +    }
 +}
 +
++int mailfromallowed()
++{
++  int r;
++
++  r = rcpthosts(mailfrom.s,strlen(mailfrom.s));
++  if (r == -1) die_control();
++
++  return ((r == 1) ? 0 : 1);
++}
++
 +#ifdef RELAYMAILFROM
 +int rmfcheck()
 +{
@@ -664,6 +680,7 @@
 +    if (flagbarf) { err_bmf("Reject::ORIG::Bad_Mailfrom:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); return; }
 +    if (flagdnsmf > 0) { err_mfdns("Reject::ORIG::DNS_MF:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); return; }
 +    if (reqauth) if (!flagauth) { err_authreq("Reject::ORIG::Missing_Auth:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); return; }
++    if (localmf_reqauth && !flagauth && !mailfromallowed()) { err_authreq("Reject::ORIG::Local_MailFrom_Req_Auth:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); return; }
 +    flagrcpt = rcptallowed();
 +    if (!flagrcpt) { err_recipient("Reject::RCPT::Failed_Rcptto:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); flagerrcpts++; return; } 
 +    if (tarpitcount && flagerrcpts >= tarpitcount) { err_rcpts("Reject::RCPT::Toomany_Rcptto:",remoteip,remotehost,helohost.s,mailfrom.s,addr.s); return; }
@@ -702,7 +719,7 @@
  
  int saferead(fd,buf,len) int fd; char *buf; int len;
  {
-@@ -279,11 +789,69 @@
+@@ -279,11 +808,69 @@
  substdio ssin = SUBSTDIO_FDBUF(saferead,0,ssinbuf,sizeof ssinbuf);
  
  struct qmail qqt;
@@ -773,7 +790,7 @@
    if (bytestooverflow)
      if (!--bytestooverflow)
        qmail_fail(&qqt);
-@@ -316,8 +884,8 @@
+@@ -316,8 +903,8 @@
          if (flagmaybex) if (pos == 7) ++*hops;
          if (pos < 2) if (ch != "\r\n"[pos]) flagmaybey = 0;
          if (flagmaybey) if (pos == 1) flaginheader = 0;
@@ -783,7 +800,7 @@
        if (ch == '\n') { pos = 0; flagmaybex = flagmaybey = flagmaybez = 1; }
      }
      switch(state) {
-@@ -373,31 +941,275 @@
+@@ -373,31 +960,275 @@
    if (!seenmail) { err_wantmail(); return; }
    if (!rcptto.len) { err_wantrcpt(); return; }
    seenmail = 0;
@@ -996,7 +1013,7 @@
 +
 +  if (!user.len || !pass.len) return err_input();
 +  return authenticate();
-+}
+ }
 +#endif
 +
 +struct authcmd {
@@ -1051,10 +1068,10 @@
 +    case 1:
 +      err_authfail("Reject::ORIG::Failed_Auth:",remoteip,remotehost,helohost.s,user.s,authcmds[i].text);
 +  }
- }
- 
-+/* this file is too long --------------------------------------------- GO ON */
++}
 +
++/* this file is too long --------------------------------------------- GO ON */
+ 
  struct commands smtpcommands[] = {
    { "rcpt", smtp_rcpt, 0 }
  , { "mail", smtp_mail, 0 }
@@ -1063,7 +1080,7 @@
  , { "quit", smtp_quit, flush }
  , { "helo", smtp_helo, flush }
  , { "ehlo", smtp_ehlo, flush }
-@@ -408,8 +1220,11 @@
+@@ -408,8 +1239,11 @@
  , { 0, err_unimpl, flush }
  } ;
  
