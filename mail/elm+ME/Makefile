# New ports collection makefile for:	elm ME+ (unofficial Elm)
# Date created:		26 June 1995
# Whom:			ache
#
# $FreeBSD$
#

PORTNAME=	elm+ME
PORTVERSION=	2.4.92
CATEGORIES=	mail
DISTNAME=	${PORTNAME:S/+ME//}-${PORTVERSION:R}ME+${PORTVERSION:E}

# here are the main repositories.
MASTER_SITES=	ftp://ftp.ozone.fmi.fi/KEH/ \
		http://www.ozone.fmi.fi/KEH/

# the following repositories conform to the main repository.
MASTER_SITES+=	ftp://ftp.lip6.fr/pub/unix/mail/elm-me/ \
		ftp://ftp.tu-darmstadt.de/pub/networking/mail/elm+ME/ \
		ftp://ftp.cs.tu-berlin.de/pub/net/mail/elm-me-plus/ \
		ftp://ftp.ntua.gr/pub/net/mail/elm-me/ \
		ftp://ftp.eos.hokudai.ac.jp/pub/network/mail/elm-2.4ME+/ \
		ftp://ftp.win.ne.jp/pub/network/mail/elm-2.4ME+/

# the following repositories maybe conform to the main repository.
MASTER_SITES+=	ftp://ftp.unina.it/pub/Unix/pkgs/network/mail/elm-me+/ \
		ftp://ftp.rge.com/pub/mail/elm/elm-2.4ME+/ \
		ftp://ftp.uni-trier.de/pub/unix/network/mail/elm-me+/

MAINTAINER=	clefevre@citeweb.net

# not needed since config.sh is generated by scripts/pre-configure.
# BUILD_DEPENDS=	ispell:${PORTSDIR}/textproc/ispell
# BUILD_DEPENDS=	metamail:${PORTSDIR}/mail/metamail
# BUILD_DEPENDS=	pgp:${PORTSDIR}/security/pgp
# BUILD_DEPENDS=	gpg:${PORTSDIR}/security/gnupg

#
# Global variables
#

WRKSRC=		${WRKDIR}/${DISTNAME:S/-//:S/ME+/.ME+./}

HAS_CONFIGURE=	yes

CONFIGURE_SCRIPT=	Configure
SCRIPTS_ENV=	CFLAGS="${CFLAGS}" ${PLIST_SUB} \
		PREFIX="${PREFIX}" MAN1PREFIX="${MAN1PREFIX}"
CONFIGURE_ARGS=	-S -P ${PREFIX}

MAKE_ARGS=	MJ="FORMATTER=groff FORMATTER_OPTS=-Tlatin1"
ALL_TARGET=	all documentation

PLIST_SUB=	SO_REV="${SO_REV}" DOC_SUBDIR="${DOC_SUBDIR}" \
		LIB_SUBDIR="${LIB_SUBDIR}" SHLIB_SUBDIR="${SHLIB_SUBDIR}"

MAN1=		answer.1 checkalias.1 elm.1 elmalias.1 elmcharset.1 \
		elmterminal.1 elmunidata.1 fastmail.1 frm.1 listalias.1 \
		messages.1 newalias.1 newmail.1 printmail.1 readmsg.1
MLINKS=		frm.1 nfrm.1	newmail.1 wnewmail.1

#
# Local variables
#

SO_REV=		`${AWK} '/SHAREDTAG:/{print $$2}' ${WRKSRC}/hdrs/patchlevel.h`
MSECS=		1

RCD_SUBDIR=	etc/rc.d
LIB_SUBDIR=	lib/elm
SHLIB_SUBDIR=	libexec/elm
DOC_SUBDIR=	share/doc/elm

RCD_FILE=	00elm.sh
MIME_TYPES=	elm.mimetypes
DOC_FILES=	README.ME+ shared_libs/tls/README.TLS \
		doc/Alias.fmtd doc/Config.fmtd doc/Cover.fmtd \
		doc/Form.fmtd doc/Ref.fmtd doc/Users.fmtd

AWK?=		awk

#
# Post-patch
#

post-patch: patch-install-script patch-setgid patch-nls-files

patch-install-script:
	@${SED} -e 's,%%SHLIB_SUBDIR%%,${SHLIB_SUBDIR},' \
		${FILESDIR}/${RCD_FILE} > ${WRKSRC}/${RCD_FILE}

# d_savegrpmboxid is currently broken using setgid(2) instead of setegid(2).
# will probably be fixed in a next release, for instance, fake a patch.
# the alternative would be to disable this option in pre-configure script.
patch-setgid:
	@${PERL} -pi.fbsd -e 's,setgid,setegid,' \
		${WRKSRC}/lib/localmbx.c \
		${WRKSRC}/src/init.c ${WRKSRC}/src/lock.c

patch-nls-files:
	@${PERL} -pi.fbsd -e 's,/usr/local,${PREFIX},' ${WRKSRC}/nls/LANGS

#
# Post-install
#

post-install: install-startup-files install-nls-files \
	      install-doc-files install-mime-types \
	      remove-catman-files remove-catman-links

install-startup-files:
	@${INSTALL_SCRIPT} ${WRKSRC}/${RCD_FILE} ${PREFIX}/${RCD_SUBDIR}

install-nls-files:
	@cd ${WRKSRC}/nls; ${MAKE} install

install-doc-files:
.if !defined(NOPORTSDOC)
	@${MKDIR} ${PREFIX}/${DOC_SUBDIR}
.for file in ${DOC_FILES}
	@${INSTALL_DATA} ${WRKSRC}/${file} ${PREFIX}/${DOC_SUBDIR}
	@${GZIP_CMD} ${PREFIX}/${DOC_SUBDIR}/${file:T}
.endfor
.endif

install-mime-types:
	@${INSTALL_DATA} ${FILESDIR}/${MIME_TYPES} \
		${PREFIX}/${LIB_SUBDIR}/${MIME_TYPES}-dist
	@if [ ! -f ${PREFIX}/${LIB_SUBDIR}/${MIME_TYPES} ]; then \
		${INSTALL_DATA} ${FILESDIR}/${MIME_TYPES} \
			${PREFIX}/${LIB_SUBDIR}; \
	fi

remove-catman-files:
.for sect in ${MSECS}
.for page in ${MAN${sect}}
	@${RM} -f ${MAN${sect}PREFIX}/man/cat${sect}/${page}
.endfor
.endfor

remove-catman-links:
.for sect in ${MSECS}
.for page in ${MLINKS}
.if ${MAN${sect}:M${page}} == ""
	@${RM} -f ${MAN${sect}PREFIX}/man/cat${sect}/${page}
.endif
.endfor
.endfor

.include <bsd.port.pre.mk>

# some sketchy hackery
FETCH_CMD_INTERIOR=	${FETCH_CMD:M*fetch*}

# only enable the hack if FETCH_CMD is fetch
.if !empty(FETCH_CMD_INTERIOR)

# lip6 dislike $USER@localhost...
FETCH_ENV=	FTP_PASSWORD=${FTP_PASSWORD}

AWK?=		awk
IFCONFIG?=	ifconfig

# well, this is a hack to make fetch happy on lip6, ugh!
HOSTIPADDR=	${IFCONFIG} | ${AWK} '/inet /{print $$2; exit}'
FTP_PASSWORD?=	${USER}@`${HOSTIPADDR}`
.endif

.include <bsd.port.post.mk>
