#!/bin/sh

#set -vx

PKG_BATCH=${BATCH:=NO}

PKG_PREFIX=${PKG_PREFIX:=/usr/local}

#
# create 'cyrus' user and group before installing
#

create() {
	if [ ! -x /usr/sbin/pw ]; then
		echo "*** Please add a user and a group named \`cyrus' before installing this package."
		exit 69
	fi

	if ! pw show group cyrus -q >/dev/null; then
		gid=60
		while pw show group -g ${gid} -q >/dev/null; do
			gid=`expr ${gid} + 1`
		done
		if ! pw add group cyrus -g ${gid}; then
			e=$?
			echo "*** Failed to add group \`cyrus'. Please add it manually."
			exit ${e}
		fi
		echo "*** Added group \`cyrus' (id ${gid})"
	else
		gid=`pw show group cyrus 2>/dev/null | cut -d: -f3`
	fi

	if [ -x /sbin/nologin ]; then
		shell=/sbin/nologin
	else
		shell=/nonexistent
	fi
	if ! pw show user cyrus -q >/dev/null; then
		uid=60
		while pw show user -u ${uid} -q >/dev/null; do
			uid=`expr ${uid} + 1`
		done
		if ! pw add user cyrus -u ${uid} -g ${gid} -d "/nonexistent" \
				-c "the cyrus mail server" -s "${shell}" -p "*" \
				; then
			e=$?
			echo "*** Failed to add user \`cyrus'. Please add it manually."
			exit ${e}
		fi
		echo "*** Added user \`cyrus' (id ${uid})"
	else
		if ! pw mod user cyrus -g ${gid} -d "/nonexistent" \
				-c "the cyrus mail server" -s "${shell}" -p "*" \
				; then
			e=$?
			echo "*** Failed to update user \`cyrus'."
			exit ${e}
		fi
		echo "*** Updated user \`cyrus'."
	fi
	if ! pw group mod cyrus -m daemon; then
		echo "*** can't add user \`daemon' to group \`cyrus'"
	fi
}


checkfile() {
	diff -bBqw $1 $1.dist >/dev/null 2>&1
	case $? in
		0)	# config file exists, but is the same
			;;
		1)	# config file exists and differs
			echo "** Make sure $1 is in sync with this version"; 
			echo "   of the port.  See $1.dist for details."; 
			;;
		*)	# no config file exists, copy it
			install -c -m 644 $1.dist $1
			;;
	esac
}

# Install timseived's Cyrus.conf file

cyrus_conf() {
        if [ ! -f ${PKG_PREFIX}/lib/sasl/Cyrus.conf ]; then
                echo "pwcheck_method: pwcheck" > ${PKG_PREFIX}/lib/sasl/Cyrus.conf
        fi
}

case $2 in
	PRE-INSTALL)
		create
		;;

	POST-INSTALL)
		cd ${PKG_PREFIX}
		cyrus_conf
		checkfile ${PKG_PREFIX}/etc/imapd.conf
		if grep '^imap4' /etc/inetd.conf; then
			echo "** Please check that your /etc/inetd.conf entry for \`imap4'"
			echo "   is suitable for the Cyrus IMAP server."
		else
			echo "** Please add an entry for the imap4 protocol to /etc/inetd.conf."
		fi
		echo
		if grep '^sieve' /etc/inetd.conf; then
			echo "** Please check that your /etc/inetd.conf entry for \`sieve'"
			echo "   is suitable for the Cyrus timsieved daemon"
		else
			echo "** Please add an entry for timseived to /etc/inetd.conf."
			echo "   If you wish to have user's upload their sieve filter"
			echo "   scripts to the server."
		fi
		echo
		echo "   An example can be found in ${PKG_PREFIX}/etc/inetd.conf.cyrus."
		if grep 'sieve' /etc/services; then
			echo
		else
			echo
			echo "** Please add an entry for the sieve protocol (2000/tcp)"
			echo "   to /etc/services"
			echo
		fi
		;;
esac
