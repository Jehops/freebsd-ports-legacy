#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: milterdk
# REQUIRE: DAEMON
# BEFORE: sendmail
# KEYWORD: shutdown

# Define these milterdk_* variables in one of these files:
#	/etc/rc.conf
#	/etc/rc.conf.local
#	/etc/rc.conf.d/milterdk
#
# DO NOT CHANGE THESE DEFAULT VALUES HERE
#
milterdk_enable=${milterdk_enable:-"NO"}
milterdk_socket=${milterdk_socket:-"local:/var/run/dk-filter"}
milterdk_pid=${milterdk_pid:-"/var/run/dk-filter.pid"}
milterdk_domain=${milterdk_domain:-"example.com"}
milterdk_key=${milterdk_key:-"/var/db/domainkeys/default.key.pem"}
milterdk_flags=${milterdk_flags:-"-d ${milterdk_domain} -c nofws -H -m MSA \
-s ${milterdk_key} -S default"}

. %%RC_SUBR%%

name="milterdk"
pidfile=${milterdk_pid}
rcvar=`set_rcvar`
command="%%PREFIX%%/libexec/dk-filter"
command_args="-l -p ${milterdk_socket} -P ${milterdk_pid}"
stop_postcmd="dk_postcmd"

load_rc_config $name

dk_postcmd ()
{
    if [ -S ${milterdk_socket##local:} ] ; then
        rm -f ${milterdk_socket##local:}
    elif [ -S ${milterdk_socket##unix:} ] ; then
        rm -f ${milterdk_socket##unix:}
    fi
}

run_rc_command "$1"
