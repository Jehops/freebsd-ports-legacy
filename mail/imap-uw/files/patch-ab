--- src/osdep/unix/Makefile.orig	Thu Jul 16 14:12:22 1998
+++ src/osdep/unix/Makefile	Mon Oct 12 19:21:56 1998
@@ -88,12 +88,12 @@
 
 # Normally no need to change any of these
 
-ARCHIVE=c-client.a
+ARCHIVE=libc-client.a
 BINARIES=mail.o misc.o newsrc.o smanager.o osdep.o utf8.o siglocal.o \
  dummy.o pseudo.o netmsg.o flstring.o fdstring.o \
  rfc822.o nntp.o smtp.o imap4r1.o pop3.o \
  unix.o mbox.o mbx.o mmdf.o tenex.o mtx.o news.o phile.o mh.o mx.o
-CFLAGS=$(BASECFLAGS) $(EXTRACFLAGS)
+CFLAGS+=$(BASECFLAGS) $(EXTRACFLAGS)
 MAKE=make
 MV=mv
 RM=rm -rf
@@ -108,6 +108,15 @@
  PASSWDTYPE=$(PASSWDTYPE) AFSDIR=$(AFSDIR) GSSDIR=$(GSSDIR)
 BUILD=$(MAKE) build $(BUILDOPTIONS) $(EXTRASPECIALS)
 
+# Need this for the shared library rule to work correctly
+.SUFFIXES: .o .so
+.if ${PORTOBJFORMAT} == "elf"
+SHLIB=libc-client.so.2
+.else
+SHLIB=libc-client.so.2.1
+.endif
+SOFILES=${BINARIES:.o=.so}
+
 # Here if no make argument established
 
 missing: osdep.h
@@ -179,11 +188,11 @@
 	 BASECFLAGS="-g -Dconst= -DNFSKLUDGE"
 
 bsf:	# FreeBSD
-	$(BUILD) OS=bsi SIGTYPE=psx \
+	$(BUILD) $(SHLIB) OS=bsi SIGTYPE=psx \
 	 SPOOLDIR=/var \
 	 ACTIVEFILE=/usr/local/news/lib/active \
 	 RSHPATH=/usr/bin/rsh \
-	 BASECFLAGS="-g -O -pipe -DNFSKLUDGE" \
+	 BASECFLAGS="-DNFSKLUDGE -DIGNORE_LOCK_EACCES_ERRORS" \
 	 BASELDFLAGS="-lcrypt"
 
 bsi:	# BSD/i386
@@ -565,10 +574,21 @@
 	@cat ARCHIVE
 	@$(SH) ARCHIVE
 
+$(SHLIB): $(SOFILES)
+.if $(PORTOBJFORMAT) == "elf"
+	ld -Bshareable -x -o $(SHLIB) $(SOFILES)
+.else
+	ld -Bshareable -x -soname $(SHLIB) -o $(SHLIB) $(SOFILES)
+.endif
+
+.c.so:	osdep.h
+	$(CC) -fpic -DPIC -c $(CFLAGS) ${@:.so=.c} -o $@
+
 # Cleanup
 
 clean:
 	sh -c '$(RM) auths.c flockbsd.c linkage.[ch] siglocal.c osdep*.[ch] *.o ARCHIVE *FLAGS *TYPE $(ARCHIVE) || true'
+	$(RM) *.so $(SHLIB)
 
 
 # Dependencies
@@ -602,7 +622,7 @@
 
 # OS-dependent
 
-osdep.o:mail.h misc.h env.h fs.h ftl.h nl.h tcp.h \
+OSDEPS= mail.h misc.h env.h fs.h ftl.h nl.h tcp.h \
 	osdep.h env_unix.h tcp_unix.h \
 	osdep.c env_unix.c fs_unix.c ftl_unix.c nl_unix.c tcp_unix.c \
 	auths.c flock.c flockbsd.c flcksafe.c fsync.c gethstid.c \
@@ -614,7 +634,12 @@
 	write.c \
 	strerror.c strpbrk.c strstr.c strtok.c strtoul.c \
 	OSCFLAGS
+
+osdep.o: $(OSDEPS)
 	$(CC) $(CFLAGS) `cat OSCFLAGS` -c osdep.c
+
+osdep.so: $(OSDEPS)
+	$(CC) $(CFLAGS) `cat OSCFLAGS` -c osdep.c -o $@ -fpic -DPIC
 
 osdep.c: osdepbas.c osdepckp.c osdeplog.c
 	sh -c '$(RM) osdep.c || true'
