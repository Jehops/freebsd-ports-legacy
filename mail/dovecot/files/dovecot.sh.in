#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: dovecot
# REQUIRE: %%REQUIRE%%
# KEYWORD: shutdown

# Define these dovecot_* variables in one of these files:
#	/etc/rc.conf
#	/etc/rc.conf.local
#	/etc/rc.conf.d/dovecot
#
# DO NOT CHANGE THESE DEFAULT VALUES HERE
#
: ${dovecot_enable:="NO"}

. %%RC_SUBR%%

name=dovecot
rcvar=`set_rcvar`

command=%%PREFIX%%/sbin/${name}
required_files=%%PREFIX%%/etc/${name}.conf
start_precmd="${name}_prestart"
extra_commands="restart"

dovecot_prestart()
{	# Ensure runtime directories exist with correct permissions
	local base user gid
	base=/var/run/${name}
	user=$(/usr/bin/awk -F '[[:space:]]*=[[:space:]]*' '/^[[:space:]]*login_user[[:space:]]*=/ { print $2 }' ${required_files})
	gid=$(/usr/sbin/pw usershow -n "${user:-${name}}" 2>/dev/null | /usr/bin/cut -d: -f4)
	/usr/bin/install -o root -g wheel -m 0755 -d ${base}
	/usr/bin/install -o root -g ${gid} -m 0750 -d ${base}/login
}

load_rc_config ${name}
run_rc_command "$1"
