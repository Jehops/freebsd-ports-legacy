#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: dovecot
# REQUIRE: %%REQUIRE%%
# KEYWORD: shutdown

# Define dovecot_* variables in one of these files:
#	/etc/rc.conf
#	/etc/rc.conf.local
#	/etc/rc.conf.d/dovecot

. %%RC_SUBR%%

name=dovecot
rcvar=`set_rcvar`

# read configuration and set defaults
load_rc_config ${name}
: ${dovecot_enable:="NO"}

command="%%PREFIX%%/sbin/${name}"
command_args="-c ${dovecot_config:="%%PREFIX%%/etc/${name}.conf"}"
required_files="${dovecot_config}"
start_precmd="start_precmd"
stop_postcmd="stop_postcmd"
extra_commands="restart"

base_dir=$(${command} ${command_args} -a | /usr/bin/awk -F ': ' '/^base_dir:/ { print $2 }')
login_dir=$(${command} ${command_args} -a | /usr/bin/awk -F ': ' '/^login_dir:/ { print $2 }')
login_user=$(${command} ${command_args} -a | /usr/bin/awk -F ': ' '/^login_user:/ { print $2 }')

pidfile="${base_dir}/master.pid"

start_precmd()
{	# Ensure runtime directories exist with correct permissions
	local gid
	gid=$(/usr/sbin/pw usershow -n "${login_user}" 2>/dev/null | /usr/bin/cut -d: -f4)
	/usr/bin/install -o root -g wheel -m 0755 -d ${base_dir}
	/usr/bin/install -o root -g ${gid} -m 0750 -d ${login_dir}
}

stop_postcmd()
{	# Cleanup runtime directories
	rm -rf ${base_dir} 2>/dev/null
}

run_rc_command "$1"
