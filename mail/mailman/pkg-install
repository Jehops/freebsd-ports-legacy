#! /bin/sh
#
# $FreeBSD$

make_account() {
  local u uid g gid gcos home shell

  u=$1
  uid=$2
  g=$3
  gid=$4
  gcos=$5
  home=$6
  shell=$7

  if pw group show "${g}" >/dev/null 2>&1; then
    echo "You already have a group \"${g}\", so I will use it."
  else
    echo -n "Adding group \"${g}\" (${gid})... "
    if which -s pw; then
      pw groupadd ${g} -g ${gid} || exit
      echo "done."
    else
      exit 1
    fi
  fi

  if pw user show "${u}" >/dev/null 2>&1; then
    echo "You already have a user \"${u}\", so I will use it."
  else
    echo -n "Adding user \"${u}\" (${uid})... "
    if which -s pw; then
      pw useradd ${u} -u ${uid} -g ${g} -h - -d ${home} \
        -s ${shell} -c "${gcos}" || exit
      echo "done."
    else
      exit 1
    fi
  fi

  if [ x"$home" != x ]; then
    if [ ! -d "${home}" ]; then
      echo -n "Creating ${u}'s home directory (${home})... "
      (umask 002 && mkdir -p ${home}) || exit
      chown -R ${u}:${g} ${home} || exit
      chmod g+s ${home} || exit
      echo "done."
    fi
  fi
}

create_crontab() {
  local u file

  u=$1
  file=$2

  echo -n "Creating crontab(5) file for Mailman user... "
  crontab -u ${u} ${file} || exit
  echo "done."

}

fix_perms() {
  echo -n "Checking (and fixing) permissions... "
  %%MAILMANDIR%%/bin/check_perms -f >/dev/null 2>&1
  echo "done."
}

case $2 in

PRE-INSTALL)
  make_account %%USER%% %%UID%% %%GROUP%% %%GID%% \
    "Mailman User" "%%MAILMANDIR%%" "/sbin/nologin"
  ;;

POST-INSTALL)
  create_crontab %%USER%% "%%MAILMANDIR%%/cron/crontab.in"
  fix_perms
  ;;
esac
