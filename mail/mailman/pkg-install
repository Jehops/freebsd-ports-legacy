#! /bin/sh

make_account() {
    local u uid g gid gcos home shell

    u=$1
    uid=$2
    g=$3
    gid=$4
    gcos=$5
    home=$6
    shell=$7

    if pw group show "${g}" >/dev/null 2>&1; then
	echo "You already have a group \"${g}\", so I will use it."
    else
	echo -n "Adding group \"${g}\" (${gid})... "
	if which -s pw; then
	    pw groupadd ${g} -g ${gid} || exit
	    echo "done."
	else
	    exit 1
	fi
    fi
    
    if pw user show "${u}" >/dev/null 2>&1; then
	echo "You already have a user \"${u}\", so I will use it."
    else
	echo -n "Adding user \"${u}\" (${uid})... "
	if which -s pw; then
	    pw useradd ${u} -u ${uid} -g ${g} -h - -d ${home} \
		-s ${shell} -c "${gcos}" || exit
	    echo "done."
	else
	    exit 1
	fi
    fi

    if [ x"$home" != x ]; then
	if [ ! -d "${home}" ]; then
	    echo -n "Creating ${u}'s home directory (${home})... "
	    (umask 002 && mkdir -p ${home}) || exit
	    chown -R ${u}:${g} ${home} || exit
	    chmod g+s ${home} || exit
	    echo "done."
	fi
    fi
}

case $2 in

PRE-INSTALL)
    if which -s pw && which -s lockf; then
	:
    else
	cat <<EOF

This system looks like a pre-2.2 version of FreeBSD.  I see that it
is missing the "lockf" and/or "pw" utilities.  I need these utilities.
Please get them and install them, and try again.  You can get the
sources from:

  ftp://ftp.freebsd.org/pub/FreeBSD/FreeBSD-current/src/usr.bin/lockf.tar.gz
  ftp://ftp.freebsd.org/pub/FreeBSD/FreeBSD-current/src/usr.sbin/pw.tar.gz

EOF
	exit 1
    fi

    make_account %%USER%% %%UID%% %%GROUP%% %%GID%% \
        "Mailman User" "%%MAILMANDIR%%" "/sbin/nologin"
    ;;
esac
