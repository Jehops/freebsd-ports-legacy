# New ports collection makefile for:		cyrus
# Version required:				1.5.19
# Date created:					May 4th 1997
# Whom:						jfitz@FreeBSD.org
#
# $FreeBSD$
#

DISTNAME=	cyrus-imapd-v1.5.19
PKGNAME=	cyrus-1.5.19
CATEGORIES=	mail tcl80
MASTER_SITES=	ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/ \
		http://www.freebsd.org/~stb/mirror/ftp.andrew.cmu.edu/pub/cyrus-mail/ \
		ftp://ftp.hanse.de/sites/transit/mirror/ftp.andrew.cmu.edu/pub/cyrus-mail/

MAINTAINER=	stb@FreeBSD.org

Y2K=		http://andrew2.andrew.cmu.edu/cyrus/imapd/y2k.html

LIB_DEPENDS=	tcl80.1:${PORTSDIR}/lang/tcl80
BUILD_DEPENDS=	makedepend:${PORTSDIR}/devel/makedepend

GNU_CONFIGURE=	YES
CONFIGURE_ARGS=	--with-cyrus-prefix=${PREFIX}/cyrus \
		--with-cyrus-group=cyrus \
		--with-login=unix_pwcheck \
		--with-tclsh=${PREFIX}/bin/tclsh8.0 \
		--with-auth=unix \
		--with-com-err

MAN1=		cyradm.1
MAN3=		imclient.3
MAN5=		imapd.conf.5
MAN8=		arbitron.8 collectnews.8 cyrquota.8 deliver.8 imapd.8 \
		pop3d.8 reconstruct.8 rmnews.8 syncnews.8

post-configure:
		@ ${SETENV} ${MAKE_ENV} perl -pi -e 's|%%PREFIX%%|${PREFIX}|' ${WRKSRC}/imap/config.c ${WRKSRC}/imap/krbck.c

pre-install:
		@ ${CP} ${WRKSRC}/man/quota.8 ${WRKSRC}/man/cyrquota.8
		@${PKGDIR}/INSTALL ${PKGNAME} PRE-INSTALL

DOCS=	README acl-extension anoncvs bugs changes copyrights install \
	mailing-list overview quota-extension server-design
HTDOCS=	anoncvs bugs changes index install mailing-list overview \
	readme unpack
post-install:
		@ ${MV} ${PREFIX}/cyrus/bin/quota ${PREFIX}/cyrus/bin/cyrquota
.if !defined(NOPORTDOCS)
		${MKDIR} ${PREFIX}/share/doc/cyrus/html
.for file in ${DOCS}
		${INSTALL_DATA} ${WRKSRC}/doc/${file} \
			${PREFIX}/share/doc/cyrus
		@${ECHO} share/doc/cyrus/${file} >>${TMPPLIST}
.endfor
.for file in ${HTDOCS}
		${INSTALL_DATA} ${WRKSRC}/doc/html/${file}.html \
			${PREFIX}/share/doc/cyrus/html
		@${ECHO} share/doc/cyrus/html/${file}.html >>${TMPPLIST}
.endfor
		@${ECHO} "@dirrm share/doc/cyrus/html"
		@${ECHO} "@dirrm share/doc/cyrus"
.endif
		${INSTALL_DATA} ${FILESDIR}/imapd.conf \
			${PREFIX}/etc/imapd.conf.dist
		${INSTALL_DATA} ${FILESDIR}/inetd.conf.cyrus \
			${PREFIX}/etc/
		${INSTALL} -d -m 750 -o cyrus -g cyrus /var/spool/imap \
			${PREFIX}/etc/imap \
			${PREFIX}/etc/imap/user \
			${PREFIX}/etc/imap/quota \
			${PREFIX}/etc/imap/proc \
			${PREFIX}/etc/imap/log \
			${PREFIX}/etc/imap/msg
		${INSTALL} -d -m 700 -o cyrus -g cyrus /var/pwcheck
		${TOUCH} ${PREFIX}/etc/imap/mailboxes
		${CHMOD} 640 ${PREFIX}/etc/imap/mailboxes
		@${SED} -e "/%%PREFIX%%/s##${PREFIX}#g" ${FILESDIR}/cyrus.sh \
			>${PREFIX}/etc/rc.d/cyrus.sh
		@${CHMOD} 0755 ${PREFIX}/etc/rc.d/cyrus.sh
		@PKG_PREFIX=${PREFIX} ${PKGDIR}/INSTALL ${PKGNAME} POST-INSTALL

.include <bsd.port.mk>
