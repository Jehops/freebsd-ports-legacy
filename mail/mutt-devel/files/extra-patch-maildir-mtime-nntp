--- PATCHES Dec 2002 17:44:54 -0000	3.6
+++ PATCHES Feb 2004 13:19:42 -0000
@@ -0,0 +1 @@
+patch-1.5.6.dw.maildir-mtime.1
--- browser.c.orig	Wed Jun 23 12:55:45 2004
+++ browser.c	Wed Jun 23 13:00:45 2004
@@ -30,6 +30,7 @@
 #ifdef USE_NNTP
 #include "nntp.h"
 #endif
+#include "mx.h"
 
 #include <stdlib.h>
 #include <dirent.h>
@@ -424,8 +425,10 @@
 
 static void add_folder (MUTTMENU *m, struct browser_state *state,
 			const char *name, const struct stat *s,
-			void *data, int new)
+			void *data, BUFFY *mbuf)
 {
+  int new = (mbuf) ? mbuf->new : 0;
+
   if (state->entrylen == state->entrymax)
   {
     /* need to allocate more space */
@@ -437,6 +440,9 @@
       m->data = state->entry;
   }
 
+  if (mbuf && mbuf->magic == M_MAILDIR && mbuf->mtime)
+    s->st_mtime = mbuf->mtime;
+
   if (s != NULL)
   {
     (state->entry)[state->entrylen].mode = s->st_mode;
@@ -495,7 +501,7 @@
 	continue;
       if (!((regexec (Mask.rx, data->group, 0, NULL, 0) == 0) ^ Mask.not))
 	continue;
-      add_folder (menu, state, data->group, NULL, data, data->new);
+      add_folder (menu, state, data->group, NULL, data, tmp);
     }
   }
   else
@@ -561,7 +567,7 @@
     tmp = Incoming;
     while (tmp && mutt_strcmp (buffer, tmp->path))
       tmp = tmp->next;
-    add_folder (menu, state, de->d_name, &s, NULL, (tmp) ? tmp->new : 0);
+    add_folder (menu, state, de->d_name, &s, NULL, tmp);
   }
   closedir (dp);
   }
@@ -589,7 +595,7 @@
     {
       if ((data = (NNTP_DATA *) tmp->data) != NULL && (data->new ||
 	  (data->subscribed && (!option (OPTSHOWONLYUNREAD) || data->unread))))
-      add_folder (menu, state, data->group, NULL, data, data->new);
+      add_folder (menu, state, data->group, NULL, data, tmp);
     }
   }
   else
@@ -608,21 +614,21 @@
 #ifdef USE_IMAP
       if (mx_is_imap (tmp->path))
       {
-	add_folder (menu, state, tmp->path, NULL, NULL, tmp->new);
+	add_folder (menu, state, tmp->path, NULL, NULL, tmp);
 	continue;
       }
 #endif
 #ifdef USE_POP
       if (mx_is_pop (tmp->path))
       {
-	add_folder (menu, state, tmp->path, NULL, NULL, tmp->new);
+	add_folder (menu, state, tmp->path, NULL, NULL, tmp);
 	continue;
       }
 #endif
 #ifdef USE_NNTP
       if (mx_is_nntp (tmp->path))
       {
-	add_folder (menu, state, tmp->path, NULL, NULL, tmp->new);
+	add_folder (menu, state, tmp->path, NULL, NULL, tmp);
 	continue;
       }
 #endif
@@ -636,7 +642,7 @@
       strfcpy (buffer, NONULL(tmp->path), sizeof (buffer));
       mutt_pretty_mailbox (buffer);
 
-      add_folder (menu, state, buffer, &s, NULL, tmp->new);
+      add_folder (menu, state, buffer, &s, NULL, tmp);
     }
     while ((tmp = tmp->next));
   }
@@ -1555,7 +1561,7 @@
 		if (regexec (rx, nd->group, 0, NULL, 0) == 0)
 		{
 		  mutt_newsgroup_subscribe (news, nd->group);
-		  add_folder (menu, &state, nd->group, NULL, nd, nd->new);
+		  add_folder (menu, &state, nd->group, NULL, nd, nd);
 		}
 	      }
 	    }
--- buffy.c Feb 2004 17:50:43 -0000	3.9
+++ buffy.c Feb 2004 13:19:42 -0000
@@ -229,2 +229,3 @@ int mutt_parse_mailboxes (BUFFER *path, 
     (*tmp)->newly_created = 0;
+    (*tmp)->mtime = 0;
 
@@ -260,2 +261,3 @@ int mutt_buffy_check (int force)
   struct stat sb;
+  struct stat smd;
   struct dirent *de;
@@ -299,2 +301,3 @@ int mutt_buffy_check (int force)
     tmp->new = 0;
+    tmp->mtime = 0;
 
@@ -383,6 +386,13 @@ int mutt_buffy_check (int force)
 	  {
-	    /* one new and undeleted message is enough */
-	    BuffyCount++;
-	    tmp->new = 1;
-	    break;
+	    if (!tmp->new)
+	    {
+	      /* one new and undeleted message is enough */
+	      BuffyCount++;
+	      tmp->new = 1;
+	    }
+	    snprintf (path, sizeof (path), "%s/new/%s", tmp->path, de->d_name);
+	    if (!stat (path, &smd) && smd.st_mtime > tmp->mtime)
+	    {
+	      tmp->mtime = smd.st_mtime;
+	    }
 	  }
--- buffy.h Dec 2002 11:19:39 -0000	3.2
+++ buffy.h Feb 2004 13:19:42 -0000
@@ -29,2 +29,3 @@ typedef struct buffy_t
   struct buffy_t *next;
+  time_t mtime;			/* for maildirs...time of newest entry */
   short new;			/* mailbox has new mail */
