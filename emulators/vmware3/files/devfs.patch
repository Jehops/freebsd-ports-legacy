--- vmmon-only/freebsd/driver.c.orig	Tue Mar 18 22:11:29 2003
+++ vmmon-only/freebsd/driver.c	Tue Mar 18 22:17:07 2003
@@ -146,29 +146,20 @@
 
 static timeout_t FreeBSD_DriverSelectTimeout;
 
 #define CDEV_MAJOR 200
 #if defined(CDEV_MAJOR_) && CDEV_MAJOR != CDEV_MAJOR_
 #error "CDEV_MAJOR != CDEV_MAJOR_"
 #endif
 
 #define CDEV_MINOR 0
 
-/* static struct cdevsw vmmon_cdevsw = { */
 static struct cdevsw vmmon_cdevsw = {
-	/* open */	FreeBSD_Driver_Open,
-	/* close */	FreeBSD_Driver_Close,
-	/* read */	noread,
-	/* write */	nowrite,
-	/* ioctl */	FreeBSD_Driver_Ioctl,
-	/* poll */	FreeBSD_Driver_Poll,
-	/* mmap */	nommap,
-	/* strategy */	nostrategy,
-	/* name */	DEVICE_NAME,
-	/* maj */	CDEV_MAJOR,
-	/* dump */	nodump,
-	/* psize */	nopsize,
-	/* flags */	0,
-	/* bmaj */	-1
+	.d_open =  	FreeBSD_Driver_Open,
+	.d_close =  	FreeBSD_Driver_Close,
+	.d_ioctl =  	FreeBSD_Driver_Ioctl,
+	.d_poll =  	FreeBSD_Driver_Poll,
+	.d_name =  	DEVICE_NAME,
+	.d_maj =  	CDEV_MAJOR,
 
 
 };
@@ -242,14 +229,9 @@
    sprintf(freebsdState.deviceBuf,DEVICE_NAME);
    freebsdState.major = CDEV_MAJOR;
    freebsdState.minor = CDEV_MINOR;
-   retval = cdevsw_add(&vmmon_cdevsw);
 
 #endif
-   if (retval) {
-      Warning("Module %s: error registering with major=%d minor=%d tag=%s\n", freebsdState.deviceBuf,freebsdState.major, freebsdState.minor, TAGNAME);
-      return ENOENT;
-   }
   vmmon_dev = make_dev(&vmmon_cdevsw, 0 , UID_ROOT, GID_WHEEL, 0600, DEVICE_NAME); 
   HostIF_InitSpinLock();
   Log("Module %s: registered with major=%d minor=%d tag=%s\n", freebsdState.deviceBuf, freebsdState.major, freebsdState.minor, TAGNAME);
    
@@ -273,7 +257,6 @@
    int retval=0;
    
    destroy_dev(vmmon_dev);
-   retval = cdevsw_remove(&vmmon_cdevsw);
    if (retval) {
       Warning("Module %s: error unregistering\n", freebsdState.deviceBuf);
    } else {
