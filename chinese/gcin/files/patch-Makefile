--- ./Makefile.orig	2012-12-08 08:32:13.000000000 +0800
+++ ./Makefile	2014-03-28 20:46:01.000000000 +0800
@@ -94,7 +94,7 @@
 all:	$(PROGS) trad2sim $(GCIN_SO) $(DATA) $(PROGS_CV) gcin.spec gcin-fedora.spec
 	$(MAKE) -C data
 	$(MAKE) -C gtk-im
-	if [ $(BUILD_MODULE) = 'Y' ]; then $(MAKE) -C modules; fi
+	$(MAKE) -C modules
 	if [ $(USE_I18N) = 'Y' ]; then $(MAKE) -C po; fi
 	if [ $(GTK3_IM) = 'Y' ]; then $(MAKE) -C gtk3-im; fi
 	if [ $(QT_IM) = 'Y' ]; then $(MAKE) -C qt-im; fi
@@ -103,18 +103,18 @@
 #gcc_ld_run_path=-Wl,-rpath,$(gcin_ld_run_path)
 
 gcin:   $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV)
-	$(CCLD) $(EXTRA_LDFLAGS) $(gcc_ld_run_path) -o $@ $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV) -lXtst $(LDFLAGS) -L/usr/X11R6/$(LIB)
+	$(CCLD) $(EXTRA_LDFLAGS) $(gcc_ld_run_path) -o $@ $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV) -lXtst $(LDFLAGS) -L/usr/local/$(LIB)
 	rm -f core.* vgcore.*
 	ln -sf $@ $@.test
 
 gcin-nocur:   $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV)
-	$(CCLD) -Wl,-rpath,$(gcinlibdir) $(EXTRA_LDFLAGS) -o $@ $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV) -lXtst $(LDFLAGS) -L/usr/X11R6/$(LIB)
+	$(CCLD) -Wl,-rpath,$(gcinlibdir) $(EXTRA_LDFLAGS) -o $@ $(OBJS) $(IMdkitLIB) $(OBJ_IMSRV) -lXtst $(LDFLAGS) -L/usr/local/$(LIB)
 	rm -f core.*
 
-tslearn:        $(OBJS_TSLEARN)
+tslearn:        $(OBJS_TSLEARN) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_TSLEARN) -L./im-client -lgcin-im-client $(LDFLAGS)
 
-ts-edit:        $(OBJS_TS_EDIT)
+ts-edit:        $(OBJS_TS_EDIT) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_TS_EDIT) -L./im-client -lgcin-im-client $(LDFLAGS)
 
 ts-contribute:	ts-edit
@@ -158,16 +158,16 @@
 kbmcv:  $(OBJS_kbmcv)
 	$(CCLD) -o $@ $(OBJS_kbmcv) $(LDFLAGS)
 
-gcin-gb-toggle:	$(OBJS_gcin_gb_toggle)
+gcin-gb-toggle:	$(OBJS_gcin_gb_toggle) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_gcin_gb_toggle) -L./im-client -lgcin-im-client $(LDFLAGS)
 
-gcin-kbm-toggle:	$(OBJS_gcin_kbm_toggle)
+gcin-kbm-toggle:	$(OBJS_gcin_kbm_toggle) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_gcin_kbm_toggle) -L./im-client -lgcin-im-client $(LDFLAGS)
 
-gcin-exit:	$(OBJS_gcin_exit)
+gcin-exit:	$(OBJS_gcin_exit) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_gcin_exit) -L./im-client -lgcin-im-client $(LDFLAGS)
 
-gcin-message:	$(OBJS_gcin_message)
+gcin-message:	$(OBJS_gcin_message) im-client/libgcin-im-client.so
 	$(CCLD) $(gcc_ld_run_path) -o $@ $(OBJS_gcin_message) -L./im-client -lgcin-im-client $(LDFLAGS)
 
 pin-juyin:	$(OBJS_pin_juyin)
@@ -215,12 +215,12 @@
 	$(MAKE) -C data install
 	$(MAKE) -C im-client install
 	$(MAKE) -C gtk-im install
-	if [ $(BUILD_MODULE) = 'Y' ]; then $(MAKE) -C modules install; fi
+	$(MAKE) -C modules install
 	if [ $(GTK3_IM) = 'Y' ]; then $(MAKE) -C gtk3-im install; fi
 	if [ $(QT_IM) = 'Y' ]; then $(MAKE) -C qt-im install; fi
 	if [ $(QT4_IM) = 'Y' ]; then $(MAKE) -C qt4-im install; fi
-	if [ $(prefix) = /usr/local ]; then \
-	   install -m 644 gcin.png /usr/share/icons; \
+	if [ $(prefix) = /nonstaged ]; then \
+	   install -m 644 gcin.png $(prefix)/share/icons; \
 	   install -d $(DOC_DIR); \
 	   install -m 644 README.html Changelog.html $(DOC_DIR); \
 	   install $(PROGS) $(bindir); \
@@ -234,6 +234,7 @@
 	   rm -f $(bindir)/ts-contribute; ln -sf ts-edit $(bindir)/ts-contribute; \
 	fi
 	$(MAKE) -C scripts install
+	$(MAKE) -C man install
 	$(MAKE) -C menu install
 	if [ $(USE_I18N) = 'Y' ]; then $(MAKE) -C po install; fi
 
