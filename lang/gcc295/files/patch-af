--- gcc/config/i386/freebsd.h.orig	Mon Dec 18 15:05:58 2000
+++ gcc/config/i386/freebsd.h	Sun Dec 22 23:08:15 2002
@@ -35,9 +35,9 @@
    libraries compiled with the native cc, so undef it. */
 #undef NO_DOLLAR_IN_LABEL
 
-/* Use more efficient ``thunks'' to implement C++ vtables. */
+/* Do not use ``thunks'' to implement C++ vtables.  This method still has
+   fatal bugs.  */
 #undef DEFAULT_VTABLE_THUNKS
-#define DEFAULT_VTABLE_THUNKS 1
 
 /* Override the default comment-starter of "/".  */
 #undef ASM_COMMENT_START
@@ -135,6 +135,10 @@
  : ((n) >= FIRST_STACK_REG && (n) <= LAST_STACK_REG) ? (n)+3 \
  : (-1))
 
+/* Don't use EGCS's normal profiling code -- we have our own fine-grained
+   basic block profiling.  */
+#define NO_PROFILE_DATA
+
 /* Tell final.c that we don't need a label passed to mcount.  */
 
 #undef FUNCTION_PROFILER
@@ -162,22 +166,30 @@
 #define WCHAR_TYPE_SIZE BITS_PER_WORD
     
 #undef CPP_PREDEFINES
-#define CPP_PREDEFINES "-Di386 -Dunix -D__ELF__ -D__FreeBSD__ -Asystem(unix) -Asystem(FreeBSD) -Acpu(i386) -Amachine(i386)"
+#define CPP_PREDEFINES "-Di386 -Acpu(i386) -Amachine(i386)" CPP_FBSD_PREDEFINES
 
 #undef CPP_SPEC
-#define CPP_SPEC "%(cpp_cpu) %{fPIC:-D__PIC__ -D__pic__} %{fpic:-D__PIC__ -D__pic__} %{posix:-D_POSIX_SOURCE}"
+#if TARGET_CPU_DEFAULT == 2
+#define CPP_SPEC "\
+  %{!maout: -D__ELF__} \
+  %{munderscores: -D__UNDERSCORES__} \
+  %{maout: %{!mno-underscores: -D__UNDERSCORES__}} \
+  %{fPIC:-D__PIC__ -D__pic__} %{fpic:-D__PIC__ -D__pic__} %{!m386:-D__i486__}"
+#else
+#define CPP_SPEC "\
+  %{!maout: -D__ELF__} \
+  %{munderscores: -D__UNDERSCORES__} \
+  %{maout: %{!mno-underscores: -D__UNDERSCORES__}} \
+  %{fPIC:-D__PIC__ -D__pic__} %{fpic:-D__PIC__ -D__pic__} %{m486:-D__i486__}"
+#endif
+
+#undef CC1_SPEC
+#define CC1_SPEC "\
+  %{gline:%{!g:%{!g0:%{!g1:%{!g2: -g1}}}}} \
+  %{maout: %{!mno-underscores: %{!munderscores: -munderscores }}}"
 
-/* This defines which switch letters take arguments.  On FreeBSD, most of
-   the normal cases (defined in gcc.c) apply, and we also have -h* and
-   -z* options (for the linker) (comming from svr4).
-   We also have -R (alias --rpath), no -z, --soname (-h), --assert etc. */
-
-#undef SWITCH_TAKES_ARG
-#define SWITCH_TAKES_ARG(CHAR) \
-  (DEFAULT_SWITCH_TAKES_ARG (CHAR) \
-   || (CHAR) == 'h' \
-   || (CHAR) == 'z' \
-   || (CHAR) == 'R')
+#undef  ASM_SPEC
+#define ASM_SPEC	"%{v*: -v} %{maout: %{fpic:-k} %{fPIC:-k}}"
 
 /* Provide a STARTFILE_SPEC appropriate for FreeBSD.  Here we add
    the magical crtbegin.o file (see crtstuff.c) which provides part 
@@ -186,11 +198,11 @@
    
 #undef	STARTFILE_SPEC
 #define STARTFILE_SPEC \
-  "%{!shared: \
-     %{pg:gcrt1.o%s} %{!pg:%{p:gcrt1.o%s} \
-		       %{!p:%{profile:gcrt1.o%s} \
-			 %{!profile:crt1.o%s}}}} \
-   crti.o%s %{!shared:crtbegin.o%s} %{shared:crtbeginS.o%s}"
+  "%{maout: %{shared:c++rt0.o%s} \
+    %{!shared:%{pg:gcrt0.o%s}%{!pg:%{static:scrt0.o%s}%{!static:crt0.o%s}}}} \
+  %{!maout:  %{!shared: \
+    %{pg:gcrt1.o%s} %{!pg:%{p:gcrt1.o%s} %{!p:crt1.o%s}}} \
+    crti.o%s %{!shared:crtbegin.o%s} %{shared:crtbeginS.o%s}}"
 
 /* Provide a ENDFILE_SPEC appropriate for FreeBSD.  Here we tack on
    the magical crtend.o file (see crtstuff.c) which provides part of 
@@ -200,7 +212,7 @@
 
 #undef	ENDFILE_SPEC
 #define ENDFILE_SPEC \
-  "%{!shared:crtend.o%s} %{shared:crtendS.o%s} crtn.o%s"
+  "%{!maout: %{!shared:crtend.o%s} %{shared:crtendS.o%s} crtn.o%s}"
 
 /* Provide a LIB_SPEC appropriate for FreeBSD.  Just select the appropriate
    libc, depending on whether we're doing profiling or need threads support.
@@ -230,6 +242,20 @@
    done.  */
 
 #undef	LINK_SPEC
+#include <osreldate.h>
+#if __FreeBSD_version >= 500042
+#define LINK_SPEC "-m elf_i386_fbsd \
+  %{Wl,*:%*} \
+  %{v:-V} \
+  %{assert*} %{R*} %{rpath*} %{defsym*} \
+  %{shared:-Bshareable %{h*} %{soname*}} \
+    %{!shared: \
+      %{!static: \
+        %{rdynamic:-export-dynamic} \
+	%{!dynamic-linker:-dynamic-linker /usr/libexec/ld-elf.so.1}} \
+    %{static:-Bstatic}} \
+  %{symbolic:-Bsymbolic}"
+#else
 #define LINK_SPEC "-m elf_i386 \
   %{Wl,*:%*} \
   %{v:-V} \
@@ -241,6 +267,7 @@
 	%{!dynamic-linker:-dynamic-linker /usr/libexec/ld-elf.so.1}} \
     %{static:-Bstatic}} \
   %{symbolic:-Bsymbolic}"
+#endif
 
 /* A C statement to output to the stdio stream FILE an assembler
    command to advance the location counter to a multiple of 1<<LOG
