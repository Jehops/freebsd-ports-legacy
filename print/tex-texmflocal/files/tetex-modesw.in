#!/bin/sh
# $FreeBSD$

if [ $# != 0 ]; then MODE=$1; shift; fi
if [ $# != 0 ]; then FILE=$1; shift; fi
if [ $# != 0 ]; then OPTIONS=$*; fi

GREP=/usr/bin/grep
SED=/usr/bin/sed

CONF=%%PREFIX%%/etc/tetex-modesw.conf

DEFAULT_MODE=tetex

PREFIX=%%PREFIX%%
TEXMF=%%TEXMF%%
TEXMFLOCAL=%%TEXMFLOCAL%%
TEXMFVAR=%%TEXMFVAR%%

if [ ! -r ${CONF} ]; then
    echo "ERROR: ${CONF} not found."
else
    . ${CONF}
fi

case ${FILE} in
texmf.cnf|tex)
	CONFIG=%%TEXMFCNF%%
	DEFAULT_MODE=tetex
	;;
config.ps|dvips)
	CONFIG=%%DVIPSKCNF%%
	;;
XDvi|xdvi)
	CONFIG=%%XDVIKCNF%%
	;;
config|dvipdfm)
	CONFIG=%%DVIPDFMCNF%%
	;;
*)
	CONFIG=${FILE}
	;;
esac

FORCEINSTALL=FALSE
DESTMF=${TEXMFVAR}

set -- ${OPTIONS}
while [ $# != 0 ]; do
    case $1 in
    force*)
	    FORCEINSTALL=TRUE ;;
    main)
	    DESTMF=${TEXMF} ;;
    var)
	    DESTMF=${TEXMFVAR} ;;
    local)
	    DESTMF=${TEXMFLOCAL} ;;
    esac

    shift;
done

usage()
{
    echo "Usage: tetex-modesw modename {tex|dvips|dvipdfm|xdvi} [{forceinstall|var|main|local} ...]"
    exit 1
}

install_file()
{
    _MODE=$1
    _SRC=$2
    _DST=$3

    if [ ! -f ${_SRC} ]; then
	echo "ERROR: invalid mode \"${_MODE}\" is specified."
	usage
    fi
    if [ -f ${_DST} -a "${FORCEINSTALL}" != "TRUE" ]; then
	echo "WARNING: ${_DST} is not modified because it already exists."
	echo "         If you want to install ${_SRC} -> ${_DST},"
	echo "         use \"forceinstall\" option."
	exit 1
    fi

    if [ -f ${_DST} ] && cmp -s ${_SRC} ${_DST}; then
	:
    else
	echo "Installing: ${_SRC} -> ${_DST}"
	cp -p ${_SRC} ${_DST}
    fi
}

uninstall_file()
{
    for _F in $1; do
	if [ -f ${_F} ]; then
	    echo "Uninstalling: ${_F}"
	    rm -f ${_F}
	fi
    done
}

changedefault()
{
    _MODE=$1

    case ${_MODE} in
    tetex|tetex-letter)
	    echo "Default mode -> ${_MODE}"
	    echo "DEFAULT_MODE=${_MODE}" >> ${CONF}
	    ;;
    *)
	    echo "ERROR: Unknown mode ${_MODE} is specified."
	    usage
	    exit 1
	    ;;
    esac
}

case ${MODE} in
default)
	MODE=${DEFAULT_MODE}
	install_file \
	    "${MODE}" \
	    "${PREFIX}/${TEXMF}/${CONFIG}.${MODE}" \
	    "${PREFIX}/${DESTMF}/${CONFIG}"
	;;
uninstall)
	uninstall_file ${PREFIX}/${DESTMF}/${CONFIG}
	;;
changedefault)
	changedefault ${CONFIG}
	;;
*)
	install_file \
	    "${MODE}" \
	    "${PREFIX}/${TEXMF}/${CONFIG}.${MODE}" \
	    "${PREFIX}/${DESTMF}/${CONFIG}"
	;;
esac
