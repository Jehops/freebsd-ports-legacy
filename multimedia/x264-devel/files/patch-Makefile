--- Makefile.orig	Fri Oct 29 06:05:39 2004
+++ Makefile	Thu Jan 20 01:42:05 2005
@@ -20,10 +20,11 @@
 SRCS= $(SRCS_COMMON) core/i386/mc-c.c core/i386/dct-c.c core/i386/predict.c
 ASMSRC= core/i386/dct.asm core/i386/cpu.asm core/i386/pixel.asm  core/i386/mc.asm
 OBJASM= $(ASMSRC:%.asm=%.o)
+SHARED_LIB=	libx264.so
+SHARED_LIB_VER=	$(SHARED_LIB).%%SHLIB_VER%%
 endif
 
-CC=gcc
-CFLAGS=-g -Wall -I. -DDEBUG -O4 -funroll-loops -D__X264__ $(PFLAGS)
+CFLAGS=-I. -D__X264__ %%CFLAGS%% -fPIC
 
 AS= nasm
 # for linux
@@ -34,7 +35,7 @@
 OBJS = $(SRCS:%.c=%.o)
 DEP  = depend
 
-default: $(DEP) x264
+default: $(DEP) x264 $(SHARED_LIB_VER)
 
 libx264.a: $(OBJS) $(OBJASM)
 	ar rc libx264.a $(OBJS) $(OBJASM)
@@ -42,6 +43,9 @@
 
 x264: libx264.a x264.o
 	$(CC) $(CFLAGS) -o x264 x264.o libx264.a -lm
+
+$(SHARED_LIB_VER): $(OBJS) x264
+	$(CC) $(CFLAGS) -shared -Wl,-soname,$(SHARED_LIB_VER) -o $(SHARED_LIB_VER) $(OBJS)
 
 checkasm: testing/checkasm.c libx264.a
 	$(CC) $(CFLAGS) -o checkasm $< libx264.a -lm
