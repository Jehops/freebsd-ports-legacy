From 73ccb0c88d53298befa6a896d2bb39a041169b36 Mon Sep 17 00:00:00 2001
From: Gwenole Beauchesne <gwenole.beauchesne@intel.com>
Date: Fri, 06 Apr 2012 15:24:36 +0000
Subject: dri: cope with drm_state changes.

Signed-off-by: Gwenole Beauchesne <gwenole.beauchesne@intel.com>
---
diff --git a/src/i965_drv_video.c b/src/i965_drv_video.c
index 3bea253..20fed99 100644
--- src/i965_drv_video.c
+++ src/i965_drv_video.c
@@ -2380,7 +2380,7 @@ i965_PutSurface(VADriverContextP ctx,
                 unsigned int flags) /* de-interlacing flags */
 {
     struct i965_driver_data *i965 = i965_driver_data(ctx); 
-    struct dri_state *dri_state = (struct dri_state *)ctx->dri_state;
+    struct dri_state *dri_state = (struct dri_state *)ctx->drm_state;
     struct i965_render_state *render_state = &i965->render_state;
     struct dri_drawable *dri_drawable;
     union dri_buffer *buffer;
@@ -2393,7 +2393,7 @@ i965_PutSurface(VADriverContextP ctx,
     int pp_flag = 0;
 
     /* Currently don't support DRI1 */
-    if (dri_state->driConnectedFlag != VA_DRI2)
+    if (dri_state->base.auth_type != VA_DRM_AUTH_DRI2)
         return VA_STATUS_ERROR_UNKNOWN;
 
     /* Some broken sources such as H.264 conformance case FM2_SVA_C
diff --git a/src/intel_driver.c b/src/intel_driver.c
index 4e6df81..b34d9a1 100644
--- src/intel_driver.c
+++ src/intel_driver.c
@@ -29,7 +29,7 @@
 
 #include <assert.h>
 
-#include <va/va_dricommon.h>
+#include <va/va_drmcommon.h>
 
 #include "intel_batchbuffer.h"
 #include "intel_memman.h"
@@ -50,15 +50,17 @@ Bool
 intel_driver_init(VADriverContextP ctx)
 {
     struct intel_driver_data *intel = intel_driver_data(ctx);
-    struct dri_state *dri_state = (struct dri_state *)ctx->dri_state;
+    struct drm_state * const drm_state = (struct drm_state *)ctx->drm_state;
     int has_exec2, has_bsd, has_blt;
 
-    assert(dri_state);
-    assert(dri_state->driConnectedFlag == VA_DRI2 || 
-           dri_state->driConnectedFlag == VA_DRI1);
+    assert(drm_state);
+    assert(drm_state->auth_type == VA_DRM_AUTH_DRI1 ||
+           drm_state->auth_type == VA_DRM_AUTH_DRI2 ||
+           drm_state->auth_type == VA_DRM_AUTH_CUSTOM);
 
-    intel->fd = dri_state->fd;
-    intel->dri2Enabled = (dri_state->driConnectedFlag == VA_DRI2);
+    intel->fd = drm_state->fd;
+    intel->dri2Enabled = (drm_state->auth_type == VA_DRM_AUTH_DRI2 ||
+                          drm_state->auth_type == VA_DRM_AUTH_CUSTOM);
 
     if (!intel->dri2Enabled) {
         return False;
--
cgit v0.9.0.2-2-gbebe
