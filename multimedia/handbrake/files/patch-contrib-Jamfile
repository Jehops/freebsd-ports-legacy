--- contrib/Jamfile.orig	2008-05-21 05:18:06.844254734 +0300
+++ contrib/Jamfile	2008-05-21 06:00:18.032459924 +0300
@@ -34,9 +34,10 @@
 }
 actions Wget
 {
-    $(RM) $(<) &&
-    $(WGET) $(<) `cat $(>)` &&
-    ( touch $(<) || true )
+#    $(RM) $(<) &&
+#    $(WGET) $(<) `cat $(>)` &&
+#    ( touch $(<) || true )
+    true
 }
 
 # liba52
@@ -48,10 +49,9 @@
 actions LibA52
 {
 
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf a52dec && (gzip -dc a52dec.tar.gz | tar xf -) && 
-    cd a52dec && $(PATCH) -p1 < ../patch-a52dec.patch &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache && $(MAKE) && $(MAKE) install &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/a52dec && patch -p1 < ../patch-a52dec.patch &&
+    ./configure --prefix=$CONTRIB && $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/liba52.a
 }
 Wget   $(SUBDIR)/a52dec.tar.gz : $(SUBDIR)/version_a52dec.txt ;
@@ -75,10 +75,9 @@
 }
 actions LibAvCodec
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf ffmpeg && (gzip -dc ffmpeg.tar.gz | tar xf -) &&
-    cd ffmpeg && $(FFMPEG_PATCH) &&
-    ./configure --prefix=$CONTRIB --enable-gpl --enable-pthreads --enable-swscaler --disable-audio-beos --disable-shared --enable-static \
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/ffmpeg && $(FFMPEG_PATCH) &&
+    ./configure --prefix="$CONTRIB" --cc="%%CC%%" --extra-libs="%%PTHREAD_LIBS%%" --enable-gpl --enable-pthreads --enable-swscaler --disable-audio-beos --disable-shared --enable-static --disable-opts \
         --disable-decoders --enable-decoder=mp2 --disable-parsers --enable-parser=mpegaudio \
         --disable-encoders --enable-encoder=mpeg4 --enable-encoder=ac3 --enable-encoder=snow \
         --disable-muxers --enable-muxer=ipod --disable-demuxers --disable-protocols --disable-bsfs &&
@@ -113,10 +112,9 @@
     }
     actions LibDvdCss
     {
-        cd `dirname $(>)` && CONTRIB=`pwd` &&
-        rm -rf libdvdcss && (gzip -dc libdvdcss.tar.gz | tar xf - ) && 
-        cd libdvdcss &&
-        ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache && $(MAKE) && $(MAKE) install &&
+        CONTRIB=%%CONTRIB%% &&
+        cd $CONTRIB/libdvdcss &&
+        ./configure --prefix=$CONTRIB && $(MAKE) && $(MAKE) install &&
         $(STRIP) $CONTRIB/lib/libdvdcss.a
     }
     Wget      $(SUBDIR)/libdvdcss.tar.gz : $(SUBDIR)/version_libdvdcss.txt ;
@@ -131,10 +129,9 @@
 }
 actions LibDCA
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf libdca && (gzip -dc libdca.tar.gz | tar xf - ) && 
-    cd libdca && $(PATCH) -p1 < ../patch-libdca.patch &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache && $(MAKE) && $(MAKE) install &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/libdca && patch -p1 < ../patch-libdca.patch &&
+    ./configure --prefix=$CONTRIB && $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libdca.a
 }
 Wget   $(SUBDIR)/libdca.tar.gz : $(SUBDIR)/version_libdca.txt ;
@@ -150,10 +147,9 @@
 {
     actions LibDvdRead
     {
-        cd `dirname $(>)` && CONTRIB=`pwd` &&
-        rm -rf libdvdread && (gzip -dc libdvdread.tar.gz | tar xf - ) && 
-        cd libdvdread &&
-        ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared --with-libdvdcss=$CONTRIB &&
+        CONTRIB=%%CONTRIB%% &&
+        cd $CONTRIB/libdvdread &&
+        ./configure --prefix=$CONTRIB --disable-shared --with-libdvdcss=$CONTRIB &&
         $(MAKE) && $(MAKE) install &&
         $(STRIP) $CONTRIB/lib/libdvdread.a
     }
@@ -163,10 +159,9 @@
     # configure line.
     actions LibDvdRead
     {
-        cd `dirname $(>)` && CONTRIB=`pwd` &&
-        rm -rf libdvdread && (gzip -dc libdvdread.tar.gz | tar xf - ) && 
-        cd libdvdread &&
-        ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared &&
+        CONTRIB=%%CONTRIB%% &&
+        cd $CONTRIB/libdvdread &&
+        ./configure --prefix=$CONTRIB --disable-shared &&
         $(MAKE) && $(MAKE) install &&
         $(STRIP) $CONTRIB/lib/libdvdread.a
     }
@@ -182,9 +177,9 @@
 }
 actions LibFaac
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf faac && (gzip -dc faac.tar.gz | tar xf - ) && cd faac &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared --enable-static &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/faac &&
+    ./configure --prefix=$CONTRIB --disable-shared --enable-static &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libfaac.a
 }
@@ -199,9 +194,9 @@
 }
 actions LibMp3Lame
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf lame && (gzip -dc lame.tar.gz | tar xf - ) && cd lame &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/lame &&
+    ./configure --prefix=$CONTRIB --disable-shared &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libmp3lame.a
 }
@@ -224,10 +219,10 @@
 }
 actions LibMp4v2
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf mpeg4ip && (gzip -dc mpeg4ip.tar.gz | tar xf - ) &&
-    cd mpeg4ip && $(LIBMP4V2_PATCH)
-    ./bootstrap --cache-file=$CONTRIB/config.cache --disable-mp3lame --disable-faac --disable-x264 --disable-server --disable-player &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/mpeg4ip &&
+    $(LIBMP4V2_PATCH)
+    ./bootstrap --disable-mp3lame --disable-faac --disable-x264 --disable-server --disable-player &&
     $(MAKE) -C lib/mp4v2 libmp4v2.la && cp lib/mp4v2/.libs/libmp4v2.a $CONTRIB/lib &&
     cp mpeg4ip_config.h include/mpeg4ip.h include/mpeg4ip_version.h \
         include/mpeg4ip_win32.h lib/mp4v2/*.h $CONTRIB/include &&
@@ -243,10 +238,9 @@
 }
 actions LibMkv
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf libmkv && (gzip -dc libmkv.tar.gz | tar xf - ) && 
-    cd libmkv &&
-    ./configure --disable-shared --enable-static --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/libmkv &&
+    ./configure --disable-shared --enable-static --prefix=$CONTRIB &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libmkv.a
 }
@@ -261,10 +255,9 @@
 }
 actions LibMpeg2
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf mpeg2dec && (gzip -dc mpeg2dec.tar.gz | tar xf - ) && 
-    cd mpeg2dec && $(PATCH) -p1 < ../patch-libmpeg2.patch &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared --disable-sdl &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/mpeg2dec && patch -p1 < ../patch-libmpeg2.patch &&
+    ./configure --prefix=$CONTRIB --disable-shared --disable-sdl &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libmpeg2.a
 }
@@ -279,10 +272,9 @@
 }
 actions LibOgg
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf libogg && (gzip -dc libogg.tar.gz | tar xf - ) && 
-    cd libogg &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/libogg &&
+    ./configure --prefix=$CONTRIB --disable-shared &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libogg.a
 }
@@ -297,10 +289,9 @@
 }
 actions LibSampleRate
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf libsamplerate && (gzip -dc libsamplerate.tar.gz | tar xf - ) && 
-    cd libsamplerate &&
-    ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/libsamplerate &&
+    ./configure --prefix=$CONTRIB --disable-shared &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libsamplerate.a
 }
@@ -315,10 +306,9 @@
 }
 actions LibVorbis
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf libvorbis && (gzip -dc libvorbis.tar.gz | tar xf - ) &&
-    cd libvorbis &&
-    ./configure --prefix=$CONTRIB --with-ogg=$CONTRIB --cache-file=$CONTRIB/config.cache --disable-shared &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/libvorbis &&
+    ./configure --prefix=$CONTRIB --with-ogg=$CONTRIB --disable-shared &&
     $(MAKE) && $(MAKE) install &&
     $(STRIP) $CONTRIB/lib/libvorbis.a
 }
@@ -356,10 +346,9 @@
 }
 actions LibX264
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf x264 && (gzip -dc x264.tar.gz | tar xf - ) && 
-    cd x264 && $(LIBX264_PATCH)
-    bash ./configure --prefix=$CONTRIB --enable-pthread &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/x264 && $(LIBX264_PATCH)
+    ./configure --prefix=$CONTRIB --enable-pthread && $(MAKE) &&
     $(MAKE) libx264.a && cp libx264.a $CONTRIB/lib/ && cp x264.h $CONTRIB/include/ && $(STRIP) $CONTRIB/lib/libx264.a
 }
 Wget    $(SUBDIR)/x264.tar.gz   : $(SUBDIR)/version_x264.txt ;
@@ -383,10 +372,9 @@
 }
 actions LibXvidCore
 {
-    cd `dirname $(>)` && CONTRIB=`pwd` &&
-    rm -rf xvidcore && (gzip -dc xvidcore.tar.gz | tar xf - ) &&
-    cd xvidcore && $(LIBXVIDCORE_PATCH)
-    cd build/generic/ && ./configure --prefix=$CONTRIB --cache-file=$CONTRIB/config.cache && $(MAKE) libxvidcore.a &&
+    CONTRIB=%%CONTRIB%% &&
+    cd $CONTRIB/xvidcore && $(LIBXVIDCORE_PATCH)
+    cd build/generic/ && ./configure --prefix=$CONTRIB && $(MAKE) libxvidcore.a &&
     cp ./=build/libxvidcore.a $CONTRIB/lib/ &&
     cp ../../src/xvid.h $CONTRIB/include/ &&
     $(STRIP) $CONTRIB/lib/libxvidcore.a
@@ -404,9 +392,8 @@
     }
     actions Zlib
     {
-        cd `dirname $(>)` && CONTRIB=`pwd` &&
-        rm -rf zlib && (gzip -dc zlib.tar.gz | tar xf - ) &&
-        cd zlib && ./configure --prefix=$CONTRIB &&
+        CONTRIB=%%CONTRIB%% &&
+        cd $CONTRIB/zlib && ./configure --prefix=$CONTRIB &&
         $(MAKE) && $(MAKE) install && touch $CONTRIB/.contrib &&
         $(STRIP) $CONTRIB/lib/libz.a
     }
