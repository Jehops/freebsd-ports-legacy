--- Makefile.orig	Tue Jan 25 16:36:54 2005
+++ Makefile	Tue Jan 25 20:52:45 2005
@@ -22,8 +22,11 @@
 OBJASM= $(ASMSRC:%.asm=%.o)
 endif
 
-CC=gcc
-CFLAGS=-Wall -I. -O4 -funroll-loops -D__X264__ $(PFLAGS)
+SHARED_LIB=		libx264.so
+SHARED_LIB_VER=		$(SHARED_LIB).%%SHLIB_VER%%
+  
+CFLAGS=-I. -D__X264__ %%CFLAGS%% -fPIC
+
 ifdef NDEBUG
 CFLAGS+=-s -DNDEBUG
 else
@@ -39,14 +42,17 @@
 OBJS = $(SRCS:%.c=%.o)
 DEP  = depend
 
-default: $(DEP) x264
+default: $(DEP) x264 $(SHARED_LIB_VER)
 
 libx264.a: $(OBJS) $(OBJASM)
 	ar rc libx264.a $(OBJS) $(OBJASM)
 	ranlib libx264.a
 
-x264: libx264.a x264.o
-	$(CC) $(CFLAGS) -o x264 x264.o libx264.a -lm
+x264: $(SHARED_LIB_VER) x264.o
+	$(CC) $(CFLAGS) -o x264 x264.o $(SHARED_LIB_VER) -lm
+
+$(SHARED_LIB_VER): $(OBJS) libx264.a
+	$(CC) $(CFLAGS) -shared -Wl,-soname,$(SHARED_LIB_VER) -o $(SHARED_LIB_VER) $(OBJS) $(OBJASM) -lm
 
 checkasm: testing/checkasm.c libx264.a
 	$(CC) $(CFLAGS) -o checkasm $< libx264.a -lm
@@ -56,7 +62,7 @@
 
 .depend: $(SRCS) x264.c
 	rm -f .depend
-	$(foreach SRC, $(SRCS) x264.c, $(CC) $(CFLAGS) $(SRC) -MM -MT $(SRC:%.c=%.o) 1>> .depend;)
+	 $(CC) -MM $(CFLAGS) $(SRCS) x264.c 1> .depend
 
 depend: .depend
 ifneq ($(wildcard .depend),)
