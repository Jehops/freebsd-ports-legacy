#!/bin/sh

if [ "$2" != "POST-INSTALL" ]; then
    exit 0
fi

USER=ejabberd
GROUP=${USER}
UID=522
GID=${UID}

if ! pw groupshow "${GROUP}" 2>/dev/null 1>&2; then
	if pw groupadd ${GROUP} -g ${GID}; then
		echo "Added group \"${GROUP}\"."
	else
		echo "Adding group \"${GROUP}\" failed..."
		exit 1
	fi
fi

if ! pw usershow "${USER}" 2>/dev/null 1>&2; then
	if pw useradd ${USER} -u ${UID} -g ${GROUP} -h - \
		-s "/bin/sh" -d "/var/run/ejabberd" \
		-c "ejabberd pseudo user"; \
	then
		echo "Added user \"${USER}\"."
	else
		echo "Adding user \"${USER}\" failed..."
		exit 1
	fi
fi

mkdir -m 750 /var/log/ejabberd /var/spool/ejabberd /var/run/ejabberd 2>/dev/null

cat > /var/run/ejabberd/.inetrc << __EOF__
{lookup,["file","native"]}.
{host,{127,0,0,1}, ["localhost","hostalias"]}.
__EOF__

chown -R ejabberd:ejabberd /var/log/ejabberd /var/spool/ejabberd \
    /var/run/ejabberd

exit 0
