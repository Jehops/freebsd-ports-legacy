#!/bin/sh

if [ "$2" != "POST-INSTALL" ]; then
    exit 0
fi

USER=jabber
GROUP=${USER}
UID=93
GID=${UID}
SPOOLDIR="/var/spool/jabber"
PIDDIR="/var/run/jabberd"
ETCDIR=${PREFIX:-$PKG_PREFIX}/etc

if ! pw groupshow "${GROUP}" 2>/dev/null 1>&2; then
	if pw groupadd ${GROUP} -g ${GID}; then
		echo "Added group \"${GROUP}\"."
	else
		echo "Adding group \"${GROUP}\" failed..."
		exit 1
	fi
fi

if ! pw usershow "${USER}" 2>/dev/null 1>&2; then
	if pw useradd ${USER} -u ${UID} -g ${GROUP} -h - \
		-s "/sbin/nologin" -d "/nonexistent" \
		-c "Jabber Daemon"; \
	then
		echo "Added user \"${USER}\"."
	else
		echo "Adding user \"${USER}\" failed..."
		exit 1
	fi
fi

if [ ! -d ${SPOOLDIR} ]; then
	echo "Creating \"${SPOOLDIR}\"."
	mkdir -p ${SPOOLDIR}
fi

echo "Fixing ownerships and modes in \"${SPOOLDIR}\"."
chown -R ${USER}:${GROUP} ${SPOOLDIR}
chmod -R go= ${SPOOLDIR}

if [ ! -d ${PIDDIR} ]; then
	echo "Creating \"${PIDDIR}\"."
	mkdir -p ${PIDDIR}
fi

echo "Fixing ownerships and modes in \"${PIDDIR}\"."
chown -R ${USER}:${GROUP} ${PIDDIR}

if [ ! -f ${ETCDIR}/jabber.xml ]; then
	echo "Creating \"${ETCDIR}/jabber.xml\"."
	cp -p ${ETCDIR}/jabber.xml.dist ${ETCDIR}/jabber.xml
fi

echo "Fixing config files ownerships and modes."
chown root:${GROUP} ${ETCDIR}/jabber.xml ${ETCDIR}/jabber.xml.dist
chmod 640 ${ETCDIR}/jabber.xml ${ETCDIR}/jabber.xml.dist

echo "Fixing log files, ownerships and modes."
touch /var/log/jabberd/error.log /var/log/jabberd/record.log
chown ${USER}:${GROUP} /var/log/jabberd/error.log /var/log/jabberd/record.log
chmod 640 /var/log/jabberd/error.log /var/log/jabberd/record.log
