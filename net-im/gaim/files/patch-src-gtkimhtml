--- src/gtkimhtml.c.orig	Tue May  4 18:09:10 2004
+++ src/gtkimhtml.c	Tue May  4 18:09:12 2004
@@ -542,10 +542,11 @@
 	GtkTextIter start, end;
 	GtkTextMark *sel = gtk_text_buffer_get_selection_bound(imhtml->text_buffer);
 	GtkTextMark *ins = gtk_text_buffer_get_insert(imhtml->text_buffer);
-	
+	gboolean primary;
+
 	gtk_text_buffer_get_iter_at_mark(imhtml->text_buffer, &start, sel);
 	gtk_text_buffer_get_iter_at_mark(imhtml->text_buffer, &end, ins);
-	gboolean primary = gtk_widget_get_clipboard(GTK_WIDGET(imhtml), GDK_SELECTION_PRIMARY) == clipboard;
+	primary = gtk_widget_get_clipboard(GTK_WIDGET(imhtml), GDK_SELECTION_PRIMARY) == clipboard;
 
 	if (info == TARGET_HTML) {
 		int len;
@@ -684,7 +685,6 @@
 static void paste_received_cb (GtkClipboard *clipboard, GtkSelectionData *selection_data, gpointer data)
 {
 	char *text;
-	guint16 c;
 	GtkIMHtml *imhtml = data;
 	GtkTextIter iter;
 	GtkIMHtmlOptions flags = GTK_IMHTML_NO_NEWLINE;
@@ -756,14 +756,14 @@
 		memcpy(text, selection_data->data, selection_data->length);
 	}
 
-	memcpy (&c, text, 2);
-	if (c == 0xfeff) {
-		/* This is UCS2 */
-		char *utf8 = g_convert(text+2, selection_data->length - 2, "UTF-8", "UCS-2", NULL, NULL, NULL);
+	if (selection_data->length >= 2 &&
+		(*(guint16 *)text == 0xfeff || *(guint16 *)text == 0xfffe)) {
+		/* This is UCS-2 */
+		char *utf8 = g_convert(text, selection_data->length, "UTF-8", "UCS-2", NULL, NULL, NULL);
 		g_free(text);
 		text = utf8;
 		if (!text) {
-			gaim_debug_warning("gtkimhtml", "g_convert failed in paste_received_cb\n");
+			gaim_debug_warning("gtkimhtml", "g_convert from UCS-2 failed in paste_received_cb\n");
 			return;
 		}
 	}
