--- Makefile.orig	Tue Jun 15 16:39:06 1999
+++ Makefile	Sat Jan 15 15:54:59 2000
@@ -4,7 +4,7 @@
 
 # Where to install binary and manpage on "make install":
 
-PREFIX=/usr/local
+#PREFIX=/usr/local
 BINDIR=$(PREFIX)/bin
 MANDIR=$(PREFIX)/man
 SECTION=1
@@ -285,35 +285,51 @@
 #CFLAGS='-DI386_ASSEM -O2 -DREAL_IS_FLOAT -DLINUX -Wall -g'
 #CFLAGS='-DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -Wall -O2 -m486 -fomit-frame-pointer -funroll-all-loops -finline-functions -ffast-math -malign-loops=2 -malign-jumps=2 -malign-functions=2'
 
+CC ?= cc
+LDFLAGS =
+CFLAGS ?=-O4 -m486
+
+.if defined(OPT_ARCH)
+.if (${OPT_ARCH} == "i486")
+ARCHOPT = -DI486_OPT
+ARCHFILES = decode_i486.o dct64_i486.o dct64_i386.o
+.elif (${OPT_ARCH} == "i586")
+ARCHOPT = -DPENTIUM_OPT
+ARCHFILES = decode_i586.o dct64_i386.o
+.elif (${OPT_ARCH} == "3dnow")
+ARCHOPT = -DPENTIUM_OPT -DUSE_3DNOW
+ARCHFILES = dct64_3dnow.o decode_3dnow.o
+dct64_3dnow.o:
+	${INSTALL} ./precompiled/linux-i386/dct64_3dnow.o .
+decode_3dnow.o:
+	${INSTALL} ./precompiled/linux-i386/decode_3dnow.o .
+
+.endif
+.endif
+
+CFLAGS +=-Wall -ansi -pedantic -fomit-frame-pointer \
+	-ffast-math -DROT_I386 \
+	-DREAD_MMAP \
+	-DI386_ASSEM ${ARCHOPT} -DREAL_IS_FLOAT -DUSE_MMAP -DOSS -DTERM_CONTROL
+
+.if defined(OPT_ESOUND)
+CFLAGS +=-I${PREFIX}/include
+LDFLAGS+=-L${PREFIX}/lib
+.endif
+
 freebsd:
-	$(MAKE) CC=cc LDFLAGS= \
-		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-		CFLAGS='-Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
-			-funroll-all-loops -ffast-math -DROT_I386 \
-			-DREAD_MMAP \
-			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS' \
-		mpg123-make
+	${MAKE} OPT_ARCH=${OPT_ARCH} \
+		OBJECTS='decode_i386.o ${ARCHFILES} audio_oss.o term.o' \
+ 		mpg123-make
 
 freebsd-esd:
-	$(MAKE) CC=cc LDFLAGS= \
-		AUDIO_LIB='-lesd -laudiofile' \
-		OBJECTS='decode_i386.o dct64_i386.o $(GETBITS) audio_esd.o' \
-		CFLAGS='-Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
-			-funroll-all-loops -ffast-math -DROT_I386 \
-			-DREAD_MMAP \
-			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS \
-			-I/usr/local/include -L/usr/local/lib \
-			$(CFLAGS)' \
+	$(MAKE) OPT_ARCH=${OPT_ARCH} AUDIO_LIB='-lesd -laudiofile' \
+		OBJECTS='decode_i386.o ${ARCHFILES} audio_esd.o term.o' \
 		mpg123-make
 
 freebsd-frontend:
-	$(MAKE) CC=cc LDFLAGS= \
-		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o \
+	$(MAKE) OBJECTS='decode_i386.o ${ARCHFILES} audio_oss.o \
 			control_sajber.o control_tk3play.o' \
-		CFLAGS='-Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
-			-funroll-all-loops -ffast-math -DROT_I386 \
-			-DFRONTEND \
-			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS' \
 		$(FRONTEND)
  
 
@@ -552,7 +568,7 @@
 	@ $(MAKE) CFLAGS='$(CFLAGS)' BINNAME=mpg123m mpg123
 
 mpg123-make:
-	@ $(MAKE) CFLAGS='$(CFLAGS)' BINNAME=mpg123 mpg123
+	@ $(MAKE) LDFLAGS='$(LDFLAGS)' CFLAGS='$(CFLAGS)' BINNAME=mpg123 mpg123
 
 mpg123: mpg123.o common.o $(OBJECTS) decode_2to1.o decode_4to1.o \
 		tabinit.o audio.o layer1.o layer2.o layer3.o buffer.o \
