#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: squeezecenter
# REQUIRE: LOGIN
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable squeezecenter:
#
#squeezecenter_enable="YES"
#

. %%RC_SUBR%%

name=squeezecenter
start_precmd="squeezecenter_start_precmd"
stop_postcmd="squeezecenter_stop_postcmd"
rcvar=`set_rcvar`

command=%%PREFIX%%/%%SLIMDIR%%/slimserver.pl
command_interpreter=%%PERL%%
pidfile=/var/run/${name}/${name}.pid
logdir=/var/log/squeezecenter
statedir=%%SLIMDBDIR%%
cachedir=${statedir}/cache
prefsdir=${statedir}/prefs
playlistdir=${statedir}/playlists
conffile=${statedir}/squeezecenter.conf
u=%%SLIMUSER%%
g=%%SLIMGROUP%%
command_args="--daemon --prefsfile=${conffile} --pidfile=${pidfile}"
squeezecenter_user=${u}
squeezecenter_group=${g}

squeezecenter_start_precmd()
{
	mkdir -p /var/run/${name}
	chown -R ${u}:${g} /var/run/${name}

	mkdir -p ${logdir}
	chown -R ${u}:${g} ${logdir}

	mkdir -p ${statedir}
	mkdir -p ${cachedir}
	mkdir -p ${prefsdir}
	mkdir -p ${playlistdir}
	touch ${conffile}
	chown -R ${u}:${g} ${statedir}

	if [ ! -f ${logfile} ]; then
		touch ${logfile}
		chown ${u}:${g} ${logfile}
	fi	
}

squeezecenter_stop_postcmd()
{
	pids=`pgrep -u $u`
	if [ -n "${pids}" ]; then
		sleep 1
		kill $pids > /dev/null 2>&1
	fi
	pids=`pgrep -u $u`
	if [ -n "${pids}" ]; then
		wait_for_pids $pids
	fi
}

load_rc_config ${name}

squeezecenter_enable=${squeezecenter_enable:-"NO"}
squeezecenter_flags=${squeezecenter_flags:-""}

run_rc_command "$1"
