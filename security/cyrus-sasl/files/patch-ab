--- configure.in.orig	Wed May 22 20:49:46 2002
+++ configure.in	Thu May 23 16:52:07 2002
@@ -66,8 +66,12 @@
 dnl check for -R, etc. switch
 CMU_GUESS_RUNPATH_SWITCH
 dnl let's just link against local.  otherwise we never find anything useful.
-CPPFLAGS="-I/usr/local/include ${CPPFLAGS}"
-CMU_ADD_LIBPATH("/usr/local/lib")
+CPPFLAGS="-I${OPENSSLINC}/openssl ${CPPFLAGS}"
+if test "${OPENSSLINC}" != "/usr/include" ; then
+  CPPFLAGS="-I${OPENSSLINC} ${CPPFLAGS}"
+fi
+CMU_ADD_LIBPATH("${OPENSSLLIB}")
+CMU_ADD_LIBPATH("${LOCALBASE}/lib")
 
 AM_DISABLE_STATIC
 
@@ -122,8 +126,6 @@
 
   AC_SUBST(JAVA_INCLUDES)
   AC_MSG_RESULT(JAVA_INCLUDES)
-  JAVAC=`echo "$JAVAC" | sed 's,.*/,,'`
-  JAVAH=`echo "$JAVAH" | sed 's,.*/,,'`
 fi
 
 AM_CONDITIONAL(SAMPLE, test "$enable_sample" = yes)
@@ -149,11 +151,13 @@
 	AC_CHECK_HEADER(db.h,
 			AC_CHECK_LIB(db-3, db_create, SASL_DB_LIB="-ldb-3";
 			   dblib="berkeley",
+			AC_CHECK_LIB(db3, db_create, SASL_DB_LIB="-ldb3";
+			   dblib="berkeley",
 			AC_CHECK_LIB(db, db_create, SASL_DB_LIB="-ldb";
 			   dblib="berkeley",
 			AC_CHECK_LIB(db, db_open, SASL_DB_LIB="-ldb"; 
 			   dblib="berkeley",
-                        dblib="no"))),
+                        dblib="no")))),
 			dblib="no")
 	;;
   gdbm)
@@ -175,11 +179,13 @@
 	AC_CHECK_HEADER(db.h,
 			AC_CHECK_LIB(db-3, db_create, SASL_DB_LIB="-ldb-3";
 			   dblib="berkeley",
+			AC_CHECK_LIB(db3, db_create, SASL_DB_LIB="-ldb3";
+			   dblib="berkeley",
 			AC_CHECK_LIB(db, db_create, SASL_DB_LIB="-ldb";
 			   dblib="berkeley",
 			AC_CHECK_LIB(db, db_open, SASL_DB_LIB="-ldb"; 
 			   dblib="berkeley",
-                        dblib="no"))),
+                        dblib="no")))),
 			dblib="no")
 	if test "$dblib" = no; then
 	  dnl How about ndbm?
@@ -229,6 +235,13 @@
   berkeley)
     SASL_DB_BACKEND="db_${dblib}.lo"
     AC_DEFINE(SASL_BERKELEYDB)
+    for db3loc in ${prefix} /usr/local /usr
+    do
+      if test -d ${db3loc}/include/db3; then
+       CPPFLAGS="-I${db3loc}/include/db3 $CPPFLAGS"
+       break
+      fi
+    done
     ;;
   *)
     AC_MSG_WARN([Disabling SASL authentication database support])
@@ -534,12 +547,16 @@
   fi
 
   if test "$with_des" != no; then
+    case "$host_os" in
+	freebsd*)
+	    COM_ERR="-lcom_err"
+	    ;;
+    esac
     AC_CHECK_HEADER(krb.h,
-      AC_CHECK_LIB(krb, krb_mk_priv, COM_ERR="",
-	AC_CHECK_LIB(krb, krb_mk_priv, COM_ERR="-lcom_err",
-                     AC_WARN(No Kerberos V4 found); krb4=no, -ldes -lcom_err),
-        -ldes),
-      AC_WARN(No Kerberos V4 found); krb4=no)
+      AC_CHECK_LIB(krb, krb_mk_priv,:,
+                AC_WARN(No Kerberos V4 found); krb4=no,
+		-ldes ${COM_ERR}),
+      AC_WARN(No Kerberos V4 headers found); krb4=no)
   else
     AC_WARN(No DES library found for Kerberos V4 support)
     krb4=no
