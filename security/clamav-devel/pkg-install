#!/bin/sh

if [ -z "${CLAMAVUSER}" ]; then
	CLAMAVUSER=clamav
fi

if [ -z "${SPOOLDIR}" ]; then
	SPOOLDIR=/var/clamd
fi

CLAMAVGROUP=${CLAMAVUSER}

echo "===> Adding user \"${CLAMAVUSER}\" if necessary."
if ! pw groupshow "${CLAMAVGROUP}" 2>/dev/null 1>&2; then
	if pw groupadd ${CLAMAVGROUP}; then
		echo "===> Added group \"${CLAMAVGROUP}\"."
	else
                echo "===> Adding group \"${CLAMAVGROUP}\" failed..."
                exit 1
	fi
fi

if ! pw usershow "${CLAMAVUSER}" 2>/dev/null 1>&2; then
	if pw useradd ${CLAMAVUSER} -g ${CLAMAVGROUP} -h - \
		-s "/usr/sbin/nologin" -d "${SPOOLDIR}" \
		-c "Clam Antivirus"; \
        then
                echo "===> Added user \"${CLAMAVUSER}\"."
        else
                echo "===> Adding user \"${CLAMAVUSER}\" failed..."
                exit 1
        fi
fi

echo "===> Setting permissions..."
mkdir ${SPOOLDIR}
chown -R ${CLAMAVUSER}:${CLAMAVGROUP} ${PKG_PREFIX}/share/clamav ${SPOOLDIR}

exit 0
