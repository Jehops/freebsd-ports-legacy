#!/bin/sh
# $FreeBSD: /tmp/pcvs/ports/security/clamav-devel/Attic/pkg-install,v 1.18 2004-12-22 02:10:12 edwin Exp $

PREFIX=${PKG_PREFIX:-%%PREFIX%%}
DESTDIR=${PKG_DESTDIR:-}

CLAMAVUSER=%%CLAMAVUSER%%
CLAMAVGROUP=%%CLAMAVGROUP%%
UID=106
GID=$UID

CLAMRUN=$DESTDIR/var/run/clamav
CLAMLOG=$DESTDIR/var/log/clamav
DBDIR=$DESTDIR%%DBDIR%%

if [ "$2" = "PRE-INSTALL" ]; then

	if ! pw groupshow "$CLAMAVGROUP" 2>/dev/null 1>&2; then
		if pw groupadd $CLAMAVGROUP -g $GID; then
			echo "=> Added group \"$CLAMAVGROUP\"."
		else
			echo "=> Adding group \"$CLAMAVGROUP\" failed..."
			exit 1
		fi
	fi

	if ! pw usershow "$CLAMAVUSER" 2>/dev/null 1>&2; then
		if pw useradd $CLAMAVUSER -u $UID -g $CLAMAVGROUP -h - \
			-s "/sbin/nologin" -d "/nonexistent" \
			-c "Clam Antivirus"; \
		then
			pw groupmod mail -m $CLAMAVUSER
			echo "=> Added user \"$CLAMAVUSER\"."
		else
			echo "=> Adding user \"$CLAMAVUSER\" failed..."
			exit 1
		fi
	fi

elif [ "$2" = "POST-INSTALL" ]; then

	if [ ! -d "$CLAMRUN" ]; then
		mkdir -p "$CLAMRUN" || exit 1
		chown "$CLAMAVUSER:$CLAMAVGROUP" "$CLAMRUN" || exit 1
	fi

	if [ ! -d "$CLAMLOG" ]; then
		mkdir -p "$CLAMLOG" || exit 1
		chown "$CLAMAVUSER:$CLAMAVGROUP" "$CLAMLOG" || exit 1
	fi

	if [ ! -d "$DBDIR" ]; then
		mkdir -p "$DBDIR" || exit 1
		chown "$CLAMAVUSER:$CLAMAVGROUP" "$DBDIR" || exit 1
	fi

	if [ -f "$DESTDIR$PREFIX/etc/clamav.conf" ]; then
		echo
		echo "**************** WARNING ****************"
		echo "*                                       *"
		echo "*  The configuration file has changed:  *"
		echo "* Please edit $PREFIX/etc/clamd.conf *"
		echo "* and remove $PREFIX/etc/clamav.conf *"
		echo "*                                       *"
		echo "**************** WARNING ****************"
		echo
	fi

fi

exit 0
