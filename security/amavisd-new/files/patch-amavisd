--- amavisd.old	Fri Aug 18 13:01:43 2006
+++ amavisd	Fri Aug 18 13:01:51 2006
@@ -12049,15 +12049,20 @@
             my($bounced) = $msginfo->dsn_sent;
             for my $r (@{$msginfo->per_recip_data}) {
               my($resp) = $r->recip_smtp_response;
-              if ($bounced && $smtp_resp=~/^2/ && $resp!~/^2/) {
-                # as the message was already bounced by us,
-                # MTA must not bounce it again; failure status
-                # needs to be converted into success!
-                $resp = sprintf("250 2.5.0 Ok %s, DSN %s (%s)",
-                        $r->recip_addr, $bounced==1 ? 'sent' : 'muted', $resp);
+              my($recip_quoted) = qquote_rfc2821_local($r->recip_addr);
+              if ($resp=~/^2/) {
+                # success, no need to change status
+              } elsif ($bounced) {
+                # a non-delivery notifications was already sent by us, so
+                # MTA must not bounce it again; turn status into a success
+                $resp = sprintf("250 2.5.0 Ok %s, DSN was sent (%s)",
+                                $recip_quoted, $resp);
+              } elsif ($resp=~/^5/ && $r->recip_destiny != D_REJECT) {
+                $resp = sprintf("250 2.5.0 Ok %s, DSN suppressed (%s)",
+                                $recip_quoted, $resp);
               }
-              do_log(4, 'sending LMTP response for <%s>: "%s"',
-                        $r->recip_addr, $resp);
+              do_log(4, 'sending LMTP response for %s: "%s"',
+                        $recip_quoted, $resp);
               $self->smtp_resp(0, $resp);
             }
           }
@@ -15055,6 +15060,8 @@
     local_tests_only  => $sa_local_tests_only,
     home_dir_for_helpers => $helpers_home,
     stop_at_threshold => 0,
+    LOCAL_STATE_DIR   => '/var/lib',
+    PREFIX            => '/usr/local',
 #   DEF_RULES_DIR     => '/usr/local/share/spamassassin',
 #   LOCAL_RULES_DIR   => '/etc/mail/spamassassin',
 #see man Mail::SpamAssassin for other options
