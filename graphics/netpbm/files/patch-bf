--- pnm/Makefile.orig	Sat May  6 19:03:54 2000
+++ pnm/Makefile	Mon May  8 00:00:00 2000
@@ -3,7 +3,7 @@
 
 LIBROOT = pnm
 LIBPNM = lib$(LIBROOT).$(NETPBMLIBSUFFIX)
-MAJ = 9
+MAJ = 1
 MIN = 0
 
 PPMDIR = $(SRCDIR)/ppm
@@ -36,6 +36,8 @@
 # The order of these libraries is important for static library build
 NETPBMLIBS = $(LIBPNM) \
            $(PPMDIR)/$(LIBPPM) $(PGMDIR)/$(LIBPGM) $(PBMDIR)/$(LIBPBM) 
+NETPBMLD = -L. -lpnm \
+           -L$(PPMDIR) -lppm -L$(PGMDIR) -lpgm -L$(PBMDIR) -lpbm
 LIBLIBS =  $(PPMDIR)/$(LIBPPM) $(PGMDIR)/$(LIBPGM) $(PBMDIR)/$(LIBPBM) 
 
 ifeq ($(JPEGLIB_DIR),NONE)
@@ -102,6 +104,8 @@
 MERGE_OBJECTS = $(patsubst %,%.o2, $(PORTBINARIES) $(MATHBINARIES))
 
 LIBOBJECTS = libpnm1.o libpnm2.o libpnm3.o libpnm4.o
+LIBSOBJECTS = libpnm1.so libpnm2.so libpnm3.so libpnm4.so
+LIBOBJECTS_X = $(SRCDIR)/shhopt/libshhopt.a
 
 MANUALS1 = $(BINARIES) $(SCRIPTS)
 MANUALS3 = libpnm
@@ -126,27 +130,28 @@
 
 # The Tiff library references math functions.
 tifftopnm pnmtotiff pnmtotiffcmyk: %: %.o \
-  $(NETPBMLIBS) $(TIFFLIB_DIR)/libtiff.$(LIBTIFFSUFFIX)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) -lm -L$(TIFFLIB_DIR) -ltiff \
-	  $(JPEGLD) $(CDEBUG)
+  $(NETPBMLIBS) $(TIFFLIB_DIR)/libtiff.$(LIBTIFFSUFFIX) $(LIBOBJECTS_X)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) -lm -L$(TIFFLIB_DIR) -ltiff \
+	  $(LIBOBJECTS_X) $(JPEGLD) $(CDEBUG)
 
 # Rules for plain programs.
 $(PORTBINARIES): %: %.o $(NETPBMLIBS) 
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) $(CDEBUG)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) $(CDEBUG)
 
 # Rule for math-dependent programs.
 $(MATHBINARIES): %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o -lm $(NETPBMLIBS) $(CDEBUG)
+	$(LD) $(LDFLAGS) -o $@ $@.o -lm $(NETPBMLD) $(CDEBUG)
 
 pngtopnm pnmtopng: %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) \
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) \
 	  -L$(PNGLIB_DIR) -lpng -lz -lm $(CDEBUG)
 
-jpegtopnm: %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) $(JPEGLD)  $(CDEBUG)
+jpegtopnm: %: %.o $(NETPBMLIBS) $(LIBOBJECTS_X)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) \
+	  $(LIBOBJECTS_X) $(JPEGLD) $(CDEBUG)
 
 rletopnm pnmtorle: %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) \
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) \
 	  -L$(URTLIB_DIR) -lrle $(CDEBUG)
 
 # And libraries.
@@ -173,6 +178,9 @@
 
 .PHONY: install.lib
 install.lib: install.lib.common
+
+$(SRCDIR)/shhopt/libshhopt.a:
+	cd ../shhopt; $(MAKE) libshhopt.a
 
 .PHONY: clean
 clean:
