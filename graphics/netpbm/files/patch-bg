--- ppm/Makefile.orig	Sat May  6 12:57:43 2000
+++ ppm/Makefile	Mon May  8 00:00:00 2000
@@ -3,7 +3,7 @@
 
 LIBROOT = ppm
 LIBPPM = lib$(LIBROOT).$(NETPBMLIBSUFFIX)
-MAJ = 9
+MAJ = 1
 MIN = 1
 
 PGMDIR = $(SRCDIR)/pgm
@@ -19,12 +19,13 @@
 endif
 
 NETPBMLIBS = $(LIBPPM) $(PBMDIR)/$(LIBPBM) $(PGMDIR)/$(LIBPGM)
+NETPBMLD = -L. -lppm -L$(PBMDIR) -lpbm -L$(PGMDIR) -lpgm
 LIBLIBS = $(PBMDIR)/$(LIBPBM) $(PGMDIR)/$(LIBPGM)
 
 PORTBINARIES =	bmptoppm eyuvtoppm gouldtoppm hpcdtoppm ilbmtoppm imgtoppm \
 		mtvtoppm pcxtoppm pgmtoppm pi1toppm picttoppm \
 		pjtoppm \
-		ppm3d ppmbrighten ppmchange ppmcolormask \
+		ppm3d ppmbrighten ppmchange \
 		ppmdim ppmdist ppmdither \
 		ppmflash ppmhist ppmmake ppmmix ppmnorm \
 		ppmquant ppmrelief ppmshift ppmspread ppmtoacad \
@@ -34,19 +35,20 @@
 		ppmtotga ppmtouil ppmtoxpm ppmtoyuv \
 		ppmtoyuvsplit ppmtv \
 		qrttoppm rawtoppm rgb3toppm sldtoppm spctoppm \
-		sputoppm tgatoppm ximtoppm xpmtoppm xvminitoppm \
+		sputoppm xpmtoppm xvminitoppm \
 		yuvtoppm yuvsplittoppm
 
 # We don't build vidtoppm by default, because it requires special libraries
 # and there is no known requirement for vidtoppm.
 
+NOMERGEBINARIES = ppmcolormask ppmntsc tgatoppm ximtoppm
 ifneq ($(JPEGLIB_DIR), NONE)
   ifneq ($(JPEGHDR_DIR), NONE)
       NOMERGEBINARIES += ppmtojpeg
   endif
 endif
 
-MATHBINARIES = ppmcie ppmforge ppmlabel ppmntsc ppmpat ppmqvga ppmtomap
+MATHBINARIES = ppmcie ppmforge ppmlabel ppmpat ppmqvga ppmtomap
 BINARIES = $(PORTBINARIES) $(NOMERGEBINARIES) $(MATHBINARIES)
 SCRIPTS = ppmquantall ppmshadow ppmfade
 
@@ -55,6 +57,8 @@
 MERGE_OBJECTS = $(patsubst %,%.o2, $(PORTBINARIES) $(MATHBINARIES))
 
 LIBOBJECTS = libppm1.o libppm2.o libppm3.o libppm4.o libppm5.o bitio.o
+LIBSOBJECTS = libppm1.so libppm2.so libppm3.so libppm4.so libppm5.so bitio.so
+LIBOBJECTS_X = $(SRCDIR)/shhopt/libshhopt.a
 
 MANUALS1 = $(BINARIES) $(SCRIPTS)
 MANUALS3 = libppm
@@ -62,7 +66,7 @@
 
 MERGENAME= ppmmerge
 
-INTERFACE_HEADERS = ppm.h
+INTERFACE_HEADERS = ppm.h ppmcmap.h ppmdraw.h
 
 .PHONY: all
 all:        $(BINARIES)
@@ -72,16 +76,23 @@
 
 # Rules for plain programs.
 $(PORTBINARIES): %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) \
-	  $(CDEBUG)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) $(CDEBUG)
 
 # Rule for math-dependent programs.
 $(MATHBINARIES): %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o -lm $(NETPBMLIBS) $(CDEBUG)
+	$(LD) $(LDFLAGS) -o $@ $@.o -lm $(NETPBMLD) $(CDEBUG)
+
+ppmcolormask tgatoppm ximtoppm: %: %.o $(NETPBMLIBS) $(LIBOBJECTS_X)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) \
+	  $(LIBOBJECTS_X) $(CDEBUG)
+
+ppmntsc: %: %.o $(NETPBMLIBS) $(LIBOBJECTS_X)
+	$(LD) $(LDFLAGS) -o $@ $@.o -lm $(NETPBMLD) \
+	  $(LIBOBJECTS_X) $(CDEBUG)
 
 ppmtojpeg: %: %.o $(NETPBMLIBS)
-	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLIBS) \
-	  -L$(JPEGLIB_DIR) -ljpeg $(CDEBUG)
+	$(LD) $(LDFLAGS) -o $@ $@.o $(NETPBMLD) \
+	  $(LIBOBJECTS_X) -L$(JPEGLIB_DIR) -ljpeg $(CDEBUG)
 
 # And libraries.
 $(PBMDIR)/$(LIBPBM): FORCE
@@ -96,6 +107,9 @@
 install.lib: install.lib.common
 
 include $(SRCDIR)/Makefile.common
+
+$(SRCDIR)/shhopt/libshhopt.a:
+	cd ../shhopt; $(MAKE) libshhopt.a
 
 .PHONY: clean
 clean:
