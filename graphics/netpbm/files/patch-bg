--- ppm/Makefile.orig	Fri Jun  2 01:22:16 2000
+++ ppm/Makefile	Sat Jun  3 00:00:00 2000
@@ -3,8 +3,7 @@
 
 LIBROOT = ppm
 LIBPPM = lib$(LIBROOT).$(NETPBMLIBSUFFIX)
-MAJ = 9
-MIN = 3
+SOVER = 1
 
 PGMDIR = $(SRCDIR)/pgm
 LIBPGM = libpgm.$(NETPBMLIBSUFFIX)
@@ -24,7 +23,7 @@
 PORTBINARIES =	bmptoppm eyuvtoppm gouldtoppm hpcdtoppm ilbmtoppm imgtoppm \
 		leaftoppm mtvtoppm pcxtoppm pgmtoppm pi1toppm picttoppm \
 		pjtoppm \
-		ppm3d ppmbrighten ppmchange ppmcolormask \
+		ppm3d ppmbrighten ppmchange \
 		ppmdim ppmdist ppmdither \
 		ppmflash ppmhist ppmmake ppmmix ppmnorm \
 		ppmquant ppmrelief ppmshift ppmspread ppmtoacad \
@@ -35,12 +34,13 @@
 		ppmtotga ppmtouil ppmtowinicon ppmtoxpm ppmtoyuv \
 		ppmtoyuvsplit ppmtv \
 		qrttoppm rawtoppm rgb3toppm sldtoppm spctoppm \
-		sputoppm tgatoppm winicontoppm ximtoppm xpmtoppm xvminitoppm \
+		sputoppm winicontoppm xpmtoppm xvminitoppm \
 		yuvtoppm yuvsplittoppm
 
 # We don't build vidtoppm by default, because it requires special libraries
 # and there is no known requirement for vidtoppm.
 
+NOMERGEBINARIES = ppmcolormask ppmntsc tgatoppm ximtoppm
 ifneq ($(JPEGLIB_DIR), NONE)
   ifneq ($(JPEGHDR_DIR), NONE)
       NOMERGEBINARIES += ppmtojpeg
@@ -49,7 +49,7 @@
 
 MERGEBINARIES = $(PORTBINARIES) $(MATHBINARIES)
 
-MATHBINARIES = ppmcie ppmforge ppmlabel ppmntsc ppmpat ppmqvga ppmtomap
+MATHBINARIES = ppmcie ppmforge ppmlabel ppmpat ppmqvga ppmtomap
 BINARIES = $(MERGEBINARIES) $(NOMERGEBINARIES) 
 SCRIPTS = ppmquantall ppmshadow ppmfade
 
@@ -58,6 +58,8 @@
 MERGE_OBJECTS = $(patsubst %,%.o2, $(MERGEBINARIES))
 
 LIBOBJECTS = libppm1.o libppm2.o libppm3.o libppm4.o libppm5.o bitio.o
+LIBSOBJECTS = $(patsubst %.o, %.so, $(LIBOBJECTS))
+LIBSHHOPT = $(SRCDIR)/shhopt/libshhopt.a
 
 MANUALS1 = $(BINARIES) $(SCRIPTS)
 MANUALS3 = libppm
@@ -65,18 +67,24 @@
 
 MERGENAME= ppmmerge
 
-INTERFACE_HEADERS = ppm.h ppmcmap.h
+INTERFACE_HEADERS = ppm.h ppmcmap.h ppmdraw.h
 
 .PHONY: all
 all:        $(BINARIES)
-	$(MAKE) -C ppmtompeg all
 .PHONY: merge
 merge:      $(MERGENAME) $(NOMERGEBINARIES)
-	$(MAKE) -C ppmtompeg all
 
-ppmtojpeg: %: %.o $(NETPBMLIBS) $(LIBOPT)
+ppmcolormask tgatoppm ximtoppm: %: %.o $(NETPBMLIBS) $(LIBOPT) $(LIBSHHOPT)
 	$(LD) $(LDFLAGS) -o $@ $@.o `$(LIBOPT) $(NETPBMLIBS)` \
-	  -L$(JPEGLIB_DIR) -ljpeg $(CDEBUG)
+	  $(LIBSHHOPT) $(CDEBUG)
+
+ppmntsc: %: %.o $(NETPBMLIBS) $(LIBOPT) $(LIBSHHOPT)
+	$(LD) $(LDFLAGS) -o $@ $@.o `$(LIBOPT) $(NETPBMLIBS)` \
+	  -lm $(LIBSHHOPT) $(CDEBUG)
+
+ppmtojpeg: %: %.o $(NETPBMLIBS) $(LIBOPT) $(LIBSHHOPT)
+	$(LD) $(LDFLAGS) -o $@ $@.o `$(LIBOPT) $(NETPBMLIBS)` \
+	  -L$(JPEGLIB_DIR) -ljpeg $(LIBSHHOPT) $(CDEBUG)
 
 # And libraries.
 $(PBMDIR)/$(LIBPBM): FORCE
@@ -89,19 +97,19 @@
 
 .PHONY: install.merge
 install.merge: install.merge.common
-	$(MAKE) -C ppmtompeg install.bin
 
 .PHONY: install.lib
 install.lib: install.lib.common
 
 .PHONY: install.man
 install.man: install.man.common
-	$(MAKE) -C ppmtompeg install.man
 
 include $(SRCDIR)/Makefile.common
 
+$(SRCDIR)/shhopt/libshhopt.a:
+	cd ../shhopt; $(MAKE) libshhopt.a
+
 .PHONY: clean
 clean: clean.common
-	$(MAKE) -C ppmtompeg clean
 
 FORCE:
